<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1D Fluid Dynamics Analogue Simulator v42</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for plotting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- MathJax Configuration (IMPORTANT for inline LaTeX) -->
    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']] // Configure $ for inline math
          },
          svg: {
            fontCache: 'global' // Optimize font loading
          },
          options: {
            // Explicitly tell MathJax to skip script tags to prevent parsing JavaScript as LaTeX
            skipHtmlTags: ['script', 'noscript', 'textarea', 'pre', 'code', 'annotation', 'annotation-xml'],
            ignoreHtmlClass: 'no-mathjax' // Also ignore elements with this class
          }
        };
    </script>
    <!-- MathJax CDN for LaTeX rendering -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* Custom styles for better slider appearance */
        input[type='range']::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4F46E5; /* Indigo-600 */
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3); /* Indigo-600 with opacity */
            margin-top: -6px; /* Adjust to center thumb on track */
        }
        input[type='range']::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4F46E5;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3);
        }

        /* Dynamic gradient for the slider track */
        input[type='range'] {
            -webkit-appearance: none; /* Override default browser styles */
            appearance: none;
            width: 100%;
            height: 4px; /* Height of the track */
            border-radius: 2px;
            outline: none; /* Remove focus outline */
            background: linear-gradient(to right,
                hsl(120, 60%, 85%) 0%,    /* Light Pastel Green */
                hsl(210, 70%, 75%) 33%,   /* Pastel Blue */
                hsl(270, 80%, 65%) 66%,   /* Pastel Purple */
                hsl(0, 90%, 55%) 100%     /* Pastel Red */
            );
            background-size: var(--slider-value-percent, 0%) 100%; /* Controls the fill amount */
            background-repeat: no-repeat;
            background-color: #E0E7FF; /* Color for the unfilled part of the track */
            transition: background-size 0.1s ease-out; /* Smooth transition for the gradient fill */
        }

        /* Ensure the actual track part is transparent so the input's background shows */
        input[type='range']::-webkit-slider-runnable-track {
            background: transparent;
        }
        input[type='range']::-moz-range-track {
            background: transparent;
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; /* Make space for the icon */
        }

        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            backdrop-filter: blur(5px); /* Blur background */
            -webkit-backdrop-filter: blur(5px); /* Safari support */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto; /* Center vertically and horizontally */
            padding: 20px;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            position: relative;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Spinner for activity indicator */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Pulsing color animation for text/icon */
        @keyframes pulseColor {
            0% { color: white; }
            50% { color: #FECACA; } /* Tailwind red-200 */
            100% { color: white; }
        }

        .pulsing-text {
            animation: pulseColor 1s ease-in-out infinite;
        }

        /* Activity Indicator Positioning */
        #simulationActivityIndicator {
            display: none; /* Hidden by default */
            position: absolute;
            top: 1.5rem; /* Adjust as needed to align with title */
            right: 1.5rem; /* Adjust as needed */
            z-index: 10;
            display: flex; /* Use flexbox for alignment of spinner and percentage */
            align-items: center;
            gap: 0.5rem; /* Space between spinner and percentage */
        }

        /* Adjusted progress bar to end before spinner */
        #progressBar {
            position: absolute; /* Needs to be absolute to control its right edge */
            left: 0;
            top: 0;
            height: 100%; /* Fill the parent container */
            border-radius: 9999px; /* Tailwind rounded-full */
            background-color: #4F46E5; /* Indigo-600 */
            transition: width 0.1s ease-out;
        }
        .progress-bar-container {
            position: relative; /* Make this the positioning context for the absolute progress bar */
            width: 100%;
            height: 0.625rem; /* h-2.5 */
            background-color: #E0E7FF; /* bg-gray-200 */
            border-radius: 9999px; /* rounded-full */
            margin-bottom: 1.5rem; /* mb-6 */
            overflow: hidden; /* Hide overflow of the inner bar */
        }

        /* Styling for the blue and red slashes */
        .slash-blue {
            color: #3B82F6; /* blue-500 */
        }
        .slash-red {
            color: #EF4444; /* red-500 */
        }
        .text-green-600-custom {
            color: #16A34A; /* This is Tailwind's green-600 */
        }
        .text-red-600-custom {
            color: #DC2626; /* This is Tailwind's red-600 */
        }
        .spinner.spinner-completed {
            animation: none; /* Stop the spin animation */
            border-top-color: #10B981 !important; /* Ensure all borders are green-600 */
            border-left-color: #10B981 !important;
            border-right-color: #10B981 !important;
            border-bottom-color: #10B981 !important;
        }

        /* Dynamic Tooltip styles */
        #dynamicTooltip {
            position: absolute;
            background-color: rgba(31, 41, 55, 0.95); /* Gray-800 with opacity */
            color: white;
            padding: 0.5rem 0.75rem; /* p-2 px-3 */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.75rem; /* text-xs */
            line-height: 1rem; /* leading-tight */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            white-space: normal; /* Allow text to wrap */
            max-width: 250px; /* Limit tooltip width */
            z-index: 2000; /* Ensure it's above everything else */
            pointer-events: none; /* Do not block mouse events on elements below */
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            top: -9999px;
            left: -9999px;
        }
        #dynamicTooltip.show {
            opacity: 1;
        }
        
        /* Style for disabled playback controls */
        .playback-disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .parameter-disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Tab styles */
        .tab-button.active-tab {
            color: #4f46e5; /* indigo-600 */
            border-bottom-width: 2px;
            border-color: #4f46e5; /* indigo-600 */
        }
        .tab-button.inactive-tab {
            color: #6b7280; /* gray-500 */
            border-bottom-width: 2px;
            border-color: transparent;
        }
        .tab-button.inactive-tab:hover {
            color: #374151; /* gray-700 */
            border-color: #d1d5db; /* gray-300 */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .tooltip-grid { display: grid; grid-template-columns: auto 1fr; gap: 0.25rem 0.75rem; align-items: center; }
        .tooltip-grid-label { font-weight: 600; text-align: right; }

        #stabilityWarning {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(220, 38, 38, 0.85); /* red-600 with opacity */
            color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            z-index: 10;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        /* For the new summary section */
        #finalStateSummary.hidden {
            display: none;
        }
        #aiAnalysisResult {
            background-color: #f9fafb; /* gray-50 */
            border-radius: 0.5rem;
        }
        #aiAnalysisResult strong {
            color: #4338ca; /* indigo-700 */
        }

        /* Export PNG Button Styles */
        .export-png-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            z-index: 10;
            background-color: rgba(243, 244, 246, 0.8); /* bg-gray-100 with opacity */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 9999px; /* rounded-full */
            padding: 0.375rem; /* p-1.5 */
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            color: #4b5563; /* text-gray-600 */
        }
        .export-png-button:hover {
            background-color: white;
            color: #1f2937; /* text-gray-800 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow-sm */
        }
        .export-png-button:disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-gray-50 font-sans antialiased text-gray-800 p-4 sm:p-6">

    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-4">
            <h1 class="font-bold tracking-widest text-gray-600" style="font-size: 10pt;"><span style="color: #FF0000;">Q</span> <span style="color: #0000FF;">U</span> A N T U M &nbsp; Q &nbsp; | &nbsp; R E S E A R C H &nbsp;&nbsp; &amp; &nbsp;&nbsp; D E V E L O P M E N T &nbsp;&nbsp; D I V I S I O N &nbsp; | &nbsp; 2 0 2 5 &copy;</h1>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white shadow-lg rounded-xl p-6 sm:p-8 border border-gray-200" id="mainContentArea">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-indigo-700 mb-2">1D Fluid Dynamics Analogue Simulator</h1>
        <p class="text-center text-sm text-red-600 font-semibold mb-8">
            (A 1D Reaction-Diffusion PDE model for conceptual exploration)
        </p>

        <!-- IMPORTANT DISCLAIMER FOR RESEARCH CONTEXT -->
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-8 text-left" role="alert">
            <strong class="font-bold">CRITICAL NOTE FOR RESEARCHERS:</strong>
            <span class="block mt-1">This tool simulates a <strong>1D Reaction-Diffusion Partial Differential Equation (PDE)</strong> using a 4th-Order Runge-Kutta numerical scheme. While it demonstrates phenomena analogous to those in fluid dynamics—such as diffusion (viscosity-like effects) and non-linear interactions—it is <strong>fundamentally not a model of the 3D Navier-Stokes equations</strong>.</span>
            <span class="block mt-2">The results from this simulator <strong>cannot</strong> be used to draw direct conclusions about 3D fluid flow or address the Navier-Stokes existence and smoothness conjecture. Its purpose is for the conceptual exploration of 1D pattern formation, wave propagation, and the interplay between diffusion and reaction terms.</span>
            <span class="block mt-4"><strong class="font-bold">BETA SOFTWARE NOTICE:</strong> This application is under active development. While we strive for numerical accuracy for the implemented PDE, bugs or unexpected behaviors may be present. Your use of this tool acknowledges its experimental status.</span>
        </div>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Left Panel: Parameters and Controls -->
            <div class="lg:w-2/5 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-md" id="parameterSection">
                <h2 class="text-2xl font-bold text-gray-700 mb-6">Simulation Parameters</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-4 mb-8">
                    <!-- System Length -->
                    <div id="paramGroupL">
                        <label for="paramL" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>System Length (L)</p><p class='text-xs mb-2 text-gray-300'>The total spatial extent of the 1D domain for the simulation.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$x \in [0, L]$</p></div>">System Length (L):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramL" min="1" max="50" step="1" value="10" class="w-full">
                            <input type="number" id="inputL" min="1" max="50" step="1" value="10.0" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Grid Points -->
                    <div id="paramGroupN">
                        <label for="paramN" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Grid Points (N)</p><p class='text-xs mb-2 text-gray-300'>The number of discrete points used to represent the spatial domain. Higher N provides higher spatial resolution.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$\Delta x = L / (N-1)$</p></div>">Grid Points (N):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramN" min="32" max="1024" step="32" value="256" class="w-full">
                            <input type="number" id="inputN" min="32" max="1024" step="32" value="256" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Total Time -->
                    <div id="paramGroupT">
                        <label for="paramT" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Total Time (T)</p><p class='text-xs mb-2 text-gray-300'>The total duration for which the simulation will run.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$t \in [0, T]$</p></div>">Total Time (T):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramT" min="0.1" max="50" step="0.5" value="5" class="w-full">
                            <input type="number" id="inputT" min="0.1" max="50" step="0.5" value="5.0" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Diffusion Coefficient -->
                    <div id="paramGroupAlpha">
                        <label for="paramAlpha" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Diffusion Coefficient ($\nu_{eff}$)</p><p class='text-xs mb-2 text-gray-300'>Controls how quickly $u$ spreads out. Higher $\nu_{eff}$ leads to faster smoothing. Analogous to viscosity.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>Term: $\nu_{eff} \frac{\partial^2 u}{\partial x^2}$</p></div>">Diff. Coefficient ($\nu_{eff}$):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramAlpha" min="0.01" max="1" step="0.01" value="0.1" class="w-full">
                            <input type="number" id="inputAlpha" min="0.01" max="1" step="0.01" value="0.10" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Non-linear Growth -->
                    <div id="paramGroupBeta">
                        <label for="paramBeta" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Non-linear Growth ($\beta_{NL}$)</p><p class='text-xs mb-2 text-gray-300'>Influences local growth of $u$. The logistic term $u(1-u)$ limits growth as $u$ approaches 1.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>Term: $\beta_{NL} u(1-u)$</p></div>">Non-linear Growth ($\beta_{NL}$):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramBeta" min="0" max="2" step="0.05" value="0.5" class="w-full">
                            <input type="number" id="inputBeta" min="0" max="2" step="0.05" value="0.50" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Cubic Damping -->
                    <div id="paramGroupGamma">
                        <label for="paramGamma" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Cubic Damping ($\gamma_{diss}$)</p><p class='text-xs mb-2 text-gray-300'>Represents dissipation that limits growth, especially at high values, often leading to stabilization.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>Term: $-\gamma_{diss} u^3$</p></div>">Cubic Damping ($\gamma_{diss}$):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramGamma" min="0" max="1" step="0.01" value="0.2" class="w-full">
                            <input type="number" id="inputGamma" min="0" max="1" step="0.01" value="0.20" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Initial Condition -->
                    <div class="col-span-full" id="paramGroupInit">
                        <label for="paramInit" class="text-sm font-medium text-gray-600 mb-1 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Initial Condition</p><p class='text-xs mb-2 text-gray-300'>The starting profile of the field $u$ at the beginning of the simulation.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$u(x, t=0) = u_0(x)$</p></div>">Initial Condition:</label>
                        <select id="paramInit" class="bg-white block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base h-10">
                            <option value="gaussian">Gaussian</option>
                            <option value="step">Step</option>
                            <option value="random">Random</option>
                            <option value="sine">Sine</option>
                            <option value="custom">Custom Formula</option>
                        </select>
                        <div id="customIcContainer" class="hidden mt-2">
                             <input type="text" id="customIcFormula" class="bg-white block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm font-mono" placeholder="e.g., 0.5 * Math.sin(2 * Math.PI * x / L)">
                        </div>
                    </div>
                    <!-- Boundary Condition -->
                    <div class="col-span-full" id="paramGroupBoundary">
                        <label for="paramBoundary" class="text-sm font-medium text-gray-600 mb-1 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Boundary Condition</p><p class='text-xs mb-2 text-gray-300'>Determines how the edges of the domain behave. 'Periodic' wraps around, while 'Dirichlet' fixes the edges (zero-flux).</p></div>">Boundary Condition:</label>
                        <select id="paramBoundary" class="bg-white block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base h-10">
                            <option value="periodic">Periodic</option>
                            <option value="dirichlet">Dirichlet (Zero-Flux)</option>
                        </select>
                    </div>

                    <!-- Time Step (dt) -->
                    <div class="col-span-full mt-4" id="paramGroupDt">
                        <label for="paramDt" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Time Step (dt)</p><p class='text-xs mb-2 text-gray-300'>The size of each time step. Smaller values increase accuracy and stability but take longer to compute. This is a logarithmic slider.</p></div>">Time Step (dt):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramDt" min="-5" max="-1" step="0.01" value="-2" class="w-full">
                            <input type="text" id="inputDt" value="1.00e-2" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 6rem;">
                            <span id="stabilityIndicator" class="text-xs font-semibold px-2 py-1 rounded-full w-28 text-center" title="Stability indicator based on the CFL condition for diffusion."></span>
                        </div>
                    </div>

                    <!-- Enable Tooltips Checkbox -->
                    <div class="col-span-full flex items-center mt-4">
                        <input type="checkbox" id="enableTooltips" class="form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out rounded-md cursor-pointer">
                        <label for="enableTooltips" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Enable Tooltips</p><p class='text-xs text-gray-300'>Toggle dashboard-wide tooltips for mathematical equations and important labels. Chart hover effects are always active.</p></div>">Enable Equation Tooltips</label>
                    </div>
                </div>

                <!-- Simulation Presets -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Simulation Presets:</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="presetDiffusion" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Preset: Pure Diffusion</p><p class='text-xs text-gray-300'>Demonstrates pure diffusion, where the initial profile smooths out over time due to the viscosity-like term. Only the $\nu_{eff}$ term is active.</p></div>">
                            Pure Diffusion
                        </button>
                        <button id="presetGrowthDecay" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Preset: Growth & Decay</p><p class='text-xs text-gray-300'>Highlights non-linear growth and damping terms, showing how values can grow and then stabilize or decay. The $\nu_{eff}$ term is minimized.</p></div>">
                            Growth & Decay
                        </button>
                        <button id="presetWave" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Preset: Propagating Wave</p><p class='text-xs text-gray-300'>Visualizes a traveling wave front, where a step-like initial condition propagates across the domain due to a balance of terms.</p></div>">
                            Propagating Wave
                        </button>
                        <button id="presetPattern" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Preset: Pattern Formation</p><p class='text-xs text-gray-300'>Shows how complex, stable spatial patterns can emerge from a random initial state due to the interplay of all terms.</p></div>">
                            Pattern Formation
                        </button>
                         <button id="presetChaos" class="px-4 py-2 bg-gray-800 text-white font-semibold rounded-lg shadow-md hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Preset: Turbulent-like Chaos</p><p class='text-xs text-gray-300'>Creates a complex, unpredictable state with a broad energy spectrum, analogous to turbulent flow. Set with high growth and low diffusion.</p></div>">
                            Turbulent-like Chaos
                        </button>
                        <button id="presetShock" class="px-4 py-2 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Preset: Shockwave Analogue</p><p class='text-xs text-gray-300'>Forms a sharp, propagating front from a step condition, demonstrating a 1D analogue of shockwave formation.</p></div>">
                            Shockwave Analogue
                        </button>
                        <button id="presetSmoothDecay" class="px-4 py-2 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Smooth Decay</p><p class='text-xs text-gray-300'>Demonstrates a globally regular solution. A complex initial state is rapidly smoothed by high diffusion, decaying to zero. This is an analogue for a well-behaved Navier-Stokes solution.</p></div>">
                            Smooth Decay
                        </button>
                        <button id="presetWaveBreaking" class="px-4 py-2 bg-rose-600 text-white font-semibold rounded-lg shadow-md hover:bg-rose-700 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Wave Steepening</p><p class='text-xs text-gray-300'>A smooth sine wave steepens into a shock front due to non-linear effects dominating over low diffusion, forming a near-vertical gradient.</p></div>">
                            Wave Steepening
                        </button>
                        <button id="presetIntermittency" class="px-4 py-2 bg-slate-600 text-white font-semibold rounded-lg shadow-md hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Intermittency</p><p class='text-xs text-gray-300'>Models turbulent 'puffs' - isolated, sharp, chaotic bursts of activity within a mostly calm background. A key feature of real fluid turbulence.</p></div>">
                            Intermittency
                        </button>
                        <button id="presetBlowup" class="px-4 py-2 bg-amber-500 text-white font-semibold rounded-lg shadow-md hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>FINITE-TIME BLOW-UP</p><p class='text-xs text-gray-300'>An educational preset with an intentionally unstable time-step (dt). It demonstrates how non-linear growth can overwhelm diffusion, causing the solution to 'blow up' to infinity. This illustrates the core question of the Navier-Stokes conjecture.</p></div>">
                            Singularity Analogue
                        </button>
                    </div>
                </div>

                <!-- AI Parameter Assistant -->
                <div class="mt-8 border-t border-gray-300 pt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                        ✨ AI Parameter Assistant
                        <span class="ml-2 text-xs font-bold bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">NEW</span>
                    </h3>
                    <p class="text-xs text-gray-500 mb-3">Describe your desired simulation outcome, and the AI will suggest parameter changes.</p>
                    <div class="flex flex-col gap-2">
                        <textarea id="aiGoalInput" class="bg-white block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" rows="3" placeholder="e.g., 'create stable, repeating patterns' or 'make the wave front as steep as possible'"></textarea>
                        <button id="btnGetAiSuggestions" class="w-full px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 flex items-center justify-center" disabled title="Get AI Suggestions (Requires API Key)">
                            Get Suggestions
                        </button>
                    </div>
                    <div id="aiSuggestionsContainer" class="mt-4 p-3 bg-white border border-gray-200 rounded-md shadow-inner hidden">
                        <!-- AI suggestions will be populated here -->
                    </div>
                </div>

                <!-- Simulation Controls -->
                <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-3">Simulation Controls:</h3>
                <div class="flex flex-col sm:flex-row justify-around gap-4 mb-4">
                    <button id="btnRun" class="flex-1 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" title="Start Simulation">
                        <span id="btnRunContent" class="flex items-center justify-center">
                            <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.82V9.18a1 1 0 011.555-.832l3.197 2.132a1 1 0 010 1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Simulation
                        </span>
                    </button>
                    <button id="btnPauseResume" class="flex-1 px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition ease-in-out duration-150 opacity-50 cursor-not-allowed h-10" disabled title="Pause Simulation">
                        <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Pause
                    </button>
                </div>
                <div class="flex flex-col sm:flex-row justify-around gap-4">
                    <button id="btnRefresh" class="flex-1 px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" title="Refresh Dashboard">
                        <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004 12c0 2.21.817 4.231 2.105 5.786M20 20v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Refresh
                    </button>
                    <button id="btnExport" class="flex-1 px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition ease-in-out duration-150 opacity-50 cursor-not-allowed h-10" disabled title="Export Data">
                        <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        Export Data
                    </button>
                </div>
                 <!-- Save/Load State -->
                <div class="flex flex-col sm:flex-row justify-around gap-4 mt-4">
                    <button id="btnSaveState" class="flex-1 px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10" title="Save current parameters and results to a file">
                        <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Save State
                    </button>
                    <button id="btnLoadState" class="flex-1 px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10" title="Load parameters and results from a file">
                        <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        Load State
                    </button>
                    <input type="file" id="loadStateInput" class="hidden" accept=".json">
                </div>
                <!-- Simulation Speed -->
                <div class="mt-4">
                    <label for="simulationSpeed" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Simulation Speed</p><p class='text-xs mb-2 text-gray-300'>Controls the animation speed by adding a delay between updates. Does not affect numerical results.</p></div>">Simulation Speed:</label>
                    <div class="flex items-center gap-x-3 mt-1">
                        <span class="text-xs">Slow</span>
                        <input type="range" id="simulationSpeed" min="0" max="200" step="5" value="200" class="w-full">
                        <span class="text-xs">Fast</span>
                    </div>
                </div>
                <div class="flex justify-around gap-4 mt-4">
                    <button id="btnHelp" class="w-full px-4 py-2 bg-slate-600 text-white font-semibold rounded-lg shadow-md hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 flex items-center justify-center cursor-pointer" title="How to Interpret the Dashboard">
                        How to Interpret this Dashboard
                    </button>
                </div>
            </div>

            <!-- Right Panel: Live Visualization -->
            <div class="lg:w-3/5 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-md relative">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">Live Simulation <span id="liveSimSubtitle" class="ml-2 text-base font-semibold"></span></h2>
                    <div id="simulationActivityIndicator" class="hidden">
                        <span id="percentageCounter" class="text-sm font-semibold text-gray-700">0%</span>
                        <span class="spinner w-8 h-8 !border-t-green-500 !border-gray-300"></span>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div id="progressBar" class="bg-indigo-600 h-full rounded-full transition-all duration-100 ease-out" style="width: 0%;"></div>
                </div>

                <div id="livePlotContainer" class="relative bg-white rounded-lg p-4 shadow-inner border border-gray-300">
                    <canvas id="livePlotCanvas" class="w-full h-80 sm:h-96 cursor-crosshair"></canvas>
                    <button id="exportLivePlot" class="export-png-button" disabled title="Export as PNG">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    </button>
                    <div id="stabilityWarning">
                        <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <p class="font-bold text-lg">Numerical Instability Detected</p>
                        <p class="text-sm mt-1">The simulation has been stopped. Try reducing the <strong>Time Step (dt)</strong> or adjusting other parameters to ensure stability (check the CFL indicator).</p>
                    </div>
                </div>

                <!-- Simulation Playback Controls -->
                <div id="playbackControls" class="mt-6 bg-white rounded-lg p-4 shadow-inner border border-gray-300 playback-disabled">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Simulation Playback</h3>
                    <div class="flex items-center gap-2">
                        <input type="range" id="playbackSlider" min="0" max="1" step="any" value="0" class="w-full" disabled>
                        <button id="btnReplay" class="flex-shrink-0 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Play/Pause Replay">
                            <svg id="replayPlayIcon" class="w-4 h-4 text-gray-700" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                            <svg id="replayPauseIcon" class="w-4 h-4 text-gray-700 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 4.75A.75.75 0 015.75 4h2.5A.75.75 0 019 4.75v10.5A.75.75 0 018.25 16h-2.5A.75.75 0 015 15.25V4.75zm6.5.75A.75.75 0 0010.75 4h2.5a.75.75 0 01.75.75v10.5a.75.75 0 01-.75.75h-2.5a.75.75 0 01-.75-.75V5.5z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span id="playbackCurrentTime">Time: 0.00s</span>
                        <span id="playbackTotalTime">Total: 0.00s</span>
                    </div>
                </div>

                <!-- Term Contributions Plot -->
                <div id="termContributionsContainer" class="mt-6 bg-white rounded-lg p-4 shadow-inner border border-gray-300 relative">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Term Contributions</p><p class='text-xs text-gray-300'>Visualizes the individual components of the PDE, showing how diffusion, reaction, and their sum contribute to the total change ($du/dt$) at each point in space.</p></div>">Term Contributions</h3>
                    <div class="relative h-80 sm:h-96">
                         <canvas id="termContributionsChartCanvas"></canvas>
                         <button id="exportTermContributions" class="export-png-button" disabled title="Export as PNG">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                         </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simulation Metrics Section -->
        <div class="mt-8 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-md">
            <h2 class="text-2xl font-bold text-gray-700 mb-6">Simulation Metrics</h2>
            <div id="metricsContent" class="p-4 bg-white rounded-b-lg shadow-inner border border-gray-300">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-4">
                    <div>
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Max Value ($u_{max}$)</p><p class='text-xs mb-2 text-gray-300'>The maximum value of $u(x,t)$ across the spatial domain at the current time step.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$u_{max}(t) = \max_{x \in [0,L]} u(x,t)$</p></div>">Max Value ($u_{max}$):</h3>
                        <p class="text-gray-600">Current: <span id="metricMaxVal_current" class="font-mono">0.0000</span></p>
                        <p class="text-gray-600">Max Overall: <span id="metricMaxVal_max" class="font-mono">0.0000</span></p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Min Value ($u_{min}$)</p><p class='text-xs mb-2 text-gray-300'>The minimum value of $u(x,t)$ across the spatial domain at the current time step.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$u_{min}(t) = \min_{x \in [0,L]} u(x,t)$</p></div>">Min Value ($u_{min}$):</h3>
                        <p class="text-gray-600">Current: <span id="metricMinVal_current" class="font-mono">0.0000</span></p>
                        <p class="text-gray-600">Min Overall: <span id="metricMinVal_min" class="font-mono">0.0000</span></p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Mean Value ($\overline{u}$)</p><p class='text-xs mb-2 text-gray-300'>The spatial average of $u(x,t)$ at the current time step.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$\overline{u}(t) = \frac{1}{L} \int_0^L u(x,t) dx$</p></div>">Mean Value ($\overline{u}$):</h3>
                        <p class="text-gray-600">Current: <span id="metricMeanVal_current" class="font-mono">0.0000</span></p>
                        <p class="text-gray-600">Max Overall: <span id="metricMeanVal_max" class="font-mono">0.0000</span></p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Standard Deviation ($\sigma_u$)</p><p class='text-xs mb-2 text-gray-300'>Measures the spatial variability of $u(x,t)$ around its mean at the current time step.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$\sigma_u(t) = \sqrt{\frac{1}{L} \int_0^L (u(x,t) - \overline{u}(t))^2 dx}$</p></div>">Standard Deviation ($\sigma_u$):</h3>
                        <p class="text-gray-600">Current: <span id="metricStdDev_current" class="font-mono">0.0000</span></p>
                        <p class="text-gray-600">Max Overall: <span id="metricStdDev_max" class="font-mono">0.0000</span></p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Kurtosis ($\kappa_u$)</p><p class='text-xs mb-2 text-gray-300'>Measures the 'tailedness' of the distribution. High kurtosis indicates the presence of sharp, intermittent peaks or extreme values.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$\kappa_u(t) = \frac{\frac{1}{N}\sum_{i=1}^{N}(u_i - \overline{u})^4}{(\sigma_u^2)^2}$</p></div>">Kurtosis ($\kappa_u$):</h3>
                        <p class="text-gray-600">Current: <span id="metricKurtosis_current" class="font-mono">0.000e+0</span></p>
                        <p class="text-gray-600">Max Overall: <span id="metricKurtosis_max" class="font-mono">0.000e+0</span></p>
                    </div>
                    <div>
                         <h3 class="font-semibold text-gray-700">
                            <span class="cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Energy ($\mathcal{E}$)</p><p class='text-xs mb-2 text-gray-300'>Represents the total 'activity' or 'content' in the system, defined by the L2-norm.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$\mathcal{E}(t) = \int_0^L u(x,t)^2 dx$</p></div>">Energy ($\mathcal{E}$):</span>
                        </h3>
                        <p class="text-gray-600">Current: <span id="metricEnergy_current" class="font-mono">0.0000</span></p>
                        <p class="text-gray-600">Max Overall: <span id="metricEnergy_max" class="font-mono">0.0000</span></p>
                    </div>
                </div>
                <h3 class="font-semibold text-gray-700 mb-2">Time Series Plots:</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative">
                        <canvas id="meanValChartCanvas" class="w-full h-64"></canvas>
                        <button id="exportMeanVal" class="export-png-button" disabled title="Export as PNG">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        </button>
                    </div>
                    <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative">
                        <canvas id="energyChartCanvas" class="w-full h-64"></canvas>
                        <button id="exportEnergy" class="export-png-button" disabled title="Export as PNG">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        </button>
                    </div>
                </div>

                <div class="flex flex-col items-center mt-6">
                    <div class="grid grid-cols-2 gap-4 w-full max-w-md">
                        <button id="btnResults" class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" disabled title="Interpret Current Simulation State">
                            <span class="flex items-center justify-center">
                                ✨ Results
                            </span>
                        </button>
                        <button id="btnInterpretKids" class="px-6 py-3 bg-blue-400 text-white font-semibold rounded-lg shadow-md hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" disabled title="Ask Einstein for a simple explanation">
                            <span class="flex items-center justify-center">
                                ✨ Ask Einstein
                            </span>
                        </button>
                        <button id="btnQA" class="px-6 py-3 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" disabled title="Generate Questions & Answers">
                            <span class="flex items-center justify-center">
                                ✨ Q&A
                            </span>
                        </button>
                        <button id="btnConversation" class="px-6 py-3 bg-emerald-500 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:ring-offset-2 transition ease-in-out duration-150 h-10 flex items-center justify-center cursor-pointer" title="Listen to a conversation about Navier-Stokes">
                            Conversation
                        </button>
                        <!-- IMPORTANT: Updated src with the new GitHub Pages audio URL -->
                        <audio id="navierStokesAudio" src="https://quantumq-ai.github.io/QQ_1D_Navier_Stokes_Conjecture_Simulator/NavierStokesConversation.mp3" preload="auto"></audio>
                    </div>
                    <div class="mt-4 w-full max-w-md text-center">
                        <div class="mb-4">
                            <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-1">ENTER YOUR GEMINI API KEY:</label>
                            <div class="flex items-center gap-x-2">
                                <input type="password" id="apiKeyInput" class="flex-grow bg-white block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm font-mono" placeholder="Paste your API key here">
                                <button id="saveApiKeyButton" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10">Save</button>
                            </div>
                            <p id="apiKeyStatus" class="text-xs text-gray-500 mt-1 h-4"></p>
                        </div>
                         <p class="text-xs text-gray-600 mt-2 font-bold">AI FEATURES REQUIRE A VALID GEMINI API KEY.</p>
                         <a href="#" id="getApiKeyLink" class="font-bold text-blue-600 hover:text-blue-800 text-xs no-underline mt-2 inline-block cursor-pointer">HOW TO ACQUIRE A GEMINI KEY</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis Section (replaces old detailed results) -->
        <div class="mt-8 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-md">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Detailed Analysis</h2>

            <!-- NEW: Final State Summary Section -->
            <div id="finalStateSummary" class="mb-6 bg-white p-4 rounded-lg shadow-inner border border-gray-300 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">Final State Summary</h3>
                    <button id="btnAiAnalysis" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 flex items-center justify-center cursor-pointer" disabled title="Generate AI-powered analysis of the final state">
                        <span class="flex items-center justify-center">
                            ✨ Generate AI Analysis
                        </span>
                    </button>
                </div>

                <div id="keyStatisticsGrid" class="grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-4 text-sm mb-4">
                    <div class="flex justify-between border-b pb-1">
                        <span class="font-semibold text-gray-600" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Dominant Wavenumber (k<sub>dom</sub>)</p><p class='text-xs text-gray-300'>The spatial frequency with the most energy, indicating the primary pattern scale.</p></div>">Dominant Wavenumber:</span>
                        <span id="statWavenumber" class="font-mono text-indigo-600">--</span>
                    </div>
                    <div class="flex justify-between border-b pb-1">
                        <span class="font-semibold text-gray-600" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Characteristic Wavelength (λ)</p><p class='text-xs text-gray-300'>The physical size of the dominant pattern, calculated as System Length / k<sub>dom</sub>.</p></div>">Characteristic Wavelength:</span>
                        <span id="statWavelength" class="font-mono text-indigo-600">--</span>
                    </div>
                    <div class="flex justify-between border-b pb-1">
                        <span class="font-semibold text-gray-600" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Spatial Correlation Length (L<sub>corr</sub>)</p><p class='text-xs text-gray-300'>The typical distance over which the field values are correlated. A short length implies a noisy or complex structure.</p></div>">Spatial Correlation Length:</span>
                        <span id="statCorrLength" class="font-mono text-indigo-600">--</span>
                    </div>
                    <div class="flex justify-between border-b pb-1">
                        <span class="font-semibold text-gray-600" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Temporal Correlation Time (τ<sub>corr</sub>)</p><p class='text-xs text-gray-300'>The duration the system 'remembers' its state. A short time is a hallmark of chaotic behavior.</p></div>">Temporal Correlation Time:</span>
                        <span id="statCorrTime" class="font-mono text-indigo-600">--</span>
                    </div>
                    <div class="flex justify-between border-b pb-1">
                        <span class="font-semibold text-gray-600" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Skewness</p><p class='text-xs text-gray-300'>Measures the asymmetry of the value distribution. 0 is symmetric, >0 is right-skewed, <0 is left-skewed.</p></div>">Skewness:</span>
                        <span id="statSkewness" class="font-mono text-indigo-600">--</span>
                    </div>
                    <div class="flex justify-between border-b pb-1">
                        <span class="font-semibold text-gray-600" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Kurtosis</p><p class='text-xs text-gray-300'>Measures the 'tailedness' or 'peakedness'. High kurtosis (>3) indicates intermittent, sharp peaks.</p></div>">Kurtosis:</span>
                        <span id="statKurtosis" class="font-mono text-indigo-600">--</span>
                    </div>
                </div>

                <div id="aiAnalysisResult" class="prose max-w-none text-gray-700 mt-4 p-4 border-t border-gray-200 hidden">
                    <!-- AI result will be populated here -->
                </div>
            </div>
            <!-- END NEW SECTION -->

            <div class="flex border-b border-gray-200">
                <button id="tabDistribution" class="tab-button active-tab px-4 py-2 text-sm font-medium focus:outline-none transition duration-150 ease-in-out cursor-pointer" data-tab="distributionContent">Distribution Analysis</button>
                <button id="tabSpectrum" class="tab-button inactive-tab px-4 py-2 text-sm font-medium focus:outline-none transition duration-150 ease-in-out cursor-pointer" data-tab="spectrumContent">Energy Spectrum Analysis</button>
                <button id="tabPhaseSpace" class="tab-button inactive-tab px-4 py-2 text-sm font-medium focus:outline-none transition duration-150 ease-in-out cursor-pointer" data-tab="phaseSpaceContent">Phase Space Portrait</button>
                <button id="tabTimeSpace" class="tab-button inactive-tab px-4 py-2 text-sm font-medium focus:outline-none transition duration-150 ease-in-out cursor-pointer" data-tab="timeSpaceContent">Time-Space Plot</button>
                <button id="tabCorrelation" class="tab-button inactive-tab px-4 py-2 text-sm font-medium focus:outline-none transition duration-150 ease-in-out cursor-pointer" data-tab="correlationContent">Correlation Analysis</button>
                <button id="tabSampling" class="tab-button inactive-tab px-4 py-2 text-sm font-medium focus:outline-none transition duration-150 ease-in-out cursor-pointer" data-tab="samplingContent">Temporal Sampling</button>
            </div>

            <div id="detailedAnalysisContent" class="p-4 bg-white rounded-b-lg shadow-inner border border-gray-300 min-h-[20rem]">
                <div id="distributionContent" class="tab-content active">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Final State Distribution Plots:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Value Distribution ($u$)</p><p class='text-xs mb-2 text-gray-300'>This histogram shows the distribution of the field value $u$ across all points in the final state.</p></div>">
                            <canvas id="valueDistChartCanvas" class="w-full h-[30rem]"></canvas>
                            <button id="exportValueDist" class="export-png-button" disabled title="Export as PNG">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            </button>
                        </div>
                        <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Gradient Distribution ($\partial u / \partial x$)</p><p class='text-xs mb-2 text-gray-300'>Shows the distribution of the first spatial derivative, indicating the prevalence of steep or flat regions.</p></div>">
                            <canvas id="gradientDistChartCanvas" class="w-full h-[30rem]"></canvas>
                            <button id="exportGradientDist" class="export-png-button" disabled title="Export as PNG">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            </button>
                        </div>
                        <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Curvature Distribution ($\partial^2 u / \partial x^2$)</p><p class='text-xs mb-2 text-gray-300'>Shows the distribution of the second spatial derivative, related to the diffusive forces in the system.</p></div>">
                            <canvas id="curvatureDistChartCanvas" class="w-full h-[30rem]"></canvas>
                            <button id="exportCurvatureDist" class="export-png-button" disabled title="Export as PNG">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="spectrumContent" class="tab-content">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Live Energy Spectrum</h3>
                    <p class="text-xs text-gray-600 mb-4">This log-log plot shows how the system's energy is distributed across different spatial frequencies (wavenumbers, k), updating in real-time.</p>
                    <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative h-80 mb-6">
                        <canvas id="powerSpectrumChartCanvas"></canvas>
                        <button id="exportPowerSpectrum" class="export-png-button" disabled title="Export as PNG">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        </button>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Energy Spectrogram (k-t Diagram)</h3>
                    <p class="text-xs text-gray-600 mb-4">This plot shows the entire history of the energy spectrum. The horizontal axis is wavenumber (k), the vertical axis is time (t, flowing downwards), and color intensity represents energy.</p>
                    <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative h-80">
                        <canvas id="spectrumHistoryChartCanvas"></canvas>
                        <button id="exportSpectrumHistory" class="export-png-button" disabled title="Export as PNG">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        </button>
                    </div>
                </div>

                <div id="phaseSpaceContent" class="tab-content">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Live Phase Space Portrait</h3>
                    <p class="text-xs text-gray-600 mb-4">This plot shows the relationship between the field value ($u$) and its gradient ($\partial u / \partial x$), updating in real-time. Closed loops, points, or strange attractors in this space can reveal the underlying dynamics of the system.</p>
                    <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative h-96">
                        <canvas id="phaseSpaceChartCanvas"></canvas>
                        <button id="exportPhaseSpace" class="export-png-button" disabled title="Export as PNG">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        </button>
                    </div>
                </div>
                
                <div id="timeSpaceContent" class="tab-content">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Time-Space Evolution (Hovmöller Diagram)</h3>
                    <p class="text-xs text-gray-600 mb-4">This plot shows the entire simulation history at a glance. The horizontal axis is space ($x$), and the vertical axis is time ($t$, flowing downwards). The color at each point represents the value of $u(x,t)$, providing a complete map of how patterns form and evolve.</p>
                    <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative h-96">
                        <canvas id="timeSpaceChartCanvas"></canvas>
                        <button id="exportTimeSpace" class="export-png-button" disabled title="Export as PNG">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        </button>
                    </div>
                </div>

                <div id="correlationContent" class="tab-content">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Correlation Analysis</h3>
                    <p class="text-xs text-gray-600 mb-4">These plots reveal characteristic length and time scales in the simulation. Spatial correlation shows pattern wavelengths, while temporal correlation shows how long the system 'remembers' its state.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative h-96">
                            <canvas id="spatialCorrelationChartCanvas"></canvas>
                            <button id="exportSpatialCorrelation" class="export-png-button" disabled title="Export as PNG">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            </button>
                        </div>
                        <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative h-96">
                            <canvas id="temporalCorrelationChartCanvas"></canvas>
                            <button id="exportTemporalCorrelation" class="export-png-button" disabled title="Export as PNG">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="samplingContent" class="tab-content">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Temporal Sampling Distribution</h3>
                    <p class="text-xs text-gray-600 mb-4">This histogram shows the distribution of time intervals ($\Delta t$) between consecutive snapshots saved during the simulation. It helps visualize if the sampling rate was uniform.</p>
                    <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative h-96">
                        <canvas id="temporalSamplingChartCanvas"></canvas>
                        <button id="exportTemporalSampling" class="export-png-button" disabled title="Export as PNG">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        </button>
                    </div>
                </div>

                <div id="analysisPlaceholderWrapper" class="active">
                    <p id="analysisPlaceholder" class="text-gray-500 text-center py-8">Run a simulation to see detailed analysis here.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="mt-8 text-center text-xs text-gray-600" style="font-size: 9pt;">
        <p>
            Q U A N T U M &nbsp; Q &nbsp; P T E &nbsp; L T D
            <span class="mx-2">//</span>
            U E N &nbsp; 2 0 2 4 3 3 9 9 2 N
            <span class="mx-2">//</span>
            <a href="mailto:information@quantumq.net" class="text-blue-800 hover:text-indigo-600 cursor-pointer">✉️ E - M A I L</a>
            <span class="mx-2">//</span>
            <a href="#" id="acknowledgementsLink" class="hover:text-indigo-600 cursor-pointer">ACKNOWLEDGEMENTS</a>
            <span class="mx-2">//</span>
            <a href="#" id="legalLink" class="hover:text-indigo-600 cursor-pointer">LEGAL</a>
            <span class="mx-2">//</span>
            2 0 2 5 &copy;
        </p>
    </footer>


    <!-- Modals (Help, Legal, and AI Interpretation) -->
    <div id="interpretationModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">How to Interpret this Dashboard</h2>
            
            <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-4">1. The Big Picture: What is this Simulator?</h3>
            <p class="mb-4 text-gray-700">
                This simulator models a **1D Reaction-Diffusion Partial Differential Equation (PDE)**. It describes how a quantity, $u(x,t)$, changes over time ($t$) and space ($x$) due to two main processes: diffusion (spreading out) and local reactions (growth or decay).
            </p>
            <p class="mb-4 text-gray-700">
                The governing equation is:
                $$ \frac{\partial u}{\partial t} = \nu_{eff} \frac{\partial^2 u}{\partial x^2} + \beta_{NL} u(1-u) - \gamma_{diss} u^3 $$
            </p>
            <div class="mt-4 mb-4 text-red-600 font-semibold border border-red-500 p-3 rounded-md">
                <strong class="underline">CRITICAL NOTE FOR RESEARCHERS:</strong> This is **NOT** a direct model of the 3D Navier-Stokes equations. It's a conceptual tool for exploring phenomena like non-linear dynamics, diffusion, and pattern formation in a simpler 1D context. The results **cannot** be used to draw direct conclusions about 3D fluid flow or the Millennium Prize Problem.
            </div>

            <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">2. Simulation Parameters Explained</h3>
            <ul class="list-disc list-inside ml-4 text-gray-700 space-y-2">
                <li><b>System Length (L) & Grid Points (N):</b> Define the 1D space.</li>
                <li><b>Total Time (T):</b> How long the simulation runs.</li>
                <li><b>Diff. Coefficient ($\nu_{eff}$):</b> Controls diffusion, the tendency for $u$ to smooth out. Analogous to viscosity.</li>
                <li><b>Non-linear Growth ($\beta_{NL}$):</b> The "reaction" part. It makes $u$ grow, but the $u(1-u)$ term limits this growth.</li>
                <li><b>Cubic Damping ($\gamma_{diss}$):</b> An additional dissipation term that removes "energy" from the system, often leading to stabilization.</li>
                <li><b>Initial Condition:</b> The starting shape of $u$ at time $t=0$. The "Custom Formula" option allows you to enter any JavaScript expression using variables `x`, `L`, and `N`, and the `Math` object.</li>
                <li><b>Boundary Condition:</b> Determines behavior at the domain edges. 'Periodic' wraps around (like a circle), while 'Dirichlet' fixes the edges to zero (zero-flux).</li>
            </ul>

            <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">3. Numerical Method: 4th-Order Runge-Kutta (RK4)</h3>
            <p class="mb-4 text-gray-700">
                This simulator uses the **4th-Order Runge-Kutta (RK4)** method to solve the PDE over time. This is a highly accurate and stable numerical scheme, representing a significant improvement over simpler methods like Forward Euler. It works by taking four intermediate "test steps" within each time interval to calculate a weighted average slope, which dramatically reduces numerical error and allows for more reliable simulations, especially for complex or chaotic systems.
            </p>

            <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">4. Time Step (dt) & Numerical Stability</h3>
            <p class="mb-4 text-gray-700">
                The <strong>Time Step (dt)</strong> is one of the most critical parameters you can control. It determines the size of the discrete time intervals the RK4 solver uses.
            </p>
            <ul class="list-disc list-inside ml-4 text-gray-700 space-y-2">
                <li><b>Small dt:</b> Leads to a more accurate and stable simulation, but requires more computational steps and thus takes longer to run.</li>
                <li><b>Large dt:</b> The simulation runs faster, but if `dt` is too large, the numerical solution can become unstable and "blow up", producing non-physical results (`Infinity` or `NaN`).</li>
            </ul>
            <p class="mt-4 mb-4 text-gray-700">
                To help you, the dashboard includes a real-time <strong>Stability Indicator (CFL)</strong>. This value is based on the Courant-Friedrichs-Lewy condition for the diffusion part of the equation. As a rule of thumb:
            </p>
            <div class="grid grid-cols-3 gap-4 text-center text-sm">
                <div class="p-2 bg-green-100 rounded"><strong>Green (Stable):</strong> Your `dt` is likely safe.</div>
                <div class="p-2 bg-yellow-100 rounded"><strong>Orange (Marginal):</strong> You are near the stability limit. Proceed with caution.</div>
                <div class="p-2 bg-red-100 rounded"><strong>Red (Risky):</strong> Instability is very likely. You should reduce `dt`.</div>
            </div>

            <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">5. Simulation Presets Explained</h3>
            <p class="mb-4 text-gray-700">
                The presets are designed to quickly load parameter configurations that demonstrate interesting and distinct physical phenomena.
            </p>
            <ul class="list-disc list-inside ml-4 text-gray-700 space-y-2">
                <li><b>Pure Diffusion:</b> Isolates the diffusion term ($\nu_{eff}$). This shows the system behaving like a heat equation, where any initial shape smooths out over time and decays towards a uniform state.</li>
                <li><b>Growth & Decay:</b> Focuses on the non-linear reaction terms. This preset shows how the field $u$ can grow locally due to the $\beta_{NL}$ term and then become limited or stabilized by the $\gamma_{diss}$ damping term.</li>
                <li><b>Propagating Wave:</b> Demonstrates a balance between diffusion and reaction that results in a traveling wave front. A step-like initial condition moves across the domain with a relatively stable shape.</li>
                <li><b>Pattern Formation:</b> A configuration where the interplay between diffusion and reaction leads to the emergence of complex, stable, and repeating spatial patterns from a random initial state. This is analogous to Turing patterns.</li>
                <li><b>Turbulent-like Chaos:</b> With high growth and low diffusion, the system enters a complex, chaotic state. The power spectrum for this state is typically broad, indicating energy across many spatial scales, analogous to the energy cascade in turbulence.</li>
                <li><b>Shockwave Analogue:</b> This preset uses a step initial condition with parameters that cause the front to steepen as it propagates, forming a sharp gradient that is a 1D analogue of a shockwave.</li>
                <li><b>Smooth Decay (Global Regularity Analogue):</b> Starts with a random, noisy state, but high diffusion ($\nu_{eff}$) dominates all other terms, quickly smoothing the solution and causing it to decay. This demonstrates a "globally regular" solution that remains well-behaved for all time, which is one possible outcome for the Navier-Stokes equations.</li>
                <li><b>Wave Steepening (Shock Formation):</b> Begins with a smooth sine wave. Very low diffusion allows the non-linear growth term to "push" the wave forward, causing its front to become progressively steeper until it forms a near-vertical shock. This shows how sharp gradients can emerge from smooth initial data.</li>
                <li><b>Intermittency (Turbulent Puffs):</b> Creates a state analogous to a key feature of real-world turbulence. The simulation shows long periods of calm or simple behavior, punctuated by sharp, chaotic bursts of activity. This is reflected in a high Kurtosis value in the metrics.</li>
                <li><b>Singularity Analogue (Finite-Time Blow-up):</b> This is an educational preset with an intentionally unstable time-step (dt). Non-linear growth overwhelms the simulation's ability to remain stable, causing the values to rapidly shoot towards infinity. This visually demonstrates the concept of a "finite-time blow-up" or "singularity," the very phenomenon the Navier-Stokes conjecture questions the existence of.</li>
            </ul>

            <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">6. How to Analyze the Plots & Data</h3>
            <p class="text-gray-700">After running a simulation, the "Detailed Analysis" section provides powerful tools:</p>

            <h4 class="text-lg font-semibold text-gray-600 mb-2 mt-4">Term Contributions Plot</h4>
            <p class="mb-2 text-gray-700">Found below the main playback controls, this plot shows the individual components of the PDE in real-time. You can see how the <strong>Diffusion</strong> (blue), <strong>Reaction</strong> (green), and total <strong>Change (du/dt)</strong> (red dashed) contribute to the evolution of $u$. This is key to understanding why $u$ is changing at specific locations.</p>

            <h4 class="text-lg font-semibold text-gray-600 mb-2 mt-4">Final State Summary & AI Analysis</h4>
            <p class="mb-2 text-gray-700">After a successful run, this new section appears. It provides key quantitative statistics about the final state, such as dominant pattern size (wavelength), correlation scales, and distribution shape (skewness, kurtosis). You can click <strong>Generate AI Analysis</strong> to send these stats to the Gemini LLM for an expert-level interpretation of the result.</p>

            <h4 class="text-lg font-semibold text-gray-600 mb-2 mt-4">Distribution Histograms</h4>
            <p class="mb-2 text-gray-700">These plots show the statistical distribution of key quantities at the final simulation time. They reveal the overall character of the solution (e.g., is it mostly zero with a few peaks, or is it highly varied?).</p>

            <h4 class="text-lg font-semibold text-gray-600 mb-2 mt-4">Energy Spectrum Analysis</h4>
            <p class="mb-2 text-gray-700">This tab shows how the system's "energy" ($u^2$) is distributed across different spatial frequencies (wavenumbers, $k$). It's a key tool for analyzing patterns. A sharp peak at a specific $k$ indicates a dominant wavelength. A broad spectrum suggests chaotic or noisy behavior. The live plot shows this evolving, and the <strong>Energy Spectrogram (k-t diagram)</strong> shows the complete history after the simulation is finished.</p>

            <h4 class="text-lg font-semibold text-gray-600 mb-2 mt-4">Phase Space Portrait</h4>
            <p class="mb-2 text-gray-700">This plot visualizes the system's state by plotting the field value ($u$) against its spatial derivative ($\partial u / \partial x$). The shape of the resulting curve provides deep insights. For example, a simple point indicates a uniform state, a closed loop can indicate a periodic (wave-like) solution, and more complex shapes can suggest chaotic dynamics or the presence of "attractors."</p>

            <h4 class="text-lg font-semibold text-gray-600 mb-2 mt-4">Time-Space Plot (Hovmöller Diagram)</h4>
            <p class="mb-2 text-gray-700">This visualization provides a complete history of the simulation. It plots space ($x$) horizontally and time ($t$) vertically (flowing downwards). The color at each point shows the value of $u(x,t)$, making it easy to see how patterns travel, grow, or stabilize over the entire simulation run.</p>
            
            <h4 class="text-lg font-semibold text-gray-600 mb-2 mt-4">Correlation Analysis</h4>
            <p class="mb-2 text-gray-700">
                These advanced plots provide a quantitative look at the structural properties of the simulation's output.
            </p>
            <ul class="list-disc list-inside ml-4 text-gray-700 space-y-2">
                <li>
                    <strong>Spatial Autocorrelation:</strong> This function, $C(r)$, measures how similar the field $u(x)$ is to a shifted version of itself, $u(x+r)$.
                    <ul class="list-disc list-inside ml-4 text-gray-700 space-y-1 mt-1">
                        <li>A peak at a lag distance $r > 0$ indicates a dominant wavelength or pattern size in the data. The location of the first peak is a good measure of the characteristic length scale.</li>
                        <li>A rapid decay to zero implies a noisy or random spatial structure with no repeating patterns.</li>
                    </ul>
                </li>
                <li>
                    <strong>Temporal Autocorrelation:</strong> This function, $C(\tau)$, measures the "memory" of the system by comparing its spatial state at time $t$ to its state at a later time $t+\tau$.
                    <ul class="list-disc list-inside ml-4 text-gray-700 space-y-1 mt-1">
                        <li>A slow decay indicates that the system is highly predictable and its future state is strongly related to its past.</li>
                        <li>A rapid decay to zero (a short correlation time) is a hallmark of chaotic or unpredictable behavior, where small initial differences grow exponentially fast.</li>
                    </ul>
                </li>
            </ul>

            <h4 class="text-lg font-semibold text-gray-600 mb-2 mt-4">Interactive Live Plot</h4>
            <p class="mb-2 text-gray-700">Hover your mouse over the main "Live Simulation" plot. A tooltip will appear, showing you the precise values of $u$ and its first and second derivatives at that specific point in space. This is useful for inspecting sharp gradients or other local features.</p>

            <div id="apiKeyHelpSection">
                <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">7. Acquiring a Gemini API Key</h3>
                <p class="mb-4 text-gray-700">
                    To enable the AI-powered interpretation features (Results, Ask Einstein, Q&A), you need a Gemini API key. You can get a free key from Google AI Studio.
                </p>
                <ol class="list-decimal list-inside ml-4 text-gray-700 space-y-2">
                    <li>Visit the Google AI Studio website: <a href="https://aistudio.google.com/" target="_blank" class="text-blue-600 hover:underline">https://aistudio.google.com/</a></li>
                    <li>Sign in with your Google account.</li>
                    <li>Click the "Get API key" button and create a new API key.</li>
                    <li>Copy the key and paste it into the input field in the "Simulation Metrics" section of this application.</li>
                </ol>
            </div>

            <div id="acknowledgementsSection">
                <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">8. Acknowledgements</h3>
                <p class="mb-4 text-gray-700">
                    This simulator was built using a combination of powerful open-source technologies. We gratefully acknowledge the creators and maintainers of these projects:
                </p>
                <ul class="list-disc list-inside ml-4 text-gray-700 space-y-3">
                    <li><b>HTML5, CSS3, & JavaScript (ES6+):</b> The fundamental technologies of the web.</li>
                    <li><b>Tailwind CSS:</b> For rapid UI development. (<a href="https://opensource.org/licenses/MIT" target="_blank" class="text-blue-600">MIT License</a>)</li>
                    <li><b>Chart.js:</b> For all data visualizations. (<a href="https://opensource.org/licenses/MIT" target="_blank" class="text-blue-600">MIT License</a>)</li>
                    <li><b>MathJax:</b> For beautiful LaTeX rendering. (<a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" class="text-blue-600">Apache License 2.0</a>)</li>
                    <li><b>Google Gemini:</b> The advanced LLM that powers the AI-driven interpretation features.</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="legalModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Legal Disclaimers & Terms of Use</h2>
            
            <h3 class="text-lg font-semibold text-gray-700 mb-2">1. Experimental Research Tool</h3>
            <p class="mb-4 text-gray-700 text-sm">
                This 1D Fluid Dynamics Analogue Simulator (the "Tool") is provided by Quantum Q PTE. LTD. ("Quantum Q") as an experimental research and educational tool, currently in a beta development phase. It is intended solely for use by the scientific, mathematical, and engineering communities for conceptual exploration and educational purposes. The Tool is not designed, certified, or intended for use in any commercial, industrial, clinical, or mission-critical applications.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">2. No Warranty</h3>
            <p class="mb-4 text-gray-700 text-sm">
                THE TOOL IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND NONINFRINGEMENT. IN NO EVENT SHALL QUANTUM Q, ITS DIRECTORS, EMPLOYEES, OR AFFILIATES BE LIABLE FOR ANY CLAIM, DAMAGES, OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT, OR OTHERWISE, ARISING FROM, OUT OF, OR IN CONNECTION WITH THE TOOL OR THE USE OR OTHER DEALINGS IN THE TOOL.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">3. Limitation of Liability & Risk Assumption</h3>
            <p class="mb-4 text-gray-700 text-sm">
                You expressly understand and agree that Quantum Q, its directors, and its employees shall not be liable for any direct, indirect, incidental, special, consequential, or exemplary damages, including but not to, damages for loss of profits, goodwill, use, data, or other intangible losses (even if Quantum Q has been advised of the possibility of such damages), resulting from the use or the inability to use the Tool. The entire risk as to the quality, performance, and accuracy of the Tool is with you. This includes, but is not limited to, any damages or injury caused by any failure of performance, error, omission, interruption, defect, or bug within the software, particularly given its acknowledged experimental and beta status. Should the Tool prove defective, you assume the entire cost of all necessary servicing, repair, or correction, and you agree to indemnify and hold harmless Quantum Q and its employees from any and all claims arising from your use of the Tool.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">4. No Guarantee of Accuracy</h3>
            <p class="mb-4 text-gray-700 text-sm">
                While efforts have been made to ensure the mathematical and numerical integrity of the simulation, Quantum Q makes no guarantee as to the accuracy, reliability, or completeness of the results generated by the Tool. The outputs are for illustrative and conceptual purposes only and should not be used for peer-reviewed publications, engineering design, or any other formal application without independent verification and validation. As stated prominently within the Tool, this simulator is an *analogue* and is not a direct simulation of the 3D Navier-Stokes equations.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">5. Intellectual Property</h3>
            <p class="mb-4 text-gray-700 text-sm">
                All rights, title, and interest in and to the Tool, including its source code, design, and branding, are the exclusive property of Quantum Q PTE. LTD. You may not copy, modify, distribute, sell, or lease any part of our Tool or its included software, nor may you reverse engineer or attempt to extract the source code of that software, unless laws prohibit those restrictions or you have our written permission.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">6. Governing Law & Jurisdiction</h3>
            <p class="mb-4 text-gray-700 text-sm">
                These terms shall be governed by and construed in accordance with the laws of the Republic of Singapore, without regard to its conflict of law provisions. Any disputes arising out of or in connection with these terms shall be subject to the exclusive jurisdiction of the courts of the Republic of Singapore.
            </p>
            
            <h3 class="text-lg font-semibold text-gray-700 mb-2">7. International Applicability and English Law</h3>
            <p class="mb-4 text-gray-700 text-sm">
                While the primary governing law is that of the Republic of Singapore, these terms are intended to be broadly applicable to users globally. For users in jurisdictions where English law is applicable or preferred, these terms shall be interpreted in a manner consistent with the general principles of English contract law, to the extent that such interpretation does not conflict with the mandatory laws of Singapore. The parties acknowledge and agree that the principles of common law and equity, as applied in English law, may be considered in interpreting these terms where Singapore law is silent or where such principles provide additional clarity, provided always that Singapore law remains the ultimate governing law.
            </p>

            <p class="text-gray-600 text-xs italic mt-6">By using this Tool, you acknowledge that you have read, understood, and agree to be bound by these terms and disclaimers.</p>
        </div>
    </div>

    <div id="aiInterpretationModal" class="modal">
        <div class="modal-content w-11/12 md:w-3/4 lg:w-1/2">
            <span class="close-button" id="closeAiInterpretationModal">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">✨ AI Simulation Interpretation</h2>
            <div id="aiInterpretationContent" class="text-gray-700 prose max-w-none">
                <div class="flex justify-center items-center py-8">
                    <span class="spinner w-8 h-8 !border-t-purple-500 !border-gray-200"></span>
                    <span id="aiProgressMessage" class="ml-2 text-gray-600">Generating...</span>
                </div>
            </div>
            <p class="text-sm text-gray-500 mt-4 italic">
                (Interpretation provided by Gemini LLM. It is for conceptual understanding and does not constitute formal scientific analysis.)
            </p>
        </div>
    </div>

    <!-- Dynamic Tooltip Element (Hidden by default) -->
    <div id="dynamicTooltip" class="absolute z-50 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg opacity-0 transition-opacity duration-200 pointer-events-none"></div>
    
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://cdn.jsdelivr.net/npm/@google/genai@0.15.0/+esm"
      }
    }
    </script>
    <script type="module">
import { GoogleGenAI, Type } from "@google/genai";

// ==============================================================================
// SIMULATION WORKER SCRIPT (as a string to be blob-ified)
// ==============================================================================
const workerCode = `
// ==============================================================================
// UTILITY: 1D FAST FOURIER TRANSFORM
// ==============================================================================
const FFT = {
    complex: {
        add: (a, b) => [a[0] + b[0], a[1] + b[1]],
        sub: (a, b) => [a[0] - b[0], a[1] - b[1]],
        mul: (a, b) => [a[0] * b[0] - a[1] * b[1], a[0] * b[1] + a[1] * b[0]],
        exp: (phi) => [Math.cos(phi), Math.sin(phi)],
        abs: (a) => Math.sqrt(a[0] * a[0] + a[1] * a[1]),
    },
    
    _fft: function(x, inverse = false) {
        const N = x.length;
        if (N <= 1) return x;
        const even = this._fft(x.filter((_, i) => i % 2 === 0), inverse);
        const odd = this._fft(x.filter((_, i) => i % 2 === 1), inverse);
        const result = new Array(N);
        const sign = inverse ? 1 : -1;
        for (let k = 0; k < N / 2; k++) {
            const t = this.complex.mul(this.complex.exp(sign * 2 * Math.PI * k / N), odd[k]);
            result[k] = this.complex.add(even[k], t);
            result[k + N / 2] = this.complex.sub(even[k], t);
        }
        return result;
    },

    fft1d: function(realArray, inverse = false) {
        const N = realArray.length;
        if (N === 0) return [];
        const next_power_of_2 = Math.pow(2, Math.ceil(Math.log2(N)));
        const complex_x = new Array(next_power_of_2).fill([0, 0]);
        for(let i = 0; i < N; i++) complex_x[i] = [realArray[i], 0];

        let result = this._fft(complex_x, inverse);

        if (inverse) {
            for (let i = 0; i < result.length; i++) {
                result[i][0] /= next_power_of_2;
                result[i][1] /= next_power_of_2;
            }
        }
        return result; 
    }
};

// ==============================================================================
// ANALYSIS FUNCTIONS (FOR WORKER)
// ==============================================================================
function calculatePowerSpectrumData(u_final) {
    if (!u_final || u_final.length === 0) return { wavenumbers: [], power: [] };
    const fft_result = FFT.fft1d(u_final);
    const N = u_final.length;
    const power = fft_result.slice(0, N / 2).map(c => FFT.complex.abs(c)**2);
    const wavenumbers = Array.from({length: N/2}, (_, i) => i);
    return { wavenumbers, power };
}

function calculateSpatialAutocorrelation(u_array, dx) {
    const N = u_array.length;
    if (N === 0) return [];
    const mean = u_array.reduce((a, b) => a + b, 0) / N;
    const variance = u_array.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / N;
    if (variance < 1e-9) return Array.from({ length: Math.floor(N / 2) }, (_, i) => ({ x: i * dx, y: 1 }));

    const C = [];
    const maxLag = Math.floor(N / 2);
    for (let lag = 0; lag < maxLag; lag++) {
        let cov = 0;
        for (let i = 0; i < N; i++) {
            cov += (u_array[i] - mean) * (u_array[(i + lag) % N] - mean);
        }
        C.push({ x: lag * dx, y: (cov / N) / variance });
    }
    return C;
}

function calculateTemporalAutocorrelation(snapshots, timeSteps) {
    const numSnapshots = snapshots.length;
    if (numSnapshots < 2) return [];

    const N = snapshots[0].length;
    const C = [];
    const maxLag = Math.floor(numSnapshots / 2);

    const norms = snapshots.map(s => Math.sqrt(s.reduce((sum, val) => sum + val * val, 0) / N));

    for (let lag = 0; lag < maxLag; lag++) {
        let total_dot_product = 0;
        let count = 0;
        for (let t = 0; t < numSnapshots - lag; t++) {
            let dot_product = 0;
            for (let i = 0; i < N; i++) {
                dot_product += snapshots[t][i] * snapshots[t + lag][i];
            }
            const norm_t = norms[t];
            const norm_t_lag = norms[t + lag];
            if (norm_t > 1e-9 && norm_t_lag > 1e-9) {
                total_dot_product += (dot_product / N) / (norm_t * norm_t_lag);
                count++;
            }
        }
        const lagTime = timeSteps[lag] - timeSteps[0];
        if (count > 0) {
            C.push({ x: lagTime, y: total_dot_product / count });
        } else {
            C.push({ x: lagTime, y: 0 });
        }
    }
    return C;
}

// ==============================================================================
// CLASS 1: THE SIMULATION ENGINE
// ==============================================================================
class ConjectureSimulator1D {
    constructor(params) {
        this.L = params.L;
        this.N = params.N;
        this.T = params.T;
        this.dt = params.dt;
        this.nu_eff = params.nu_eff;
        this.beta_NL = params.beta_NL;
        this.gamma_diss = params.gamma_diss;
        this.boundary_cond = params.boundary_cond;
        
        this.x = Array.from({ length: this.N }, (_, i) => (i / (this.N - 1)) * this.L);
        this.dx = this.x.length > 1 ? this.x[1] - this.x[0] : this.L;
        
        this.u = new Float64Array(this.N);
        this.timeSteps = [];
        this.snapshots = [];
        this.spectrumSnapshots = [];
        this.isUnstable = false;
        
        this.initializeState(params.init_cond, params.custom_formula);
    }

    initializeState(init_cond, custom_formula = '') {
        const center = this.L / 2;
        const width = this.L / 10;

        try {
            if (init_cond === 'gaussian') {
                for (let i = 0; i < this.N; i++) {
                    this.u[i] = Math.exp(-Math.pow(this.x[i] - center, 2) / (2 * Math.pow(width, 2)));
                }
            } else if (init_cond === 'step') {
                const step_pos = this.L / 4;
                for (let i = 0; i < this.N; i++) {
                    this.u[i] = this.x[i] < step_pos ? 1.0 : 0.0;
                }
            } else if (init_cond === 'random') {
                for (let i = 0; i < this.N; i++) {
                    this.u[i] = Math.max(0, Math.min(1, 0.5 + 0.1 * (Math.random() * 2 - 1)));
                }
            } else if (init_cond === 'sine') {
                for (let i = 0; i < this.N; i++) {
                    this.u[i] = 0.5 * (1 + Math.sin(4 * Math.PI * this.x[i] / this.L));
                }
            } else if (init_cond === 'custom' && custom_formula) {
                const customFunc = new Function('x', 'L', 'N', 'Math', 'return ' + custom_formula);
                for (let i = 0; i < this.N; i++) {
                    this.u[i] = customFunc(this.x[i], this.L, this.N, Math);
                }
            }
        } catch (e) {
            console.error("Error in custom initial condition formula:", e);
            // Default to random if formula fails
            for (let i = 0; i < this.N; i++) {
                this.u[i] = Math.max(0, Math.min(1, 0.5 + 0.1 * (Math.random() * 2 - 1)));
            }
            self.postMessage({ type: 'error', message: 'Invalid custom formula. Defaulting to random. Error: ' + e.message });
        }
        
        this.snapshots.push(Array.from(this.u));
        this.timeSteps.push(0.0);
        this.spectrumSnapshots.push(calculatePowerSpectrumData(this.u).power);
    }

    _get_du_dt(u_array) {
        const N = u_array.length;
        const du_dt = new Float64Array(N);
        const u_xx = this.calculate_d2u_dx2(u_array);
        
        for (let i = 0; i < N; i++) {
            const diffusion = this.nu_eff * u_xx[i];
            const reaction = this.beta_NL * u_array[i] * (1 - u_array[i]) - this.gamma_diss * Math.pow(u_array[i], 3);
            du_dt[i] = diffusion + reaction;
        }
        return du_dt;
    }

    step() {
        if (this.isUnstable) return;
        
        const N = this.N;
        const dt = this.dt;

        // k1 = dt * f(t, u)
        const k1_deriv = this._get_du_dt(this.u);
        const k1 = new Float64Array(N);
        for (let i = 0; i < N; i++) { k1[i] = k1_deriv[i] * dt; }

        // k2 = dt * f(t + dt/2, u + k1/2)
        const u_temp2 = new Float64Array(N);
        for (let i = 0; i < N; i++) { u_temp2[i] = this.u[i] + 0.5 * k1[i]; }
        const k2_deriv = this._get_du_dt(u_temp2);
        const k2 = new Float64Array(N);
        for (let i = 0; i < N; i++) { k2[i] = k2_deriv[i] * dt; }

        // k3 = dt * f(t + dt/2, u + k2/2)
        const u_temp3 = new Float64Array(N);
        for (let i = 0; i < N; i++) { u_temp3[i] = this.u[i] + 0.5 * k2[i]; }
        const k3_deriv = this._get_du_dt(u_temp3);
        const k3 = new Float64Array(N);
        for (let i = 0; i < N; i++) { k3[i] = k3_deriv[i] * dt; }

        // k4 = dt * f(t + dt, u + k3)
        const u_temp4 = new Float64Array(N);
        for (let i = 0; i < N; i++) { u_temp4[i] = this.u[i] + k3[i]; }
        const k4_deriv = this._get_du_dt(u_temp4);
        const k4 = new Float64Array(N);
        for (let i = 0; i < N; i++) { k4[i] = k4_deriv[i] * dt; }

        // Update u
        for (let i = 0; i < N; i++) {
            this.u[i] += (k1[i] + 2 * k2[i] + 2 * k3[i] + k4[i]) / 6;
            if (!isFinite(this.u[i])) {
                this.isUnstable = true;
                return;
            }
        }
    }

    analyzeResults(u_array = this.u) {
        const N = u_array.length;
        if (N === 0) return { max_value: 0, min_value: 0, mean_value: 0, std_dev: 0, energy: 0, kurtosis: 0 };
        
        const max_value = Math.max(...u_array);
        const min_value = Math.min(...u_array);
        const mean_value = u_array.reduce((sum, val) => sum + val, 0) / N;
        
        const sqDiffs = u_array.map(val => Math.pow(val - mean_value, 2));
        const std_dev = Math.sqrt(sqDiffs.reduce((sum, val) => sum + val, 0) / N);

        let energy = 0;
        for (let i = 0; i < N - 1; i++) {
            energy += (u_array[i] * u_array[i] + u_array[i+1] * u_array[i+1]) / 2 * this.dx;
        }

        let kurtosis = 0;
        if (std_dev > 1e-9) {
            const m4 = u_array.map(val => Math.pow(val - mean_value, 4)).reduce((sum, val) => sum + val, 0) / N;
            kurtosis = m4 / Math.pow(std_dev, 4);
        }
        return { max_value, min_value, mean_value, std_dev, energy, kurtosis };
    }

    calculate_d2u_dx2(u_array) {
        const d2u_dx2 = new Float64Array(this.N);
        if (this.boundary_cond === 'periodic') {
            for (let i = 0; i < this.N; i++) {
                const u_prev = u_array[(i - 1 + this.N) % this.N];
                const u_next = u_array[(i + 1) % this.N];
                d2u_dx2[i] = (u_next - 2 * u_array[i] + u_prev) / (this.dx * this.dx);
            }
        } else {
            d2u_dx2[0] = (u_array[1] - 2 * u_array[0] + u_array[1]) / (this.dx * this.dx); // Neumann zero-flux approximation
            for (let i = 1; i < this.N - 1; i++) {
                d2u_dx2[i] = (u_array[i+1] - 2 * u_array[i] + u_array[i-1]) / (this.dx * this.dx);
            }
            d2u_dx2[this.N-1] = (u_array[this.N-2] - 2 * u_array[this.N-1] + u_array[this.N-2]) / (this.dx * this.dx); // Neumann zero-flux approximation
        }
        return d2u_dx2;
    }

    getTermContributions(u_array) {
        const N = u_array.length;
        const diffusionTerm = new Float64Array(N);
        const reactionTerm = new Float64Array(N);
        const totalDerivative = new Float64Array(N);
        const u_xx = this.calculate_d2u_dx2(u_array);

        for (let i = 0; i < N; i++) {
            diffusionTerm[i] = this.nu_eff * u_xx[i];
            reactionTerm[i] = this.beta_NL * u_array[i] * (1 - u_array[i]) - this.gamma_diss * Math.pow(u_array[i], 3);
            totalDerivative[i] = diffusionTerm[i] + reactionTerm[i];
        }
        return { diffusionTerm: Array.from(diffusionTerm), reactionTerm: Array.from(reactionTerm), totalDerivative: Array.from(totalDerivative) };
    }
}

// ==============================================================================
// WORKER LOGIC
// ==============================================================================
let simulator = null;
let simulationState = { isRunning: false, isPaused: false, currentStep: 0, n_steps: 0, delay: 0 };
let simulationLoopTimer = null;

function runSimulation() {
    if (!simulationState.isRunning || simulator.isUnstable) return;

    if (simulationState.isPaused) {
        simulationLoopTimer = setTimeout(runSimulation, 100);
        return;
    }

    const stepsPerBatch = 5; 
    for(let i=0; i<stepsPerBatch; i++) {
        if (simulationState.currentStep >= simulationState.n_steps || simulator.isUnstable) {
            simulationState.isRunning = false;
            break;
        }
        simulator.step();
        simulationState.currentStep++;
    }
    
    if (simulator.isUnstable) {
        self.postMessage({ type: 'unstable' });
        simulationState.isRunning = false;
    } else if (!simulationState.isRunning || simulationState.currentStep >= simulationState.n_steps) {
        // Final state
        self.postMessage({ type: 'finished', data: { 
            snapshots: simulator.snapshots, 
            timeSteps: simulator.timeSteps,
            spectrumSnapshots: simulator.spectrumSnapshots 
        }});
    } else {
        // Progress update
        const snapshot_interval = Math.max(1, Math.floor(simulationState.n_steps / 100));
        let spectrumData = null;
        if (simulationState.currentStep % snapshot_interval === 0) {
            simulator.snapshots.push(Array.from(simulator.u));
            const currentTime = simulationState.currentStep * simulator.dt;
            simulator.timeSteps.push(currentTime);
            
            spectrumData = calculatePowerSpectrumData(simulator.u);
            simulator.spectrumSnapshots.push(spectrumData.power);
        }
        self.postMessage({
            type: 'progress',
            data: {
                currentStep: simulationState.currentStep,
                n_steps: simulationState.n_steps,
                u: simulator.u,
                metrics: simulator.analyzeResults(),
                time: simulationState.currentStep * simulator.dt,
                termContributions: simulator.getTermContributions(simulator.u),
                spectrum: spectrumData // Send spectrum on interval
            }
        });
        simulationLoopTimer = setTimeout(runSimulation, simulationState.delay);
    }
}

self.onmessage = (e) => {
    const { command, params } = e.data;
    switch (command) {
        case 'init':
            simulator = new ConjectureSimulator1D(params);
            self.postMessage({ type: 'initialized', data: { x: simulator.x, u: simulator.u, T: simulator.T } });
            break;
        case 'start':
            if (simulator) {
                simulationState.isRunning = true;
                simulationState.isPaused = false;
                simulationState.currentStep = 0;
                simulationState.n_steps = Math.floor(simulator.T / simulator.dt);
                runSimulation();
            }
            break;
        case 'pause':
            simulationState.isPaused = true;
            break;
        case 'resume':
            simulationState.isPaused = false;
            break;
        case 'stop':
            simulationState.isRunning = false;
            if(simulationLoopTimer) clearTimeout(simulationLoopTimer);
            if (simulator) {
                 self.postMessage({ type: 'finished', data: { 
                    snapshots: simulator.snapshots, 
                    timeSteps: simulator.timeSteps,
                    spectrumSnapshots: simulator.spectrumSnapshots
                }});
            }
            break;
        case 'set_speed':
            simulationState.delay = params.delay;
            break;
        case 'analyze_final_state':
            if (simulator && simulator.snapshots.length > 0) {
                const final_u = simulator.snapshots[simulator.snapshots.length - 1];
                const spectrum = calculatePowerSpectrumData(final_u);
                const spatialCorr = calculateSpatialAutocorrelation(final_u, simulator.dx);
                const temporalCorr = calculateTemporalAutocorrelation(simulator.snapshots, simulator.timeSteps);
                self.postMessage({ type: 'final_analysis_result', data: { spectrum, spatialCorr, temporalCorr } });
            }
            break;
    }
};
`;

// ==============================================================================
// CLASS 2: THE INTERACTIVE DASHBOARD
// ==============================================================================
class SimulationDashboard {
    constructor() {
        this.worker = null;
        this.apiKey = null;
        this.liveChart = null;
        this.meanValChart = null;
        this.energyChart = null;
        
        this.isSimulationRunning = false;
        this.isSimulationPaused = false;
        this.isSimulationFinished = false;
        this.replayAnimationTimer = null;
        this.currentPresetName = "Custom";
        this.tooltipsEnabled = false;

        this.simulatorProxy = {
            L: 10.0, N: 256, dx: 0, T: 5.0, boundary_cond: 'periodic', init_cond: 'gaussian', custom_formula: '',
            isUnstable: false, x: [], snapshots: [], timeSteps: [], spectrumSnapshots: []
        };
        
        this.keyStatistics = {};
        this.aiSuggestions = null;

        this.meanValueHistory = [];
        this.energyHistory = [];
        this.timeLabels = [];
        this.maxMaxVal = -Infinity;
        this.minMinVal = Infinity;
        this.maxMeanVal = -Infinity;
        this.maxStdDev = -Infinity;
        this.maxEnergy = -Infinity;
        this.maxKurtosis = -Infinity;

        this.charts = {};

        this.lastDetailUpdateTime = 0;
        this.timeSpaceGlobalMin = null;
        this.timeSpaceGlobalMax = null;
        this.timeSpaceColorStops = [
            { t: 0.0,  rgb: [68, 1, 84] },    // Viridis-like: Deep Purple
            { t: 0.25, rgb: [59, 82, 139] },  // Blue/Teal
            { t: 0.5,  rgb: [33, 145, 140] }, // Green
            { t: 0.75, rgb: [94, 201, 98] },  // Lime Green
            { t: 1.0,  rgb: [253, 231, 37] }  // Bright Yellow
        ];
        this.spectrumGlobalMax = null;


        this.elements = this.getDOMElements();

        this._boundHandleTooltipShow = this.handleTooltipShow.bind(this);
        this._boundHandleTooltipHide = this.handleTooltipHide.bind(this);
        this._boundHandleLivePlotHover = this.handleLivePlotHover.bind(this);
        this._boundHandleLivePlotLeave = this.handleLivePlotLeave.bind(this);

        this.setupEventListeners();
        this.loadApiKeyFromStorage();
        this.updateAllSliderTrackColors();
        this.initializeCharts();
        this.refreshApplication();
    }

    getDOMElements() {
        const ids = [
            'paramL', 'paramN', 'paramT', 'paramAlpha', 'paramBeta', 'paramGamma', 'inputL', 'inputN', 'inputT',
            'inputAlpha', 'inputBeta', 'inputGamma', 'paramInit', 'paramBoundary', 'paramDt', 'inputDt',
            'customIcContainer', 'customIcFormula', 'stabilityIndicator', 'btnRun', 'btnRunContent', 'btnPauseResume',
            'btnRefresh', 'btnExport', 'btnHelp', 'btnResults', 'btnInterpretKids', 'btnQA', 'btnConversation',
            'navierStokesAudio', 'progressBar', 'livePlotCanvas', 'stabilityWarning', 'interpretationModal',
            'legalModal', 'aiInterpretationModal', 'closeAiInterpretationModal', 'aiInterpretationContent', 'aiProgressMessage',
            'legalLink', 'acknowledgementsLink', 'getApiKeyLink', 'metricMaxVal_current', 'metricMaxVal_max',
            'metricMinVal_current', 'metricMinVal_min', 'metricMeanVal_current', 'metricMeanVal_max', 'metricStdDev_current',
            'metricStdDev_max', 'metricKurtosis_current', 'metricKurtosis_max', 'metricEnergy_current', 'metricEnergy_max',
            'meanValChartCanvas', 'energyChartCanvas', 'presetDiffusion', 'presetGrowthDecay', 'presetWave',
            'presetPattern', 'presetChaos', 'presetShock', 'presetSmoothDecay', 'presetWaveBreaking', 'presetIntermittency',
            'presetBlowup', 'simulationActivityIndicator', 'percentageCounter', 'liveSimSubtitle', 'playbackControls',
            'playbackSlider', 'playbackCurrentTime', 'playbackTotalTime', 'btnReplay', 'replayPlayIcon', 'replayPauseIcon',
            'termContributionsChartCanvas', 'enableTooltips', 'dynamicTooltip', 'mainContentArea', 'tabDistribution',
            'tabSpectrum', 'tabPhaseSpace', 'tabTimeSpace', 'tabCorrelation', 'tabSampling', 'distributionContent',
            'spectrumContent', 'phaseSpaceContent', 'timeSpaceContent', 'correlationContent', 'samplingContent',
            'analysisPlaceholderWrapper', 'valueDistChartCanvas', 'gradientDistChartCanvas', 'curvatureDistChartCanvas',
            'powerSpectrumChartCanvas', 'phaseSpaceChartCanvas', 'timeSpaceChartCanvas', 'spatialCorrelationChartCanvas',
            'temporalCorrelationChartCanvas', 'temporalSamplingChartCanvas', 'finalStateSummary', 'btnAiAnalysis',
            'aiAnalysisResult', 'statWavenumber', 'statWavelength', 'statCorrLength', 'statCorrTime', 'statSkewness', 'statKurtosis',
            'simulationSpeed', 'btnSaveState', 'btnLoadState', 'loadStateInput', 'spectrumHistoryChartCanvas',
            'apiKeyInput', 'saveApiKeyButton', 'apiKeyStatus', 'exportLivePlot', 'exportTermContributions', 'exportMeanVal', 
            'exportEnergy', 'exportValueDist', 'exportGradientDist', 'exportCurvatureDist', 'exportPowerSpectrum', 
            'exportSpectrumHistory', 'exportPhaseSpace', 'exportTimeSpace', 'exportSpatialCorrelation', 
            'exportTemporalCorrelation', 'exportTemporalSampling', 'aiGoalInput', 'btnGetAiSuggestions', 'aiSuggestionsContainer'
        ];
        const elements = {};
        ids.forEach(id => elements[id] = document.getElementById(id));
        elements.closeModalButtons = document.querySelectorAll('.modal .close-button');
        return elements;
    }
    
    setupSync(sliderId, inputId, fixedPoints = 0) {
        const slider = this.elements[sliderId];
        const input = this.elements[inputId];
        const update = () => {
            this.currentPresetName = "Custom";
            this.updateLiveSimulationTitle();
            this.updateParameterStates();
            this.updateStabilityIndicator();
        };
        slider.oninput = () => {
            input.value = parseFloat(slider.value).toFixed(fixedPoints);
            this.updateSliderTrackColor(slider);
            update();
        };
        input.onchange = () => {
            let value = parseFloat(input.value);
            const min = parseFloat(slider.min);
            const max = parseFloat(slider.max);
            if (isNaN(value)) value = min;
            value = Math.max(min, Math.min(max, value));
            slider.value = value;
            input.value = value.toFixed(fixedPoints);
            this.updateSliderTrackColor(slider);
            update();
        };
    }

    setupSyncLog(sliderId, inputId) {
        const slider = this.elements[sliderId];
        const input = this.elements[inputId];
        const update = () => {
            this.currentPresetName = "Custom";
            this.updateLiveSimulationTitle();
            this.updateParameterStates();
            this.updateStabilityIndicator();
        };
        slider.oninput = () => {
            const dt = Math.pow(10, parseFloat(slider.value));
            input.value = dt.toExponential(2);
            this.updateSliderTrackColor(slider);
            update();
        };
        input.onchange = () => {
            let value = parseFloat(input.value);
            if (isNaN(value) || value <= 0) value = 0.01;
            const logVal = Math.log10(value);
            
            const min = parseFloat(slider.min);
            const max = parseFloat(slider.max);
            const clampedLogVal = Math.max(min, Math.min(max, logVal));

            slider.value = clampedLogVal;
            input.value = Math.pow(10, clampedLogVal).toExponential(2);
            this.updateSliderTrackColor(slider);
            update();
        };
    }

    updateSliderTrackColor(sliderElement) {
        if (!sliderElement) return;
        const value = parseFloat(sliderElement.value);
        const min = parseFloat(sliderElement.min);
        const max = parseFloat(sliderElement.max);
        const percentage = ((value - min) / (max - min)) * 100;
        sliderElement.style.setProperty('--slider-value-percent', `${percentage}%`);
    }
    
    updateAllSliderTrackColors() {
        Object.values(this.elements).forEach(el => {
            if (el && el.type === 'range') {
                this.updateSliderTrackColor(el);
            }
        });
    }

    setupEventListeners() {
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        this.worker = new Worker(URL.createObjectURL(blob));
        this.worker.onmessage = this.handleWorkerMessage.bind(this);

        this._setupParameterControls();
        this._setupActionButtons();
        this._setupPresetButtons();
        this._setupModalAndLinkHandlers();
        this._setupTabControls();
        this._setupPlaybackControls();
        this._setupTooltipAndHoverHandlers();
        this._setupApiKeyControls();
    }

    _setupApiKeyControls() {
        this.elements.saveApiKeyButton.onclick = () => this.saveApiKey();
        this.elements.apiKeyInput.onkeydown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.saveApiKey();
            }
        };
    }

    saveApiKey() {
        const key = this.elements.apiKeyInput.value.trim();
        const statusEl = this.elements.apiKeyStatus;
        if (key) {
            this.apiKey = key;
            try {
                localStorage.setItem('geminiApiKey', key);
                statusEl.textContent = 'API Key saved successfully!';
                statusEl.className = 'text-xs text-green-600 mt-1 h-4';
            } catch (e) {
                console.error("Could not save API key to localStorage:", e);
                statusEl.textContent = 'Could not save key (localStorage disabled?).';
                statusEl.className = 'text-xs text-yellow-600 mt-1 h-4';
            }
        } else {
            this.apiKey = null;
            try {
                localStorage.removeItem('geminiApiKey');
            } catch (e) {}
            statusEl.textContent = 'API Key cleared.';
            statusEl.className = 'text-xs text-gray-500 mt-1 h-4';
        }
        this.updateButtonStates();
        setTimeout(() => { if(statusEl) statusEl.textContent = ''; }, 3000);
    }

    loadApiKeyFromStorage() {
        try {
            const storedKey = localStorage.getItem('geminiApiKey');
            if (storedKey) {
                this.elements.apiKeyInput.value = storedKey;
                this.apiKey = storedKey;
                const statusEl = this.elements.apiKeyStatus;
                if (statusEl) {
                    statusEl.textContent = 'Loaded API Key from storage.';
                    statusEl.className = 'text-xs text-gray-500 mt-1 h-4';
                    setTimeout(() => { statusEl.textContent = ''; }, 3000);
                }
            }
        } catch (e) {
            console.warn("Could not load API key from localStorage:", e);
        }
        this.updateButtonStates();
    }

    _setupParameterControls() {
        this.setupSync('paramL', 'inputL', 1);
        this.setupSync('paramN', 'inputN', 0);
        this.setupSync('paramT', 'inputT', 1);
        this.setupSync('paramAlpha', 'inputAlpha', 2);
        this.setupSync('paramBeta', 'inputBeta', 2);
        this.setupSync('paramGamma', 'inputGamma', 2);
        this.setupSyncLog('paramDt', 'inputDt');
        
        const customUpdate = () => {
            this.currentPresetName = "Custom";
            this.updateLiveSimulationTitle();
            this.updateParameterStates();
            this.updateStabilityIndicator();
        };
        this.elements.paramInit.onchange = () => {
            this.elements.customIcContainer.classList.toggle('hidden', this.elements.paramInit.value !== 'custom');
            customUpdate();
        };
        this.elements.paramBoundary.onchange = customUpdate;

        this.elements.simulationSpeed.oninput = (e) => {
            const delay = 200 - parseInt(e.target.value, 10);
            this.worker.postMessage({ command: 'set_speed', params: { delay } });
        };
    }

    _setupActionButtons() {
        this.elements.btnRun.onclick = () => this.handleRunStop();
        this.elements.btnPauseResume.onclick = () => this.handlePauseResume();
        this.elements.btnRefresh.onclick = () => this.refreshApplication(false);
        this.elements.btnExport.onclick = () => this.exportData();
        this.elements.btnHelp.onclick = () => this.showModal('interpretationModal');
        this.elements.btnResults.onclick = () => this.interpretSimulationState();
        this.elements.btnInterpretKids.onclick = () => this.interpretSimulationStateForKids();
        this.elements.btnQA.onclick = () => this.generateQA();
        this.elements.btnConversation.onclick = () => this.playConversationAudio();
        this.elements.btnAiAnalysis.onclick = () => this.generateAiAnalysis();
        this.elements.btnSaveState.onclick = () => this.saveState();
        this.elements.btnLoadState.onclick = () => this.elements.loadStateInput.click();
        this.elements.loadStateInput.onchange = (e) => this.loadState(e);
        this.elements.btnGetAiSuggestions.onclick = () => this.getAiParameterSuggestions();

        // Export PNG button listeners
        this.elements.exportLivePlot.onclick = () => this.exportCanvasAsPNG('livePlotCanvas', 'live-plot.png');
        this.elements.exportTermContributions.onclick = () => this.exportCanvasAsPNG('termContributionsChartCanvas', 'term-contributions.png');
        this.elements.exportMeanVal.onclick = () => this.exportCanvasAsPNG('meanValChartCanvas', 'mean-value-history.png');
        this.elements.exportEnergy.onclick = () => this.exportCanvasAsPNG('energyChartCanvas', 'energy-history.png');
        this.elements.exportValueDist.onclick = () => this.exportCanvasAsPNG('valueDistChartCanvas', 'value-distribution.png');
        this.elements.exportGradientDist.onclick = () => this.exportCanvasAsPNG('gradientDistChartCanvas', 'gradient-distribution.png');
        this.elements.exportCurvatureDist.onclick = () => this.exportCanvasAsPNG('curvatureDistChartCanvas', 'curvature-distribution.png');
        this.elements.exportPowerSpectrum.onclick = () => this.exportCanvasAsPNG('powerSpectrumChartCanvas', 'power-spectrum.png');
        this.elements.exportSpectrumHistory.onclick = () => this.exportCanvasAsPNG('spectrumHistoryChartCanvas', 'spectrum-history.png');
        this.elements.exportPhaseSpace.onclick = () => this.exportCanvasAsPNG('phaseSpaceChartCanvas', 'phase-space.png');
        this.elements.exportTimeSpace.onclick = () => this.exportCanvasAsPNG('timeSpaceChartCanvas', 'time-space-plot.png');
        this.elements.exportSpatialCorrelation.onclick = () => this.exportCanvasAsPNG('spatialCorrelationChartCanvas', 'spatial-correlation.png');
        this.elements.exportTemporalCorrelation.onclick = () => this.exportCanvasAsPNG('temporalCorrelationChartCanvas', 'temporal-correlation.png');
        this.elements.exportTemporalSampling.onclick = () => this.exportCanvasAsPNG('temporalSamplingChartCanvas', 'temporal-sampling.png');
    }

    _setupPresetButtons() {
        this.elements.presetDiffusion.onclick = () => this.applyPreset({ name: 'Pure Diffusion', L: 10.0, N: 256, T: 10.0, dt_log10: -3, nu_eff: 0.5, beta_NL: 0.0, gamma_diss: 0.0, init_cond: 'gaussian', boundary_cond: 'dirichlet' });
        this.elements.presetGrowthDecay.onclick = () => this.applyPreset({ name: 'Growth and Decay', L: 10.0, N: 256, T: 15.0, dt_log10: -2, nu_eff: 0.01, beta_NL: 1.0, gamma_diss: 0.5, init_cond: 'random', boundary_cond: 'periodic' });
        this.elements.presetWave.onclick = () => this.applyPreset({ name: 'Propagating Wave', L: 20.0, N: 512, T: 20.0, dt_log10: -2.3, nu_eff: 0.05, beta_NL: 0.8, gamma_diss: 0.1, init_cond: 'step', boundary_cond: 'periodic' });
        this.elements.presetPattern.onclick = () => this.applyPreset({ name: 'Pattern Formation', L: 30.0, N: 768, T: 30.0, dt_log10: -2, nu_eff: 0.02, beta_NL: 1.5, gamma_diss: 0.3, init_cond: 'random', boundary_cond: 'periodic' });
        this.elements.presetChaos.onclick = () => this.applyPreset({ name: 'Turbulent-like Chaos', L: 50.0, N: 1024, T: 40.0, dt_log10: -2, nu_eff: 0.01, beta_NL: 2.0, gamma_diss: 0.2, init_cond: 'random', boundary_cond: 'periodic' });
        this.elements.presetShock.onclick = () => this.applyPreset({ name: 'Shockwave Analogue', L: 20.0, N: 512, T: 10.0, dt_log10: -2, nu_eff: 0.02, beta_NL: 1.2, gamma_diss: 0.0, init_cond: 'step', boundary_cond: 'periodic' });
        this.elements.presetSmoothDecay.onclick = () => this.applyPreset({ name: 'Smooth Decay', L: 20.0, N: 512, T: 25.0, dt_log10: -2.5, nu_eff: 0.8, beta_NL: 0.1, gamma_diss: 0.5, init_cond: 'random', boundary_cond: 'periodic' });
        this.elements.presetWaveBreaking.onclick = () => this.applyPreset({ name: 'Wave Steepening', L: 20.0, N: 1024, T: 8.0, dt_log10: -2.5, nu_eff: 0.005, beta_NL: 1.8, gamma_diss: 0.0, init_cond: 'sine', boundary_cond: 'periodic' });
        this.elements.presetIntermittency.onclick = () => this.applyPreset({ name: 'Intermittency', L: 50.0, N: 1024, T: 50.0, dt_log10: -2.0, nu_eff: 0.03, beta_NL: 1.2, gamma_diss: 0.6, init_cond: 'random', boundary_cond: 'periodic' });
        this.elements.presetBlowup.onclick = () => this.applyPreset({ name: 'Finite-Time Blow-up', L: 10.0, N: 512, T: 5.0, dt_log10: -1.8, nu_eff: 0.01, beta_NL: 2.0, gamma_diss: 0.0, init_cond: 'gaussian', boundary_cond: 'dirichlet' });
    }

    _setupModalAndLinkHandlers() {
         this.elements.closeModalButtons.forEach(btn => btn.onclick = () => this.hideAllModals());
        
        const setupLink = (linkId, modalId, sectionId) => {
            const linkElement = document.getElementById(linkId);
            linkElement.onclick = (e) => {
                e.preventDefault(); this.showModal(modalId, sectionId);
            };
        };

        setupLink('getApiKeyLink', 'interpretationModal', 'apiKeyHelpSection');
        setupLink('acknowledgementsLink', 'interpretationModal', 'acknowledgementsSection');
        this.elements.legalLink.onclick = (e) => { e.preventDefault(); this.showModal('legalModal'); };
        window.onclick = (event) => { if (event.target.classList.contains('modal')) this.hideAllModals(); };
    }

    _setupTabControls() {
        document.querySelectorAll('.tab-button').forEach(tab => {
            if(tab) tab.onclick = (e) => this.switchTab(e.currentTarget);
        });
    }

    _setupPlaybackControls() {
        this.elements.playbackSlider.oninput = () => this.handlePlaybackScrub();
        this.elements.btnReplay.onclick = () => this.toggleReplayAnimation();
    }

    _setupTooltipAndHoverHandlers() {
        this.elements.enableTooltips.onchange = (e) => {
            this.tooltipsEnabled = e.target.checked;
            if (!this.tooltipsEnabled) this.handleTooltipHide();
        };
        this.elements.mainContentArea.addEventListener('mouseover', this._boundHandleTooltipShow);
        this.elements.mainContentArea.addEventListener('mouseout', this._boundHandleTooltipHide);
        this.elements.mainContentArea.addEventListener('mousemove', this._boundHandleTooltipShow);

        this.elements.livePlotCanvas.addEventListener('mousemove', this._boundHandleLivePlotHover);
        this.elements.livePlotCanvas.addEventListener('mouseleave', this._boundHandleLivePlotLeave);
    }

    async handleTooltipShow(event) {
        if (!this.tooltipsEnabled) return;
        const tooltipHost = event.target.closest('[data-tooltip-content]');
        if (!tooltipHost) return;
        
        const tooltip = this.elements.dynamicTooltip;
        tooltip.innerHTML = tooltipHost.dataset.tooltipContent;
        if (window.MathJax?.typesetPromise) await window.MathJax.typesetPromise([tooltip]);

        const hostRect = tooltipHost.getBoundingClientRect();
        const tooltipWidth = tooltip.offsetWidth;
        const tooltipHeight = tooltip.offsetHeight;
        let left = window.scrollX + hostRect.left + (hostRect.width / 2) - (tooltipWidth / 2);
        let top = window.scrollY + hostRect.top - tooltipHeight - 5;
        if (left < window.scrollX + 5) left = window.scrollX + 5;
        if ((left + tooltipWidth) > (window.scrollX + window.innerWidth - 5)) left = window.scrollX + window.innerWidth - tooltipWidth - 5;
        if (top < window.scrollY + 5) top = window.scrollY + hostRect.bottom + 5;
        tooltip.style.left = `${left}px`;
        tooltip.style.top = `${top}px`;
        tooltip.classList.add('show');
    }

    handleTooltipHide() {
        this.elements.dynamicTooltip.classList.remove('show');
    }

    handleLivePlotHover(event) {
        if (!this.charts.liveChart || !this.simulatorProxy.x.length) return;
    
        const canvas = this.elements.livePlotCanvas;
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const index = Math.round(this.charts.liveChart.scales.x.getValueForPixel(x));
    
        if (index < 0 || index >= this.simulatorProxy.N) {
            this.handleLivePlotLeave();
            return;
        }
    
        const currentU = this.charts.liveChart.data.datasets[0].data;
        const u_val = currentU[index];
        const du_dx_val = this.calculate_du_dx(currentU)[index];
        const d2u_dx2_val = this.calculate_d2u_dx2(currentU)[index];
    
        this.charts.liveChart.update('none'); // Redraw to clear old line
        const ctx = this.charts.liveChart.ctx;
        const chartArea = this.charts.liveChart.chartArea;
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(this.charts.liveChart.scales.x.getPixelForValue(index), chartArea.top);
        ctx.lineTo(this.charts.liveChart.scales.x.getPixelForValue(index), chartArea.bottom);
        ctx.lineWidth = 1;
        ctx.strokeStyle = 'rgba(239, 68, 68, 0.7)'; // red-500
        ctx.stroke();
        ctx.restore();
    
        const tooltip = this.elements.dynamicTooltip;
        tooltip.innerHTML = `
            <div class="tooltip-grid">
                <span class="tooltip-grid-label">x:</span> <span>${this.simulatorProxy.x[index].toFixed(2)}</span>
                <span class="tooltip-grid-label">u:</span> <span>${u_val.toExponential(3)}</span>
                <span class="tooltip-grid-label">u<sub>x</sub>:</span> <span>${du_dx_val.toExponential(3)}</span>
                <span class="tooltip-grid-label">u<sub>xx</sub>:</span> <span>${d2u_dx2_val.toExponential(3)}</span>
            </div>
        `;
        tooltip.style.left = `${event.pageX + 15}px`;
        tooltip.style.top = `${event.pageY + 15}px`;
        tooltip.classList.add('show');
    }
    
    handleLivePlotLeave() {
        if (this.charts.liveChart) this.charts.liveChart.update('none');
        this.elements.dynamicTooltip.classList.remove('show');
    }

    applyPreset(presetConfig) {
        if (this.isSimulationRunning) this.worker.postMessage({command: 'stop'});

        this.elements.paramL.value = presetConfig.L; this.elements.inputL.value = presetConfig.L.toFixed(1);
        this.elements.paramN.value = presetConfig.N; this.elements.inputN.value = presetConfig.N;
        this.elements.paramT.value = presetConfig.T; this.elements.inputT.value = presetConfig.T.toFixed(1);
        this.elements.paramDt.value = presetConfig.dt_log10; this.elements.inputDt.value = Math.pow(10, presetConfig.dt_log10).toExponential(2);
        this.elements.paramAlpha.value = presetConfig.nu_eff; this.elements.inputAlpha.value = presetConfig.nu_eff.toFixed(2);
        this.elements.paramBeta.value = presetConfig.beta_NL; this.elements.inputBeta.value = presetConfig.beta_NL.toFixed(2);
        this.elements.paramGamma.value = presetConfig.gamma_diss; this.elements.inputGamma.value = presetConfig.gamma_diss.toFixed(2);
        this.elements.paramInit.value = presetConfig.init_cond;
        this.elements.paramBoundary.value = presetConfig.boundary_cond;

        this.elements.customIcContainer.classList.add('hidden');

        this.updateAllSliderTrackColors();
        this.currentPresetName = presetConfig.name;
        this.updateParameterStates();
        this.updateStabilityIndicator();
        this.refreshApplication(true);
        this.handleRunStop();
    }

    updateParameterStates() {
        const preset = this.currentPresetName;
        const stateMap = {
            'paramGroupAlpha': true,
            'paramGroupBeta': true,
            'paramGroupGamma': true,
        };

        if (preset === 'Pure Diffusion') {
            stateMap.paramGroupBeta = false;
            stateMap.paramGroupGamma = false;
        } else if (preset === 'Growth and Decay') {
            stateMap.paramGroupAlpha = false;
        } else if (preset === 'Shockwave Analogue') {
            stateMap.paramGroupGamma = false;
        }

        for (const [groupId, isEnabled] of Object.entries(stateMap)) {
            const group = document.getElementById(groupId);
            if (group) {
                group.classList.toggle('parameter-disabled', !isEnabled);
            }
        }
    }

    initializeCharts() {
        const createChart = (canvasId, chartVar, config) => {
            const canvas = this.elements[canvasId];
            if (!canvas) return;
            if (this.charts[chartVar]) {
                try {
                    this.charts[chartVar].destroy();
                } catch (e) { /* ignore */ }
            }
            this.charts[chartVar] = new Chart(canvas.getContext('2d'), config);
        };

        createChart('livePlotCanvas', 'liveChart', {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'u(x,t)', data: [], borderColor: 'rgb(79, 70, 229)', borderWidth: 2, pointRadius: 0, tension: 0.1 }] },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { title: { display: true, text: 'Position (x)' }, type: 'linear', beginAtZero: true }, y: { title: { display: true, text: 'u(x,t)' }, min: -0.2, max: 1.2 } }, plugins: { legend: { display: false }, title: { display: true, text: 'Live Simulation' } } }
        });
        createChart('meanValChartCanvas', 'meanValChart', {
            type: 'line', data: { labels: [], datasets: [{ label: 'Mean Value', data: [], borderColor: '#10B981', borderWidth: 2, pointRadius: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Time (t)' } }, y: { title: { display: true, text: 'Mean Value' } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Mean Value vs. Time' } } }
        });
        createChart('energyChartCanvas', 'energyChart', {
            type: 'line', data: { labels: [], datasets: [{ label: 'Energy', data: [], borderColor: '#F59E0B', borderWidth: 2, pointRadius: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Time (t)' } }, y: { title: { display: true, text: 'Energy' }, type: 'logarithmic' } }, plugins: { legend: { display: false }, title: { display: true, text: 'Energy vs. Time' } } }
        });
        
        const createBarChart = (canvasId, chartVar, label) => createChart(canvasId, chartVar, {
            type: 'bar', data: { labels: [], datasets: [{ label, data: [], backgroundColor: 'rgba(79, 70, 229, 0.6)' }] },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { title: { display: true, text: 'Value Bins' } }, y: { title: { display: true, text: 'Frequency' }, beginAtZero: true } }, plugins: { legend: { display: false }, title: {display: true, text: label} } }
        });
        createBarChart('valueDistChartCanvas', 'valueDistChart', 'Value Distribution (u)');
        createBarChart('gradientDistChartCanvas', 'gradientDistChart', 'Gradient Distribution (du/dx)');
        createBarChart('curvatureDistChartCanvas', 'curvatureDistChart', 'Curvature Distribution (d2u/dx2)');
        createBarChart('temporalSamplingChartCanvas', 'temporalSamplingChart', 'Snapshot Interval Distribution (Δt)');

        createChart('powerSpectrumChartCanvas', 'powerSpectrumChart', {
            type: 'line', data: { datasets: [{ label: 'Power Spectrum', data: [], backgroundColor: '#4F46E5', showLine: true }] },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { type: 'logarithmic', title: { display: true, text: 'Wavenumber k' } }, y: { type: 'logarithmic', title: { display: true, text: 'Power' } } }, plugins: { legend: { display: false }, title: { display: false } } }
        });
        createChart('phaseSpaceChartCanvas', 'phaseSpaceChart', {
            type: 'scatter', data: { datasets: [{ label: 'Phase Space', data: [], backgroundColor: 'rgba(79, 70, 229, 0.6)', pointRadius: 1, showLine: false }] },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { title: { display: true, text: 'u(x)' } }, y: { title: { display: true, text: 'du/dx' } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Live Phase Space Portrait' } } }
        });
        createChart('spatialCorrelationChartCanvas', 'spatialCorrelationChart', {
            type: 'line', data: { datasets: [{ label: 'Spatial Autocorrelation', data: [], borderColor: '#DB2777', showLine: true, pointRadius: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { type: 'linear', title: { display: true, text: 'Lag Distance (r)' } }, y: { title: { display: true, text: 'Correlation' }, min: -1, max: 1 } }, plugins: { legend: { display: false }, title: { display: true, text: 'Spatial Autocorrelation' } } }
        });
        createChart('temporalCorrelationChartCanvas', 'temporalCorrelationChart', {
            type: 'line', data: { datasets: [{ label: 'Temporal Autocorrelation', data: [], borderColor: '#6D28D9', showLine: true, pointRadius: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { type: 'linear', title: { display: true, text: 'Lag Time (τ)' } }, y: { title: { display: true, text: 'Correlation' }, min: -1, max: 1 } }, plugins: { legend: { display: false }, title: { display: true, text: 'Temporal Autocorrelation' } } }
        });
        createChart('termContributionsChartCanvas', 'termContributionsChart', {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Diffusion', data: [], borderColor: '#3B82F6', borderWidth: 2, pointRadius: 0, tension: 0.1 },
                    { label: 'Reaction', data: [], borderColor: '#16A34A', borderWidth: 2, pointRadius: 0, tension: 0.1 },
                    { label: 'Total Change (du/dt)', data: [], borderColor: '#EF4444', borderWidth: 2, pointRadius: 0, tension: 0.1, borderDash: [5, 5] }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, animation: false,
                scales: { x: { title: { display: true, text: 'Position (x)' } }, y: { title: { display: true, text: 'Value' } } },
                plugins: {
                    legend: {
                        display: true, position: 'top',
                        onClick: (e, legendItem, legend) => {
                            const index = legendItem.datasetIndex;
                            const ci = legend.chart;
                            if (ci.isDatasetVisible(index)) {
                                ci.hide(index);
                                legendItem.hidden = true;
                            } else {
                                ci.show(index);
                                legendItem.hidden = false;
                            }
                        }
                    }
                }
            }
        });

        const clearCanvas = (canvasId) => {
            const canvas = this.elements[canvasId];
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
        clearCanvas('timeSpaceChartCanvas');
        clearCanvas('spectrumHistoryChartCanvas');
    }

    updateMetricsDisplay(currentResults) {
        this.meanValueHistory.push(currentResults.mean_value);
        this.energyHistory.push(currentResults.energy);
        
        this.maxMaxVal = Math.max(this.maxMaxVal, currentResults.max_value);
        this.minMinVal = Math.min(this.minMinVal, currentResults.min_value);
        this.maxMeanVal = Math.max(this.maxMeanVal, currentResults.mean_value);
        this.maxStdDev = Math.max(this.maxStdDev, currentResults.std_dev);
        this.maxEnergy = Math.max(this.maxEnergy, currentResults.energy);
        this.maxKurtosis = Math.max(this.maxKurtosis, currentResults.kurtosis);

        const updateMetric = (id, val, format = 'exp') => {
            this.elements[id].textContent = format === 'exp' ? val.toExponential(3) : val.toFixed(4);
        };
        updateMetric('metricMaxVal_current', currentResults.max_value, 'fixed'); updateMetric('metricMaxVal_max', this.maxMaxVal, 'fixed');
        updateMetric('metricMinVal_current', currentResults.min_value, 'fixed'); updateMetric('metricMinVal_min', this.minMinVal, 'fixed');
        updateMetric('metricMeanVal_current', currentResults.mean_value, 'fixed'); updateMetric('metricMeanVal_max', this.maxMeanVal, 'fixed');
        updateMetric('metricStdDev_current', currentResults.std_dev, 'fixed'); updateMetric('metricStdDev_max', this.maxStdDev, 'fixed');
        updateMetric('metricKurtosis_current', currentResults.kurtosis); updateMetric('metricKurtosis_max', this.maxKurtosis);
        updateMetric('metricEnergy_current', currentResults.energy, 'fixed'); updateMetric('metricEnergy_max', this.maxEnergy, 'fixed');
    }

    resetMetricsDisplay() {
        this.meanValueHistory = []; this.energyHistory = []; this.timeLabels = [];
        this.maxMaxVal = -Infinity; this.minMinVal = Infinity;
        this.maxMeanVal = -Infinity; this.maxStdDev = -Infinity; this.maxEnergy = -Infinity; this.maxKurtosis = -Infinity;
        Object.keys(this.elements).filter(k => k.startsWith('metric')).forEach(id => {
             if (this.elements[id]) {
                if (id.includes('Kurtosis')) {
                    this.elements[id].textContent = '0.000e+0';
                } else {
                    this.elements[id].textContent = '0.0000';
                }
             }
        });
    }

    updateTimeSeriesCharts() {
        if (this.charts.meanValChart) {
            this.charts.meanValChart.data.labels = this.timeLabels;
            this.charts.meanValChart.data.datasets[0].data = this.meanValueHistory;
            this.charts.meanValChart.update('none');
        }
        if (this.charts.energyChart) {
            this.charts.energyChart.data.labels = this.timeLabels;
            this.charts.energyChart.data.datasets[0].data = this.energyHistory;
            this.charts.energyChart.update('none');
        }
    }

    canInterpret() {
        return this.isSimulationFinished && this.apiKey && !this.simulatorProxy.isUnstable;
    }

    updateButtonStates() {
        const setButtonState = (btn, enabled) => {
            if (btn) { btn.disabled = !enabled; btn.classList.toggle('opacity-50', !enabled); btn.classList.toggle('cursor-not-allowed', !enabled); }
        };
        const parameterControls = ['paramGroupL', 'paramGroupN', 'paramGroupT', 'paramGroupAlpha', 'paramGroupBeta', 'paramGroupGamma', 'paramGroupDt', 'paramGroupBoundary', 'paramGroupInit'];
        const presetButtons = Object.keys(this.elements).filter(k => k.startsWith('preset'));
        
        const setGroupState = (ids, enabled) => ids.forEach(id => {
            const el = document.getElementById(id) || this.elements[id];
            if (el) {
                if (el.tagName === 'BUTTON') setButtonState(el, enabled);
                else el.classList.toggle('parameter-disabled', !enabled);
            }
        });
    
        if (this.isSimulationRunning) {
            setButtonState(this.elements.btnRun, true); setButtonState(this.elements.btnPauseResume, true);
            setButtonState(this.elements.btnRefresh, false); setButtonState(this.elements.btnExport, false);
            setButtonState(this.elements.btnSaveState, false); setButtonState(this.elements.btnLoadState, false);
            setGroupState(parameterControls, false); setGroupState(presetButtons, false);
            this.elements.playbackControls.classList.add('playback-disabled');
        } else if (this.isSimulationFinished) {
            setButtonState(this.elements.btnRun, false);
            setButtonState(this.elements.btnPauseResume, false);
            setButtonState(this.elements.btnRefresh, true); 
            setButtonState(this.elements.btnExport, !this.simulatorProxy.isUnstable);
            setButtonState(this.elements.btnSaveState, true); setButtonState(this.elements.btnLoadState, true);
            setGroupState(parameterControls, false); setGroupState(presetButtons, false);
            this.elements.playbackControls.classList.toggle('playback-disabled', this.simulatorProxy.isUnstable);
        } else { // Initial state
            setButtonState(this.elements.btnRun, true); setButtonState(this.elements.btnPauseResume, false);
            setButtonState(this.elements.btnRefresh, true); setButtonState(this.elements.btnExport, false);
            setButtonState(this.elements.btnSaveState, false); setButtonState(this.elements.btnLoadState, true);
            setGroupState(parameterControls, true); setGroupState(presetButtons, true);
            this.elements.playbackControls.classList.add('playback-disabled');
        }
        
        const canInterpret = this.canInterpret();
        setButtonState(this.elements.btnResults, canInterpret);
        setButtonState(this.elements.btnInterpretKids, canInterpret);
        setButtonState(this.elements.btnQA, canInterpret);
        setButtonState(this.elements.btnAiAnalysis, canInterpret);
        setButtonState(this.elements.btnReplay, this.isSimulationFinished && !this.simulatorProxy.isUnstable);
        setButtonState(this.elements.btnGetAiSuggestions, this.apiKey && !this.isSimulationRunning);

        const enableExports = this.isSimulationFinished && !this.simulatorProxy.isUnstable;
        const exportButtons = [
            'exportLivePlot', 'exportTermContributions', 'exportMeanVal', 'exportEnergy',
            'exportValueDist', 'exportGradientDist', 'exportCurvatureDist',
            'exportPowerSpectrum', 'exportSpectrumHistory', 'exportPhaseSpace', 'exportTimeSpace',
            'exportSpatialCorrelation', 'exportTemporalCorrelation', 'exportTemporalSampling'
        ];
        exportButtons.forEach(id => setButtonState(this.elements[id], enableExports));
    
        this.updateLiveSimulationTitle();
        this.elements.btnRun.classList.toggle('bg-red-600', this.isSimulationRunning); this.elements.btnRun.classList.toggle('hover:bg-red-700', this.isSimulationRunning);
        this.elements.btnRun.classList.toggle('bg-indigo-600', !this.isSimulationRunning); this.elements.btnRun.classList.toggle('hover:bg-indigo-700', !this.isSimulationRunning);
        this.elements.btnRunContent.classList.toggle('pulsing-text', this.isSimulationRunning && !this.isSimulationPaused);
        this.elements.btnRunContent.innerHTML = this.isSimulationRunning ? `<svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9 10h6v4H9v-4z"></path></svg> Stop` : `<svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.82V9.18a1 1 0 011.555-.832l3.197 2.132a1 1 0 010 1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Simulation`;
        this.elements.btnPauseResume.innerHTML = this.isSimulationPaused ? `<svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168L10 9.18v5.64l4.752-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Resume` : `<svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Pause`;
    }
            
    finalizeSimulation() {
        this.isSimulationRunning = false;
        this.isSimulationFinished = true;
        if (this.replayAnimationTimer) this.toggleReplayAnimation();
    
        setTimeout(() => {
            if (this.simulatorProxy.isUnstable) {
                this.elements.stabilityWarning.style.display = 'block';
            } else if (this.simulatorProxy.snapshots.length > 0) {
                // Cache global scales for visualization
                this.cacheGlobalScales();
                this.showDetailedAnalysis();
                const slider = this.elements.playbackSlider;
                slider.max = this.simulatorProxy.T;
                const lastTime = this.simulatorProxy.timeSteps.slice(-1)[0] || 0;
                slider.value = lastTime;
                this.elements.playbackCurrentTime.textContent = `Time: ${lastTime.toFixed(2)}s`;
                this.elements.playbackTotalTime.textContent = `Total: ${this.simulatorProxy.T.toFixed(2)}s`;
                this.updateSliderTrackColor(slider);
                const lastSnapshot = this.simulatorProxy.snapshots.slice(-1)[0];
                if(lastSnapshot) this.updateTermContributionsChart(lastSnapshot);
            }
            this.updateButtonStates();
        }, 10);
    }

    cacheGlobalScales() {
        let globalMin = this.simulatorProxy.snapshots[0][0];
        let globalMax = this.simulatorProxy.snapshots[0][0];
        for (const snapshot of this.simulatorProxy.snapshots) {
            for (const val of snapshot) {
                if (val < globalMin) globalMin = val;
                if (val > globalMax) globalMax = val;
            }
        }
        this.timeSpaceGlobalMin = globalMin;
        this.timeSpaceGlobalMax = globalMax;

        let specMax = 0;
        for (const spectrum of this.simulatorProxy.spectrumSnapshots) {
            for (const val of spectrum) {
                if(isFinite(val) && val > specMax) specMax = val;
            }
        }
        this.spectrumGlobalMax = specMax > 1e-9 ? specMax : 1.0;
    }

    handleRunStop() {
        if (this.isSimulationRunning) {
            this.worker.postMessage({ command: 'stop' });
            this.elements.btnRun.disabled = true;
            this.elements.btnRunContent.innerHTML = `<span class="spinner w-5 h-5 !border-white !border-t-transparent mr-2"></span> Stopping...`;
        } else {
            if (this.isSimulationFinished) this.refreshApplication(true);
            
            this.elements.analysisPlaceholderWrapper.style.display = 'none';
            this.elements.analysisPlaceholderWrapper.classList.remove('active');
            const activeTab = document.querySelector('.tab-button.active-tab');
            if (activeTab) {
                const activeContentId = activeTab.dataset.tab;
                const activeContent = document.getElementById(activeContentId);
                if (activeContent) activeContent.style.display = 'block';
            }

            this.isSimulationRunning = true;
            this.isSimulationPaused = false;
            this.worker.postMessage({ command: 'start' });
            this.updateButtonStates();
        }
    }

    handlePauseResume() {
        if (!this.isSimulationRunning) return;
        this.isSimulationPaused = !this.isSimulationPaused;
        this.worker.postMessage({ command: this.isSimulationPaused ? 'pause' : 'resume' });
        this.updateButtonStates();
    }

    refreshApplication(keepPresetName = false) {
        if (this.isSimulationRunning) this.worker.postMessage({ command: 'stop' });
        if (this.replayAnimationTimer) this.toggleReplayAnimation();
        this.isSimulationRunning = false; this.isSimulationPaused = false; this.isSimulationFinished = false;
        this.timeSpaceGlobalMin = null; this.timeSpaceGlobalMax = null; this.spectrumGlobalMax = null;
        this.elements.progressBar.style.width = '0%';
        this.elements.stabilityWarning.style.display = 'none';
        this.elements.finalStateSummary.classList.add('hidden');
        this.elements.aiAnalysisResult.classList.add('hidden');
        this.elements.aiSuggestionsContainer.classList.add('hidden');
        
        this.resetMetricsDisplay();
        
        if (!keepPresetName) {
            this.currentPresetName = "Custom";
            this.updateParameterStates();
        }
        
        const params = this.getCurrentParams();
        
        this.simulatorProxy = { ...this.simulatorProxy, ...params, isUnstable: false, snapshots: [], timeSteps: [], spectrumSnapshots: [] };
        this.simulatorProxy.dx = params.L / (params.N - 1);

        this.worker.postMessage({ command: 'init', params });

        this.initializeCharts(); // Re-init all charts
        
        this.elements.analysisPlaceholderWrapper.style.display = 'block';
        this.elements.analysisPlaceholderWrapper.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            content.style.display = 'none';
        });

        this.updateButtonStates();
        this.updateStabilityIndicator();
        this.switchTab(this.elements.tabDistribution);

        const slider = this.elements.playbackSlider;
        slider.max = params.T; slider.value = 0;
        this.elements.playbackCurrentTime.textContent = 'Time: 0.00s';
        this.elements.playbackTotalTime.textContent = `Total: ${params.T.toFixed(2)}s`;
        this.updateSliderTrackColor(slider);
    }

    getCurrentParams() {
        return {
            L: parseFloat(this.elements.paramL.value), N: parseInt(this.elements.paramN.value), T: parseFloat(this.elements.paramT.value),
            dt: parseFloat(this.elements.inputDt.value),
            nu_eff: parseFloat(this.elements.paramAlpha.value), beta_NL: parseFloat(this.elements.paramBeta.value), gamma_diss: parseFloat(this.elements.paramGamma.value),
            init_cond: this.elements.paramInit.value,
            boundary_cond: this.elements.paramBoundary.value,
            custom_formula: this.elements.customIcFormula.value
        };
    }

    handleWorkerMessage(e) {
        const { type, data, message } = e.data;
        switch (type) {
            case 'initialized':
                this.simulatorProxy.x = data.x;
                this.simulatorProxy.T = data.T;
                this.charts.liveChart.data.labels = data.x;
                this.charts.liveChart.data.datasets[0].data = data.u;
                this.charts.liveChart.update();
                this.charts.meanValChart.options.scales.x.max = data.T;
                this.charts.energyChart.options.scales.x.max = data.T;
                this.updateTermContributionsChart(data.u);
                break;
            case 'progress':
                const { currentStep, n_steps, u, metrics, time, termContributions, spectrum } = data;
                const progressPercent = Math.min(100, (currentStep / n_steps) * 100);
                this.elements.progressBar.style.width = `${progressPercent}%`;
                this.elements.percentageCounter.textContent = `${progressPercent.toFixed(0)}%`;

                this.updateMetricsDisplay(metrics);
                this.timeLabels.push(time);
                this.updateTimeSeriesCharts();
                
                this.charts.liveChart.data.datasets[0].data = Array.from(u);
                this.charts.liveChart.update('none');
                
                this.updateTermContributionsChart(u, termContributions);

                this.updateRealTimeAnalysis(u, spectrum);
                break;
            case 'finished':
                this.simulatorProxy.snapshots = data.snapshots;
                this.simulatorProxy.timeSteps = data.timeSteps;
                this.simulatorProxy.spectrumSnapshots = data.spectrumSnapshots;
                this.finalizeSimulation();
                break;
            case 'unstable':
                this.simulatorProxy.isUnstable = true;
                this.finalizeSimulation();
                break;
            case 'final_analysis_result':
                const final_u = this.simulatorProxy.snapshots.slice(-1)[0];
                if (!final_u) break;

                this.calculateKeyStatistics(final_u, data.spectrum, { spatialCorr: data.spatialCorr, temporalCorr: data.temporalCorr });
                this.displayKeyStatistics();
                
                this.displayPowerSpectrumChart(data.spectrum);
                this.displayCorrelationCharts(data.spatialCorr, data.temporalCorr);
                break;
            case 'error':
                alert(`Simulation Worker Error: ${message}`);
                break;
        }
    }

    updateStabilityIndicator() {
        const N = parseInt(this.elements.paramN.value);
        if (N <= 1) return;

        // Get all relevant parameters from the UI
        const L = parseFloat(this.elements.paramL.value);
        const nu_eff = parseFloat(this.elements.paramAlpha.value);
        const beta_NL = parseFloat(this.elements.paramBeta.value);
        const gamma_diss = parseFloat(this.elements.paramGamma.value);
        const dt = parseFloat(this.elements.inputDt.value);

        const dx = L / (N - 1);

        // 1. Diffusion stability condition (CFL for diffusion)
        // This is conservative; stability requires this to be < 0.5 for explicit schemes.
        const cfl_diffusion = (nu_eff * dt) / (dx * dx);

        // 2. Reaction stability condition (heuristic)
        // This is based on the time step needing to resolve the fastest reaction dynamics.
        // We estimate the maximum rate of change |f'(u)| as approx. (beta_NL + 3*gamma_diss)
        // assuming u is around 1. RK4 is more stable than Euler, so we add a factor of 2
        // to make the threshold comparable to the diffusion CFL.
        const cfl_reaction = dt * (beta_NL + 3 * gamma_diss) / 2.0;

        // The overall stability is limited by the most restrictive condition.
        const cfl_combined = Math.max(cfl_diffusion, cfl_reaction);
        
        // Determine which term is the limiting factor for the tooltip
        const limiting_term = cfl_diffusion >= cfl_reaction ? 'Diffusion (Δx)' : 'Reaction (growth)';

        const indicator = this.elements.stabilityIndicator;
        indicator.textContent = `Stability ≈ ${cfl_combined.toFixed(3)}`;
        
        if (cfl_combined >= 0.5) {
            indicator.className = 'text-xs font-semibold px-2 py-1 rounded-full bg-red-200 text-red-800 w-28 text-center';
            indicator.title = `Risky: High chance of numerical instability, limited by ${limiting_term}. Try reducing dt.`;
        } else if (cfl_combined >= 0.25) {
            indicator.className = 'text-xs font-semibold px-2 py-1 rounded-full bg-yellow-200 text-yellow-800 w-28 text-center';
            indicator.title = `Marginal: Approaching the stability limit, constrained by ${limiting_term}.`;
        } else {
            indicator.className = 'text-xs font-semibold px-2 py-1 rounded-full bg-green-200 text-green-800 w-28 text-center';
            indicator.title = `Stable: dt is likely safe. Currently limited by ${limiting_term}.`;
        }
    }

    updateLiveSimulationTitle() {
        const subtitleSpan = this.elements.liveSimSubtitle;
        const activityIndicator = this.elements.simulationActivityIndicator;
        const spinnerElement = activityIndicator.querySelector('.spinner');

        if (!this.isSimulationRunning && !this.isSimulationFinished) {
            subtitleSpan.innerHTML = `<span class="text-red-500">INACTIVE</span>`;
            activityIndicator.style.display = 'none';
        } else if (this.isSimulationFinished) {
            if (this.simulatorProxy && this.simulatorProxy.isUnstable) {
                subtitleSpan.innerHTML = `<span class="text-red-700 font-bold">UNSTABLE</span>`;
                activityIndicator.style.display = 'none';
            } else {
                subtitleSpan.innerHTML = `<span class="text-blue-600">COMPLETED</span>`;
                activityIndicator.style.display = 'flex';
                spinnerElement.classList.add('spinner-completed');
            }
        } else {
            subtitleSpan.innerHTML = `<span class="text-green-600-custom">ACTIVE</span>`;
            activityIndicator.style.display = 'flex';
            spinnerElement.classList.remove('spinner-completed');
        }
    }
    
    toggleReplayAnimation() {
        if (this.replayAnimationTimer) {
            clearInterval(this.replayAnimationTimer); this.replayAnimationTimer = null;
            this.elements.replayPlayIcon.classList.remove('hidden'); this.elements.replayPauseIcon.classList.add('hidden');
        } else {
            const slider = this.elements.playbackSlider;
            if (parseFloat(slider.value) >= parseFloat(slider.max)) slider.value = 0;
            this.elements.replayPlayIcon.classList.add('hidden'); this.elements.replayPauseIcon.classList.remove('hidden');
            this.replayAnimationTimer = setInterval(() => this.stepPlayback(), 50);
        }
    }

    stepPlayback() {
        const slider = this.elements.playbackSlider;
        let currentValue = parseFloat(slider.value);
        const maxValue = parseFloat(slider.max);
        currentValue += maxValue / 100; // 5s replay
        if (currentValue >= maxValue) currentValue = 0;
        slider.value = currentValue;
        this.handlePlaybackScrub();
    }

    handlePlaybackScrub() {
        if (!this.simulatorProxy || this.simulatorProxy.snapshots.length === 0) return;
        const currentTime = parseFloat(this.elements.playbackSlider.value);
        this.updateSliderTrackColor(this.elements.playbackSlider);
        const snapshotIndex = this.findSnapshotIndexForTime(currentTime);
        const selectedSnapshot = this.simulatorProxy.snapshots[snapshotIndex];
        this.elements.playbackCurrentTime.textContent = `Time: ${this.simulatorProxy.timeSteps[snapshotIndex].toFixed(2)}s`;
        this.charts.liveChart.data.datasets[0].data = selectedSnapshot;
        this.charts.liveChart.update('none');
        this.updateTermContributionsChart(selectedSnapshot);
    }

    findSnapshotIndexForTime(time) {
        if (!this.simulatorProxy || this.simulatorProxy.timeSteps.length === 0) return 0;
        // Binary search could be faster, but for ~100 snapshots this is fine.
        return this.simulatorProxy.timeSteps.reduce((prev, curr, i) => 
            (Math.abs(curr - time) < Math.abs(this.simulatorProxy.timeSteps[prev] - time) ? i : prev), 0);
    }

    showModal(modalId, sectionId = null) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'flex';
        if (window.MathJax?.typesetPromise) window.MathJax.typesetPromise([modal]);
        if (sectionId) document.getElementById(sectionId)?.scrollIntoView({ behavior: 'smooth' });
    }
    
    hideAllModals() {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    }

    async showAiInterpretation(prompt, isJson = false) {
        this.showModal('aiInterpretationModal');
        const contentDiv = this.elements.aiInterpretationContent;
        contentDiv.innerHTML = `<div class="flex justify-center items-center py-8"><span class="spinner w-8 h-8 !border-t-purple-500 !border-gray-200"></span><span id="aiProgressMessage" class="ml-2 text-gray-600">Generating...</span></div>`;
        
        const aiButtons = [this.elements.btnResults, this.elements.btnInterpretKids, this.elements.btnQA, this.elements.btnAiAnalysis];
        const originalButtonContent = aiButtons.map(btn => btn.innerHTML);
        aiButtons.forEach(btn => {
            btn.innerHTML = `<span class="spinner w-5 h-5 !border-white !border-t-transparent"></span>`;
            btn.disabled = true;
        });

        try {
            if (!this.apiKey) {
                throw new Error("Gemini API key is not provided. Please enter your key.");
            }
            if (!this.isSimulationFinished) {
                contentDiv.innerHTML = `<p>Please run a simulation to completion.</p>`; 
                return;
            }

            const ai = new GoogleGenAI({apiKey: this.apiKey});
            
            const config = isJson ? { responseMimeType: "application/json" } : {};
            const response = await ai.models.generateContent({
                model: "gemini-2.5-flash",
                contents: prompt,
                config,
            });
            let text = response.text;

            if (isJson) {
                 if (text.startsWith("```json")) text = text.substring(7, text.length - 3).trim();
                 else if (text.startsWith("```")) text = text.substring(3, text.length - 3).trim();
                 const qaPairs = JSON.parse(text);
                 let qaHtml = `<h3 class="text-xl font-semibold text-gray-700 mb-4">Frequently Asked Questions</h3>`;
                 qaPairs.forEach((item, index) => { qaHtml += `<div class="mb-4 p-3 border border-gray-200 rounded-md bg-gray-50"><h4 class="font-bold text-lg text-gray-800 mb-1">Q${index + 1}: ${item.question}</h4><p class="text-gray-700">${item.answer.replace(/\n/g, '<br>')}</p></div>`; });
                 contentDiv.innerHTML = `<div class="prose max-w-none">${qaHtml}</div>`;
            } else {
                contentDiv.innerHTML = `<div class="prose max-w-none">${text.replace(/\n/g, '<br>')}</div>`;
            }
            if (window.MathJax?.typesetPromise) window.MathJax.typesetPromise([contentDiv]);
        } catch (error) {
            console.error("Gemini API Error:", error);
            contentDiv.innerHTML = `<p class="text-red-600">Failed to get AI interpretation: ${error.message}. Please check your API key and network connection.</p>`;
        } finally {
             aiButtons.forEach((btn, index) => {
                btn.innerHTML = originalButtonContent[index];
            });
            this.updateButtonStates();
        }
    }

    interpretSimulationState() {
        const metrics = this.maxMetrics();
        const prompt = `As an expert in partial differential equations, provide a conceptual interpretation of a 1D Reaction-Diffusion PDE simulation. The simulation used a 4th-Order Runge-Kutta solver. Simulation Parameters: L=${this.elements.paramL.value}, N=${this.elements.paramN.value}, T=${this.elements.paramT.value}, dt=${parseFloat(this.elements.inputDt.value).toExponential(2)}, nu_eff=${this.elements.paramAlpha.value}, beta_NL=${this.elements.paramBeta.value}, gamma_diss=${this.elements.paramGamma.value}, Initial Condition: ${this.elements.paramInit.value}, Boundary Condition: ${this.elements.paramBoundary.value}. Final Metrics: Max Value: ${metrics.max_value.toFixed(4)}, Min Value: ${metrics.min_value.toFixed(4)}, Mean Value: ${metrics.mean_value.toFixed(4)}, Std Dev: ${metrics.std_dev.toFixed(4)}, Kurtosis: ${metrics.kurtosis.toFixed(4)}, Energy: ${metrics.energy.toFixed(4)}. Analyze the interplay of diffusion, growth, and damping. Describe the overall behavior, evolution from the initial state, and what the metric trends suggest. Format using Markdown and LaTeX.`;
        this.showAiInterpretation(prompt);
    }

    interpretSimulationStateForKids() {
        const metrics = this.maxMetrics();
        const prompt = `Act as a friendly scientist explaining an experiment on a mysterious "goo" to a 10-year-old. Our Setup: Tube Length: ${this.elements.paramL.value}, Watched for: ${this.elements.paramT.value}s, "Spreading Agent": ${this.elements.paramAlpha.value}, "Growth Potion": ${this.elements.paramBeta.value}, "Clean-up Crew": ${this.elements.paramGamma.value}, Started with a '${this.elements.paramInit.value}' shape. The Goo's Report Card: Highest Mountain: ${metrics.max_value.toFixed(4)}, Deepest Valley: ${metrics.min_value.toFixed(4)}, Average Level: ${metrics.mean_value.toFixed(4)}, Bumpiness: ${metrics.std_dev.toFixed(4)}, Total Activity: ${metrics.energy.toFixed(4)}. Tell a simple story: What happened to the goo? Did it spread out, form patterns, or disappear? Explain in an enthusiastic way.`;
        this.showAiInterpretation(prompt);
    }
    
    generateQA() {
         const prompt = `Generate 5 insightful questions and detailed answers about a 1D Reaction-Diffusion PDE simulation solved with a 4th-Order Runge-Kutta method. The questions and answers should delve into the relationship between parameters and outcomes, numerical methods (like RK4 vs Euler), stability, boundary conditions, and conceptual links to more complex systems. The final output must be a valid JSON array of objects, where each object has a 'question' and 'answer' key.`;
        this.showAiInterpretation(prompt, true);
    }
    
    maxMetrics() {
        const lastMetricsCurrent = {
            max_value: parseFloat(this.elements.metricMaxVal_current.textContent),
            min_value: parseFloat(this.elements.metricMinVal_current.textContent),
            mean_value: parseFloat(this.elements.metricMeanVal_current.textContent),
            std_dev: parseFloat(this.elements.metricStdDev_current.textContent),
            kurtosis: parseFloat(this.elements.metricKurtosis_current.textContent),
            energy: parseFloat(this.elements.metricEnergy_current.textContent),
        }
        return lastMetricsCurrent;
    }

    playConversationAudio() {
        const audio = this.elements.navierStokesAudio;
        const btn = this.elements.btnConversation;
        if (audio.paused) { audio.play(); btn.textContent = `Pause Conversation`; } 
        else { audio.pause(); btn.textContent = `Conversation`; }
        audio.onended = () => { btn.textContent = `Conversation`; };
    }

    switchTab(tabElement) {
        if (!tabElement) return;
        const targetContentId = tabElement.dataset.tab;

        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            content.style.display = 'none';
        });
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active-tab');
            btn.classList.add('inactive-tab');
        });

        const activeContent = document.getElementById(targetContentId);
        if (activeContent) {
            activeContent.classList.add('active');
            if (this.isSimulationRunning || this.isSimulationFinished) {
                activeContent.style.display = 'block';
            }
        }
        tabElement.classList.remove('inactive-tab');
        tabElement.classList.add('active-tab');

        if (this.isSimulationFinished && !this.simulatorProxy.isUnstable) {
            const final_u = this.simulatorProxy.snapshots.slice(-1)[0];
            if (!final_u) {
                this.elements.analysisPlaceholderWrapper.style.display = 'block';
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                if(activeContent) activeContent.style.display = 'block';
                return;
            }
            
            setTimeout(() => {
                switch (targetContentId) {
                    case 'distributionContent': {
                        const final_du_dx = this.calculate_du_dx(final_u);
                        const final_d2u_dx2 = this.calculate_d2u_dx2(final_u);
                        this.displayDistributionCharts(final_u, final_du_dx, final_d2u_dx2);
                        break;
                    }
                    case 'phaseSpaceContent': {
                        const final_du_dx = this.calculate_du_dx(final_u);
                        this.displayPhaseSpaceChart(final_u, final_du_dx);
                        break;
                    }
                    case 'timeSpaceContent':
                        this.displayTimeSpacePlot();
                        break;
                    case 'samplingContent':
                        this.displayTemporalSamplingChart();
                        break;
                    case 'spectrumContent':
                        this.displaySpectrumHistoryPlot();
                        break;
                }
            }, 50);
        }
    }

    showDetailedAnalysis() {
        if (!this.simulatorProxy || !this.isSimulationFinished || this.simulatorProxy.isUnstable) {
            this.elements.analysisPlaceholderWrapper.style.display = 'block';
            this.elements.analysisPlaceholderWrapper.classList.add('active');
            this.elements.finalStateSummary.classList.add('hidden'); // Hide summary
            return;
        }
        
        this.elements.analysisPlaceholderWrapper.style.display = 'none';
        this.elements.analysisPlaceholderWrapper.classList.remove('active');
        
        this.worker.postMessage({ command: 'analyze_final_state' });

        this.elements.finalStateSummary.classList.remove('hidden');
        ['statWavenumber', 'statWavelength', 'statCorrLength', 'statCorrTime', 'statSkewness', 'statKurtosis'].forEach(id => {
            if (this.elements[id]) this.elements[id].textContent = '...';
        });

        this.switchTab(document.querySelector('.tab-button.active-tab'));
    }

    getDistribution(dataArray, numBins = 20) {
        if (dataArray.length === 0) return { labels: [], data: [] };
        let minVal = dataArray[0], maxVal = dataArray[0];
        for (const val of dataArray) {
            if (val < minVal) minVal = val;
            if (val > maxVal) maxVal = val;
        }
        if (maxVal === minVal) return { labels: [maxVal.toPrecision(2)], data: [dataArray.length] };
        const binWidth = (maxVal - minVal) / numBins;
        const histData = new Array(numBins).fill(0);
        const labels = Array.from({ length: numBins }, (_, i) => (minVal + i * binWidth).toPrecision(2));
        dataArray.forEach(val => {
            let binIndex = Math.floor((val - minVal) / binWidth);
            if (binIndex >= numBins) binIndex = numBins - 1;
            if (binIndex < 0) binIndex = 0;
            histData[binIndex]++;
        });
        return { labels, data: histData };
    }

    displayDistributionCharts(u, du_dx, d2u_dx2) {
        const updateChart = (chartVar, data, label) => {
            if (!this.charts[chartVar]) return;
            const distData = this.getDistribution(data);
            this.charts[chartVar].data.labels = distData.labels;
            this.charts[chartVar].data.datasets[0].data = distData.data;
            this.charts[chartVar].data.datasets[0].label = label;
            this.charts[chartVar].update('none');
        };
        updateChart('valueDistChart', u, 'Value Distribution (u)');
        updateChart('gradientDistChart', du_dx, 'Gradient Distribution (du/dx)');
        updateChart('curvatureDistChart', d2u_dx2, 'Curvature Distribution (d2u/dx2)');
    }

    displayPowerSpectrumChart({ wavenumbers, power }) {
        if (!this.charts.powerSpectrumChart) return;
        const spectrumData = wavenumbers.map((k, i) => ({x: k, y: power[i]})).filter(p => p.y > 1e-9 && p.x > 0);
        
        this.charts.powerSpectrumChart.data.datasets[0].data = spectrumData;
        if(wavenumbers.length > 0) this.charts.powerSpectrumChart.data.labels = wavenumbers;
        this.charts.powerSpectrumChart.update('none');
    }

    displayPhaseSpaceChart(u_final, du_dx_final) {
        if (!this.charts.phaseSpaceChart) return;
        const phaseData = u_final.map((u_val, i) => ({x: u_val, y: du_dx_final[i]}));
        this.charts.phaseSpaceChart.data.datasets[0].data = phaseData;
        this.charts.phaseSpaceChart.update('none');
    }

    displayCorrelationCharts(spatialCorrData, temporalCorrData) {
        if (this.charts.spatialCorrelationChart) {
            this.charts.spatialCorrelationChart.data.datasets[0].data = spatialCorrData;
            this.charts.spatialCorrelationChart.update('none');
        }
        if (this.charts.temporalCorrelationChart) {
            this.charts.temporalCorrelationChart.data.datasets[0].data = temporalCorrData;
            this.charts.temporalCorrelationChart.update('none');
        }
    }

    displayTemporalSamplingChart() {
        if (!this.simulatorProxy || this.simulatorProxy.timeSteps.length < 2 || !this.charts.temporalSamplingChart) {
            return;
        }
        const timeSteps = this.simulatorProxy.timeSteps;
        const deltas = [];
        for (let i = 1; i < timeSteps.length; i++) {
            deltas.push(timeSteps[i] - timeSteps[i - 1]);
        }
        if (deltas.length === 0) return;

        const distData = this.getDistribution(deltas, 20);
        const chart = this.charts.temporalSamplingChart;
        chart.data.labels = distData.labels.map(label => parseFloat(label).toExponential(2));
        chart.data.datasets[0].data = distData.data;
        chart.options.scales.x.title.text = 'Time Interval (s)';
        chart.update('none');
    }

    _getColor(value, min, max, colorStops) {
        const range = max - min;
        const t = range > 1e-9 ? (value - min) / range : 0.5;
        const lerp = (a, b, t) => a + (b - a) * t;
        for (let i = 0; i < colorStops.length - 1; i++) {
            const s1 = colorStops[i];
            const s2 = colorStops[i + 1];
            if (t >= s1.t && t <= s2.t) {
                const localT = (s2.t - s1.t > 1e-9) ? (t - s1.t) / (s2.t - s1.t) : 0;
                const r = Math.round(lerp(s1.rgb[0], s2.rgb[0], localT));
                const g = Math.round(lerp(s1.rgb[1], s2.rgb[1], localT));
                const b = Math.round(lerp(s1.rgb[2], s2.rgb[2], localT));
                return [r, g, b];
            }
        }
        return colorStops[colorStops.length - 1].rgb;
    }

    _drawColorBar(canvas, min, max, colorStops) {
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const colorBarWidth = 60;
        const plotWidth = canvas.width - colorBarWidth;
        const plotHeight = canvas.height;
        
        const cbX = plotWidth;
        const cbWidth = colorBarWidth - 30;
        const gradient = ctx.createLinearGradient(0, plotHeight, 0, 0);
        colorStops.forEach(s => gradient.addColorStop(s.t, `rgb(${s.rgb.join(',')})`));
        ctx.fillStyle = gradient;
        ctx.fillRect(cbX, 0, cbWidth, plotHeight);

        const lerp = (a, b, t) => a + (b - a) * t;
        ctx.fillStyle = '#333';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        const numLabels = 5;
        for (let i = 0; i <= numLabels; i++) {
            const y = plotHeight - (plotHeight * (i / numLabels));
            const value = lerp(min, max, i / numLabels);
            ctx.fillText(value.toExponential(1), cbX + cbWidth + 4, y);
            ctx.fillRect(cbX - 2, y, cbWidth + 4, 1);
        }
    }

    updateRealTimeAnalysis(current_u, spectrum = null) {
        const now = performance.now();
        if (now - this.lastDetailUpdateTime < 100) return; // Throttle
        this.lastDetailUpdateTime = now;

        const activeTab = document.querySelector('.tab-button.active-tab');
        if (!activeTab) return;
        const targetContentId = activeTab.dataset.tab;

        switch (targetContentId) {
            case 'distributionContent': {
                const du_dx = this.calculate_du_dx(current_u);
                const d2u_dx2 = this.calculate_d2u_dx2(current_u);
                this.displayDistributionCharts(current_u, du_dx, d2u_dx2);
                break;
            }
            case 'phaseSpaceContent': {
                const du_dx = this.calculate_du_dx(current_u);
                this.displayPhaseSpaceChart(current_u, du_dx);
                break;
            }
            case 'spectrumContent': {
                if(spectrum) this.displayPowerSpectrumChart(spectrum);
                break;
            }
        }
    }

    getTermContributions(u_array) {
        const N = u_array.length;
        const p = this.simulatorProxy;
        const diffusionTerm = new Float64Array(N);
        const reactionTerm = new Float64Array(N);
        const totalDerivative = new Float64Array(N);
        const u_xx = this.calculate_d2u_dx2(u_array);

        for (let i = 0; i < N; i++) {
            diffusionTerm[i] = p.nu_eff * u_xx[i];
            reactionTerm[i] = p.beta_NL * u_array[i] * (1 - u_array[i]) - p.gamma_diss * Math.pow(u_array[i], 3);
            totalDerivative[i] = diffusionTerm[i] + reactionTerm[i];
        }
        return { diffusionTerm, reactionTerm, totalDerivative };
    }

    updateTermContributionsChart(u_array, terms = null) {
        if (!this.simulatorProxy || !this.charts.termContributionsChart) return;
        
        const effectiveTerms = terms ? terms : this.getTermContributions(u_array);

        this.charts.termContributionsChart.data.labels = this.simulatorProxy.x;
        this.charts.termContributionsChart.data.datasets[0].data = Array.from(effectiveTerms.diffusionTerm);
        this.charts.termContributionsChart.data.datasets[1].data = Array.from(effectiveTerms.reactionTerm);
        this.charts.termContributionsChart.data.datasets[2].data = Array.from(effectiveTerms.totalDerivative);
        this.charts.termContributionsChart.update('none');
    }

    displayTimeSpacePlot() {
        const canvas = this.elements.timeSpaceChartCanvas;
        if (!canvas || !this.simulatorProxy || this.timeSpaceGlobalMin === null) return;
        this.draw2DPlot(canvas, this.simulatorProxy.snapshots, this.timeSpaceGlobalMin, this.timeSpaceGlobalMax, this.timeSpaceColorStops);
    }

    displaySpectrumHistoryPlot() {
        const canvas = this.elements.spectrumHistoryChartCanvas;
        if (!canvas || !this.simulatorProxy || this.spectrumGlobalMax === null) return;
        this.draw2DPlot(canvas, this.simulatorProxy.spectrumSnapshots, 0, Math.log10(this.spectrumGlobalMax + 1), this.timeSpaceColorStops, true);
    }

    draw2DPlot(canvas, dataSnapshots, globalMin, globalMax, colorStops, useLog = false) {
        if (dataSnapshots.length <= 1) {
            const ctx = canvas.getContext('2d');
            if(canvas.parentElement.clientWidth > 0) {
               canvas.width = canvas.parentElement.clientWidth;
               canvas.height = canvas.parentElement.clientHeight;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            return;
        }

        const parent = canvas.parentElement;
        canvas.width = parent.clientWidth;
        canvas.height = parent.clientHeight;
        if (canvas.width === 0 || canvas.height === 0) return;
        
        this._drawColorBar(canvas, globalMin, globalMax, colorStops);

        const ctx = canvas.getContext('2d');
        const colorBarWidth = 60;
        const plotWidth = canvas.width - colorBarWidth;
        const plotHeight = canvas.height;
        const imageData = ctx.createImageData(plotWidth, plotHeight);
        const imgData = imageData.data;
        const numTimeSteps = dataSnapshots.length;
        const numSpacePoints = dataSnapshots[0].length;
        
        for (let y = 0; y < plotHeight; y++) {
            const timeIndex = Math.floor(y * numTimeSteps / plotHeight);
            const snapshot = dataSnapshots[timeIndex];
            for (let x = 0; x < plotWidth; x++) {
                const spaceIndex = Math.floor(x * numSpacePoints / plotWidth);
                let value = snapshot[spaceIndex];
                if(useLog) value = isFinite(value) && value > 0 ? Math.log10(value + 1) : 0;

                const color = this._getColor(value, globalMin, globalMax, colorStops);
                const pixelIndex = (y * plotWidth + x) * 4;
                imgData[pixelIndex] = color[0]; imgData[pixelIndex + 1] = color[1];
                imgData[pixelIndex + 2] = color[2]; imgData[pixelIndex + 3] = 255;
            }
        }
        ctx.putImageData(imageData, 0, 0);
    }
    
    calculate_du_dx(u_array) {
        const N = this.simulatorProxy.N;
        const dx = this.simulatorProxy.dx;
        const du_dx = new Float64Array(N);
        if (this.simulatorProxy.boundary_cond === 'periodic') {
            for (let i = 0; i < N; i++) {
                const u_prev = u_array[(i - 1 + N) % N];
                const u_next = u_array[(i + 1) % N];
                du_dx[i] = (u_next - u_prev) / (2 * dx);
            }
        } else { // Dirichlet (zero-flux)
            du_dx[0] = (u_array[1] - u_array[0]) / dx;
            for (let i = 1; i < N - 1; i++) {
                du_dx[i] = (u_array[i+1] - u_array[i-1]) / (2 * dx);
            }
            du_dx[N-1] = (u_array[N-1] - u_array[N-2]) / dx;
        }
        return du_dx;
    }

    calculate_d2u_dx2(u_array) {
        const N = this.simulatorProxy.N;
        const dx = this.simulatorProxy.dx;
        const d2u_dx2 = new Float64Array(N);
        if (this.simulatorProxy.boundary_cond === 'periodic') {
            for (let i = 0; i < N; i++) {
                const u_prev = u_array[(i - 1 + N) % N];
                const u_next = u_array[(i + 1) % N];
                d2u_dx2[i] = (u_next - 2 * u_array[i] + u_prev) / (dx * dx);
            }
        } else {
            d2u_dx2[0] = (u_array[1] - 2 * u_array[0] + u_array[1]) / (dx * dx);
            for (let i = 1; i < N - 1; i++) {
                d2u_dx2[i] = (u_array[i+1] - 2 * u_array[i] + u_array[i-1]) / (dx * dx);
            }
            d2u_dx2[N-1] = (u_array[this.N-1] - 2 * u_array[this.N-1] + u_array[this.N-2]) / (dx * dx);
        }
        return d2u_dx2;
    }

    exportData() {
        let csvContent = "time," + this.simulatorProxy.x.map(val => `x_${val.toFixed(4)}`).join(",") + "\n";
        this.simulatorProxy.snapshots.forEach((snapshot, index) => {
            const time = this.simulatorProxy.timeSteps[index].toFixed(4);
            csvContent += `${time},${snapshot.map(val => val.toFixed(6)).join(",")}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "simulation_results.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    exportCanvasAsPNG(canvasId, filename) {
        const canvas = this.elements[canvasId];
        if (!canvas) {
            console.error(`Canvas with id ${canvasId} not found for export.`);
            return;
        }
        const link = document.createElement('a');
        link.download = filename;
        // Setting background color to white for transparent canvases
        const context = canvas.getContext('2d');
        const compositeCanvas = document.createElement('canvas');
        compositeCanvas.width = canvas.width;
        compositeCanvas.height = canvas.height;
        const compositeCtx = compositeCanvas.getContext('2d');
        compositeCtx.fillStyle = 'white';
        compositeCtx.fillRect(0, 0, canvas.width, canvas.height);
        compositeCtx.drawImage(canvas, 0, 0);
        link.href = compositeCanvas.toDataURL('image/png').replace("image/png", "image/octet-stream");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    calculateKeyStatistics(final_u, spectrum, correlations) {
        this.keyStatistics = {}; // Reset
        if (!final_u) return;

        if (spectrum) {
            const { power, wavenumbers } = spectrum;
            const spectrumData = wavenumbers.map((k, i) => ({x: k, y: power[i]})).filter(p => p.y > 1e-9 && p.x > 0);
            let peakWavenumber = 'N/A';
            if (spectrumData.length > 0) {
                const peak = spectrumData.reduce((max, p) => p.y > max.y ? p : max, spectrumData[0]);
                peakWavenumber = peak.x;
            }
            this.keyStatistics.domWavenumber = peakWavenumber;
            this.keyStatistics.wavelength = (peakWavenumber !== 'N/A' && peakWavenumber > 0) ? this.simulatorProxy.L / peakWavenumber : 'N/A';
        }

        if (correlations) {
            this.keyStatistics.corrLength = this.findCorrelationScale(correlations.spatialCorr);
            this.keyStatistics.corrTime = this.findCorrelationScale(correlations.temporalCorr);
        }
        
        this.keyStatistics.skewness = this.calculateSkewness(final_u);
        this.keyStatistics.kurtosis = this.maxMetrics().kurtosis;
    }

    displayKeyStatistics() {
        const format = (val, fixed = 2) => {
            if (val === null || val === undefined) return '--';
            if (typeof val === 'string') return val;
            if (typeof val === 'number') return val.toFixed(fixed);
            return '--';
        };
        this.elements.statWavenumber.textContent = format(this.keyStatistics.domWavenumber, 1);
        this.elements.statWavelength.textContent = format(this.keyStatistics.wavelength);
        this.elements.statCorrLength.textContent = format(this.keyStatistics.corrLength);
        this.elements.statCorrTime.textContent = format(this.keyStatistics.corrTime);
        this.elements.statSkewness.textContent = format(this.keyStatistics.skewness);
        this.elements.statKurtosis.textContent = format(this.keyStatistics.kurtosis);
    }

    calculateSkewness(dataArray) {
        const N = dataArray.length;
        if (N === 0) return 0;
        const mean = dataArray.reduce((a, b) => a + b, 0) / N;
        const stdDev = Math.sqrt(dataArray.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / N);
        if (stdDev < 1e-9) return 0;
        const skew = dataArray.map(x => Math.pow((x - mean) / stdDev, 3)).reduce((a, b) => a + b, 0) / N;
        return skew;
    }

    findCorrelationScale(corrData) {
        if (!corrData || corrData.length < 2) return 'N/A';
        const firstZeroCrossing = corrData.find((point, i) => i > 0 && point.y < 0 && corrData[i-1].y >= 0);
        if (firstZeroCrossing) {
            const p1 = corrData[corrData.indexOf(firstZeroCrossing) - 1];
            const p2 = firstZeroCrossing;
            if (Math.abs(p2.y - p1.y) < 1e-9) return p1.x; // Avoid division by zero
            return p1.x - p1.y * (p2.x - p1.x) / (p2.y - p1.y); // Linear interpolation
        }
        const oneOverE = Math.exp(-1);
        const firstOneOverE = corrData.find(point => point.y < oneOverE);
        if (firstOneOverE) return firstOneOverE.x;
        return `> ${corrData[corrData.length - 1].x.toFixed(2)}`;
    }

    async generateAiAnalysis() {
        const btn = this.elements.btnAiAnalysis;
        const originalContent = btn.innerHTML;
        btn.innerHTML = `<span class="spinner w-5 h-5 !border-white !border-t-transparent"></span>`;
        btn.disabled = true;

        const resultDiv = this.elements.aiAnalysisResult;
        resultDiv.classList.remove('hidden');
        resultDiv.innerHTML = `<div class="flex items-center"><span class="spinner w-5 h-5 !border-t-purple-500 !border-gray-200"></span><span class="ml-2 text-gray-600">Generating analysis...</span></div>`;

        const params = `L=${this.simulatorProxy.L}, N=${this.simulatorProxy.N}, T=${this.simulatorProxy.T}, dt=${this.simulatorProxy.dt.toExponential(2)}, nu_eff=${this.simulatorProxy.nu_eff}, beta_NL=${this.simulatorProxy.beta_NL}, gamma_diss=${this.simulatorProxy.gamma_diss}, IC: ${this.elements.paramInit.value}, BC: ${this.elements.paramBoundary.value}`;
        const stats = `Dominant Wavenumber: ${this.elements.statWavenumber.textContent}, Wavelength: ${this.elements.statWavelength.textContent}, Spatial Corr Length: ${this.elements.statCorrLength.textContent}, Temporal Corr Time: ${this.elements.statCorrTime.textContent}, Skewness: ${this.elements.statSkewness.textContent}, Kurtosis: ${this.elements.statKurtosis.textContent}.`;
        
        const prompt = `You are an expert physicist analyzing data from a 1D Reaction-Diffusion PDE simulation.
            The equation is: ∂u/∂t = ν_eff * ∂²u/∂x² + β_NL * u(1-u) - γ_diss * u³.
            
            Here are the simulation parameters: ${params}
            Here are the key statistics from the final state: ${stats}

            Provide a comprehensive analysis of the simulation result. Your analysis should be structured in markdown with the following sections:
            1.  **Overall System Behavior:** Give a high-level summary. Did it form patterns, become chaotic, decay to a steady state, or show traveling waves?
            2.  **Pattern Analysis:** Based on the dominant wavenumber, wavelength, and spatial correlation length, describe the spatial structure of the final state. Is it periodic? What is the characteristic size of the features?
            3.  **Dynamic Characteristics:** Based on the temporal correlation time, describe the system's dynamics. Does it have a long 'memory' (stable/periodic) or is it rapidly changing and unpredictable (chaotic)?
            4.  **Statistical Signature:** Interpret the skewness and kurtosis. What do they tell you about the distribution of values in the final state? For example, high kurtosis suggests sharp, intermittent structures.
            5.  **Conclusion:** Synthesize the above points into a concluding paragraph about the nature of the simulated phenomenon. Relate it back to the interplay of the simulation parameters (diffusion, reaction, damping).`;

        try {
            if (!this.apiKey) {
                throw new Error("Gemini API key is not provided. Please enter your key.");
            }
            const ai = new GoogleGenAI({apiKey: this.apiKey});
            const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
            
            let html = response.text;
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');       // Italic
            resultDiv.innerHTML = html.replace(/\n/g, '<br>');

        } catch (error) {
            console.error("Gemini AI Analysis Error:", error);
            resultDiv.innerHTML = `<p class="text-red-600">Failed to generate AI analysis: ${error.message}.</p>`;
        } finally {
            btn.innerHTML = originalContent;
            this.updateButtonStates();
        }
    }

    async getAiParameterSuggestions() {
        const goal = this.elements.aiGoalInput.value;
        if (!goal.trim()) {
            alert("Please describe your desired outcome in the text box.");
            return;
        }

        const btn = this.elements.btnGetAiSuggestions;
        const originalContent = btn.innerHTML;
        btn.innerHTML = `<span class="spinner w-5 h-5 !border-white !border-t-transparent mr-2"></span> Thinking...`;
        btn.disabled = true;
        
        const container = this.elements.aiSuggestionsContainer;
        container.innerHTML = `<div class="flex items-center text-sm text-gray-600"><span class="spinner w-4 h-4 !border-t-purple-500 !border-gray-200 mr-2"></span>The AI is analyzing the parameters...</div>`;
        container.classList.remove('hidden');

        try {
            if (!this.apiKey) throw new Error("API key not set.");
            const ai = new GoogleGenAI({ apiKey: this.apiKey });
            const currentParams = this.getCurrentParams();
            const prompt = `
                You are an expert physicist assisting with a 1D Reaction-Diffusion PDE simulator.
                The governing equation is: ∂u/∂t = ν_eff * ∂²u/∂x² + β_NL * u(1-u) - γ_diss * u³.
                - ν_eff (diffusion coefficient): Controls smoothing/viscosity.
                - β_NL (non-linear growth): Controls local growth.
                - γ_diss (cubic damping): Controls dissipation/stabilization.
                - dt (time step): Controls numerical accuracy and stability. A smaller dt is more stable.
                
                The user's desired outcome is: "${goal}"

                The current parameters are:
                - ν_eff: ${currentParams.nu_eff}
                - β_NL: ${currentParams.beta_NL}
                - γ_diss: ${currentParams.gamma_diss}
                - dt: ${currentParams.dt}

                Your task is to suggest adjustments ONLY to ν_eff, β_NL, γ_diss, and dt to help achieve the user's goal.
                Provide your response in the specified JSON format.
            `;
            
            const responseSchema = {
                type: Type.OBJECT,
                properties: {
                    summary: {
                        type: Type.STRING,
                        description: "A brief, high-level summary of the suggested strategy."
                    },
                    suggestions: {
                        type: Type.ARRAY,
                        items: {
                            type: Type.OBJECT,
                            properties: {
                                parameter: { type: Type.STRING, description: "The parameter to change ('nu_eff', 'beta_NL', 'gamma_diss', or 'dt')." },
                                suggestedValue: { type: Type.NUMBER, description: "The new suggested value for the parameter." },
                                reasoning: { type: Type.STRING, description: "A short explanation for why this change will help achieve the user's goal." }
                            },
                            required: ["parameter", "suggestedValue", "reasoning"]
                        }
                    }
                },
                required: ["summary", "suggestions"]
            };

            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: prompt,
                config: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                },
            });
            const jsonText = response.text.trim();
            const result = JSON.parse(jsonText);
            this.aiSuggestions = result.suggestions;
            this.displayAiSuggestions(result);

        } catch (error) {
            console.error("AI Suggestion Error:", error);
            container.innerHTML = `<p class="text-sm text-red-600">Error: ${error.message}</p>`;
        } finally {
            btn.innerHTML = originalContent;
            this.updateButtonStates();
        }
    }

    displayAiSuggestions(result) {
        const container = this.elements.aiSuggestionsContainer;
        if (!result || !result.suggestions) {
            container.innerHTML = `<p class="text-sm text-gray-600">The AI did not provide any suggestions.</p>`;
            return;
        }

        let html = `<p class="text-sm font-semibold text-gray-800 mb-2">Strategy: <span class="font-normal">${result.summary}</span></p>`;
        html += `<div class="space-y-3 mt-3">`;

        const paramMap = {
            'nu_eff': { name: 'Diff. Coefficient (ν_eff)', input: this.elements.inputAlpha },
            'beta_NL': { name: 'Non-linear Growth (β_NL)', input: this.elements.inputBeta },
            'gamma_diss': { name: 'Cubic Damping (γ_diss)', input: this.elements.inputGamma },
            'dt': { name: 'Time Step (dt)', input: this.elements.inputDt }
        };

        result.suggestions.forEach(sugg => {
            const paramInfo = paramMap[sugg.parameter];
            if (!paramInfo) return;
            const currentValue = parseFloat(paramInfo.input.value);
            const suggestedValue = sugg.parameter === 'dt' ? sugg.suggestedValue.toExponential(2) : sugg.suggestedValue.toFixed(2);
            html += `
                <div class="text-xs border-t border-gray-200 pt-2">
                    <p class="font-bold text-gray-700">${paramInfo.name}:</p>
                    <p class="ml-2">Current: ${paramInfo.input.value} &rarr; <strong class="text-purple-700">Suggested: ${suggestedValue}</strong></p>
                    <p class="ml-2 italic text-gray-500">Reason: ${sugg.reasoning}</p>
                </div>
            `;
        });
        html += `</div>`;
        html += `<button id="btnApplyAiSuggestions" class="w-full mt-4 px-3 py-1.5 bg-green-600 text-white text-sm font-semibold rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150">Apply Suggestions</button>`;
        container.innerHTML = html;
        document.getElementById('btnApplyAiSuggestions').onclick = () => this.applyAiSuggestions();
    }

    applyAiSuggestions() {
        if (!this.aiSuggestions) return;

        const paramMap = {
            'nu_eff': { slider: this.elements.paramAlpha, input: this.elements.inputAlpha, fixed: 2 },
            'beta_NL': { slider: this.elements.paramBeta, input: this.elements.inputBeta, fixed: 2 },
            'gamma_diss': { slider: this.elements.paramGamma, input: this.elements.inputGamma, fixed: 2 },
            'dt': { slider: this.elements.paramDt, input: this.elements.inputDt, isLog: true }
        };

        this.aiSuggestions.forEach(sugg => {
            const controls = paramMap[sugg.parameter];
            if (!controls) return;

            const min = parseFloat(controls.slider.min);
            const max = parseFloat(controls.slider.max);
            let value = sugg.suggestedValue;

            if (controls.isLog) {
                const logVal = Math.log10(value);
                const clampedLogVal = Math.max(min, Math.min(max, logVal));
                controls.slider.value = clampedLogVal;
                controls.input.value = Math.pow(10, clampedLogVal).toExponential(2);
            } else {
                const clampedVal = Math.max(min, Math.min(max, value));
                controls.slider.value = clampedVal;
                controls.input.value = clampedVal.toFixed(controls.fixed);
            }
        });
        
        this.updateAllSliderTrackColors();
        this.updateStabilityIndicator();
        this.elements.aiSuggestionsContainer.classList.add('hidden');
        this.currentPresetName = "AI Suggested";
        this.updateParameterStates();
        this.refreshApplication(true);
    }


    saveState() {
        const state = {
            params: this.getCurrentParams(),
            isFinished: this.isSimulationFinished,
            isUnstable: this.simulatorProxy.isUnstable,
            snapshots: this.simulatorProxy.snapshots,
            timeSteps: this.simulatorProxy.timeSteps,
            spectrumSnapshots: this.simulatorProxy.spectrumSnapshots,
        };

        const stateString = JSON.stringify(state, null, 2);
        const blob = new Blob([stateString], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        link.download = `simulation-state-${timestamp}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    loadState(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const state = JSON.parse(e.target.result);
                this.applyState(state);
            } catch (error) {
                alert(`Failed to load state file. Error: ${error.message}`);
                console.error(error);
            }
        };
        reader.readAsText(file);
        event.target.value = ''; // Reset file input
    }

    applyState(state) {
        if (this.isSimulationRunning) {
            this.worker.postMessage({ command: 'stop' });
        }
        
        // Apply parameters to UI
        const p = state.params;
        this.elements.paramL.value = p.L; this.elements.inputL.value = p.L.toFixed(1);
        this.elements.paramN.value = p.N; this.elements.inputN.value = p.N;
        this.elements.paramT.value = p.T; this.elements.inputT.value = p.T.toFixed(1);
        this.elements.paramDt.value = Math.log10(p.dt); this.elements.inputDt.value = p.dt.toExponential(2);
        this.elements.paramAlpha.value = p.nu_eff; this.elements.inputAlpha.value = p.nu_eff.toFixed(2);
        this.elements.paramBeta.value = p.beta_NL; this.elements.inputBeta.value = p.beta_NL.toFixed(2);
        this.elements.paramGamma.value = p.gamma_diss; this.elements.inputGamma.value = p.gamma_diss.toFixed(2);
        this.elements.paramInit.value = p.init_cond;
        this.elements.paramBoundary.value = p.boundary_cond;
        this.elements.customIcFormula.value = p.custom_formula || '';
        this.elements.customIcContainer.classList.toggle('hidden', p.init_cond !== 'custom');

        this.updateAllSliderTrackColors();
        this.updateStabilityIndicator();
        this.currentPresetName = "Loaded State";

        // Reset and re-initialize state
        this.refreshApplication(true);
        this.simulatorProxy = {
            ...this.simulatorProxy, // keep refs to x
            ...p,
            isUnstable: state.isUnstable,
            snapshots: state.snapshots,
            timeSteps: state.timeSteps,
            spectrumSnapshots: state.spectrumSnapshots,
        };

        if (state.isFinished && state.snapshots.length > 0) {
            this.isSimulationFinished = true;
            this.elements.progressBar.style.width = '100%';
            
            // Re-populate metrics
            const lastSnapshot = state.snapshots[state.snapshots.length - 1];
            const metrics = {
                max_value: Math.max(...lastSnapshot),
                min_value: Math.min(...lastSnapshot),
                mean_value: lastSnapshot.reduce((s, v) => s + v, 0) / lastSnapshot.length
            };
            this.elements.metricMaxVal_current.textContent = metrics.max_value.toFixed(4);
            this.elements.metricMinVal_current.textContent = metrics.min_value.toFixed(4);
            this.elements.metricMeanVal_current.textContent = metrics.mean_value.toFixed(4);
            // Full metric history would be too large to save, so we only restore the final view

            // Trigger re-rendering of all final plots
            this.finalizeSimulation();
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new SimulationDashboard();
});
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>