
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1D Fluid Dynamics Analogue Simulator v36</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for plotting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- MathJax Configuration (IMPORTANT for inline LaTeX) -->
    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']] // Configure $ for inline math
          },
          svg: {
            fontCache: 'global' // Optimize font loading
          },
          options: {
            // Explicitly tell MathJax to skip script tags to prevent parsing JavaScript as LaTeX
            skipHtmlTags: ['script', 'noscript', 'textarea', 'pre', 'code', 'annotation', 'annotation-xml'],
            ignoreHtmlClass: 'no-mathjax' // Also ignore elements with this class
          }
        };
    </script>
    <!-- MathJax CDN for LaTeX rendering -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* Custom styles for better slider appearance */
        input[type='range']::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4F46E5; /* Indigo-600 */
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3); /* Indigo-600 with opacity */
            margin-top: -6px; /* Adjust to center thumb on track */
        }
        input[type='range']::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4F46E5;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3);
        }

        /* Dynamic gradient for the slider track */
        input[type='range'] {
            -webkit-appearance: none; /* Override default browser styles */
            appearance: none;
            width: 100%;
            height: 4px; /* Height of the track */
            border-radius: 2px;
            outline: none; /* Remove focus outline */
            background: linear-gradient(to right,
                hsl(120, 60%, 85%) 0%,    /* Light Pastel Green */
                hsl(210, 70%, 75%) 33%,   /* Pastel Blue */
                hsl(270, 80%, 65%) 66%,   /* Pastel Purple */
                hsl(0, 90%, 55%) 100%     /* Pastel Red */
            );
            background-size: var(--slider-value-percent, 0%) 100%; /* Controls the fill amount */
            background-repeat: no-repeat;
            background-color: #E0E7FF; /* Color for the unfilled part of the track */
            transition: background-size 0.1s ease-out; /* Smooth transition for the gradient fill */
        }

        /* Ensure the actual track part is transparent so the input's background shows */
        input[type='range']::-webkit-slider-runnable-track {
            background: transparent;
        }
        input[type='range']::-moz-range-track {
            background: transparent;
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; /* Make space for the icon */
        }

        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            backdrop-filter: blur(5px); /* Blur background */
            -webkit-backdrop-filter: blur(5px); /* Safari support */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto; /* Center vertically and horizontally */
            padding: 20px;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            position: relative;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Spinner for activity indicator */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Pulsing color animation for text/icon */
        @keyframes pulseColor {
            0% { color: white; }
            50% { color: #FECACA; } /* Tailwind red-200 */
            100% { color: white; }
        }

        .pulsing-text {
            animation: pulseColor 1s ease-in-out infinite;
        }

        /* Activity Indicator Positioning */
        #simulationActivityIndicator {
            display: none; /* Hidden by default */
            position: absolute;
            top: 1.5rem; /* Adjust as needed to align with title */
            right: 1.5rem; /* Adjust as needed */
            z-index: 10;
            display: flex; /* Use flexbox for alignment of spinner and percentage */
            align-items: center;
            gap: 0.5rem; /* Space between spinner and percentage */
        }

        /* Adjusted progress bar to end before spinner */
        #progressBar {
            position: absolute; /* Needs to be absolute to control its right edge */
            left: 0;
            top: 0;
            height: 100%; /* Fill the parent container */
            border-radius: 9999px; /* Tailwind rounded-full */
            background-color: #4F46E5; /* Indigo-600 */
            transition: width 0.1s ease-out;
        }
        .progress-bar-container {
            position: relative; /* Make this the positioning context for the absolute progress bar */
            width: 100%;
            height: 0.625rem; /* h-2.5 */
            background-color: #E0E7FF; /* bg-gray-200 */
            border-radius: 9999px; /* rounded-full */
            margin-bottom: 1.5rem; /* mb-6 */
            overflow: hidden; /* Hide overflow of the inner bar */
        }

        /* Styling for the blue and red slashes */
        .slash-blue {
            color: #3B82F6; /* blue-500 */
        }
        .slash-red {
            color: #EF4444; /* red-500 */
        }
        .text-green-600-custom {
            color: #16A34A; /* This is Tailwind's green-600 */
        }
        .text-red-600-custom {
            color: #DC2626; /* This is Tailwind's red-600 */
        }
        .spinner.spinner-completed {
            animation: none; /* Stop the spin animation */
            border-top-color: #10B981 !important; /* Ensure all borders are green-600 */
            border-left-color: #10B981 !important;
            border-right-color: #10B981 !important;
            border-bottom-color: #10B981 !important;
        }

        /* Dynamic Tooltip styles */
        #dynamicTooltip {
            position: absolute;
            background-color: rgba(31, 41, 55, 0.95); /* Gray-800 with opacity */
            color: white;
            padding: 0.5rem 0.75rem; /* p-2 px-3 */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.75rem; /* text-xs */
            line-height: 1rem; /* leading-tight */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            white-space: normal; /* Allow text to wrap */
            max-width: 250px; /* Limit tooltip width */
            z-index: 2000; /* Ensure it's above everything else */
            pointer-events: none; /* Do not block mouse events on elements below */
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            top: -9999px;
            left: -9999px;
        }
        #dynamicTooltip.show {
            opacity: 1;
        }
        
        /* Style for disabled playback controls */
        .playback-disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Tab styles */
        .tab-button.active-tab {
            color: #4f46e5; /* indigo-600 */
            border-bottom-width: 2px;
            border-color: #4f46e5; /* indigo-600 */
        }
        .tab-button.inactive-tab {
            color: #6b7280; /* gray-500 */
            border-bottom-width: 2px;
            border-color: transparent;
        }
        .tab-button.inactive-tab:hover {
            color: #374151; /* gray-700 */
            border-color: #d1d5db; /* gray-300 */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .tooltip-grid { display: grid; grid-template-columns: auto 1fr; gap: 0.25rem 0.75rem; align-items: center; }
        .tooltip-grid-label { font-weight: 600; text-align: right; }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-gray-50 font-sans antialiased text-gray-800 p-4 sm:p-6">

    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-4">
            <h1 class="font-bold tracking-widest text-gray-600" style="font-size: 10pt;"><span style="color: #FF0000;">Q</span> <span style="color: #0000FF;">U</span> A N T U M &nbsp; Q &nbsp; | &nbsp; R E S E A R C H &nbsp;&nbsp; &amp; &nbsp;&nbsp; D E V E L O P M E N T &nbsp;&nbsp; D I V I S I O N &nbsp; | &nbsp; 2 0 2 5 &copy;</h1>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white shadow-lg rounded-xl p-6 sm:p-8 border border-gray-200" id="mainContentArea">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-indigo-700 mb-2">1D Fluid Dynamics Analogue Simulator</h1>
        <p class="text-center text-sm text-red-600 font-semibold mb-8">
            (A 1D Reaction-Diffusion PDE model for conceptual exploration)
        </p>

        <!-- IMPORTANT DISCLAIMER FOR RESEARCH CONTEXT -->
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-8 text-left" role="alert">
            <strong class="font-bold">CRITICAL NOTE FOR RESEARCHERS:</strong>
            <span class="block mt-1">This tool simulates a <strong>1D Reaction-Diffusion Partial Differential Equation (PDE)</strong>. While it demonstrates phenomena analogous to those in fluid dynamics—such as diffusion (viscosity-like effects) and non-linear interactions—it is <strong>fundamentally not a model of the 3D Navier-Stokes equations</strong>.</span>
            <span class="block mt-2">The results from this simulator <strong>cannot</strong> be used to draw direct conclusions about 3D fluid flow or address the Navier-Stokes existence and smoothness conjecture. Its purpose is for the conceptual exploration of 1D pattern formation, wave propagation, and the interplay between diffusion and reaction terms.</span>
            <span class="block mt-4"><strong class="font-bold">BETA SOFTWARE NOTICE:</strong> This application is under active development. While we strive for numerical accuracy for the implemented PDE, bugs or unexpected behaviors may be present. Your use of this tool acknowledges its experimental status.</span>
        </div>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Left Panel: Parameters and Controls -->
            <div class="lg:w-2/5 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-md" id="parameterSection">
                <h2 class="text-2xl font-bold text-gray-700 mb-6">Simulation Parameters</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-4 mb-8">
                    <!-- System Length -->
                    <div>
                        <label for="paramL" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>System Length (L)</p><p class='text-xs mb-2 text-gray-300'>The total spatial extent of the 1D domain for the simulation.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$x \in [0, L]$</p></div>">System Length (L):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramL" min="1" max="50" step="1" value="10" class="w-full">
                            <input type="number" id="inputL" min="1" max="50" step="1" value="10.0" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Grid Points -->
                    <div>
                        <label for="paramN" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Grid Points (N)</p><p class='text-xs mb-2 text-gray-300'>The number of discrete points used to represent the spatial domain. Higher N provides higher spatial resolution.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$\Delta x = L / (N-1)$</p></div>">Grid Points (N):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramN" min="32" max="1024" step="32" value="256" class="w-full">
                            <input type="number" id="inputN" min="32" max="1024" step="32" value="256" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Total Time -->
                    <div>
                        <label for="paramT" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Total Time (T)</p><p class='text-xs mb-2 text-gray-300'>The total duration for which the simulation will run.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$t \in [0, T]$</p></div>">Total Time (T):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramT" min="0.1" max="50" step="0.5" value="5" class="w-full">
                            <input type="number" id="inputT" min="0.1" max="50" step="0.5" value="5.0" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Diffusion Coefficient -->
                    <div>
                        <label for="paramAlpha" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Diffusion Coefficient ($\nu_{eff}$)</p><p class='text-xs mb-2 text-gray-300'>Controls how quickly $u$ spreads out. Higher $\nu_{eff}$ leads to faster smoothing. Analogous to viscosity.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>Term: $\nu_{eff} \frac{\partial^2 u}{\partial x^2}$</p></div>">Diff. Coefficient ($\nu_{eff}$):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramAlpha" min="0.01" max="1" step="0.01" value="0.1" class="w-full">
                            <input type="number" id="inputAlpha" min="0.01" max="1" step="0.01" value="0.10" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Non-linear Growth -->
                    <div>
                        <label for="paramBeta" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Non-linear Growth ($\beta_{NL}$)</p><p class='text-xs mb-2 text-gray-300'>Influences local growth of $u$. The logistic term $u(1-u)$ limits growth as $u$ approaches 1.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>Term: $\beta_{NL} u(1-u)$</p></div>">Non-linear Growth ($\beta_{NL}$):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramBeta" min="0" max="2" step="0.05" value="0.5" class="w-full">
                            <input type="number" id="inputBeta" min="0" max="2" step="0.05" value="0.50" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Cubic Damping -->
                    <div>
                        <label for="paramGamma" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Cubic Damping ($\gamma_{diss}$)</p><p class='text-xs mb-2 text-gray-300'>Represents dissipation that limits growth, especially at high values, often leading to stabilization.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>Term: $-\gamma_{diss} u^3$</p></div>">Cubic Damping ($\gamma_{diss}$):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramGamma" min="0" max="1" step="0.01" value="0.2" class="w-full">
                            <input type="number" id="inputGamma" min="0" max="1" step="0.01" value="0.20" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Initial Condition -->
                    <div class="col-span-full flex flex-col">
                        <label for="paramInit" class="text-sm font-medium text-gray-600 mb-1 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Initial Condition</p><p class='text-xs mb-2 text-gray-300'>The starting profile of the field $u$ at the beginning of the simulation.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$u(x, t=0) = u_0(x)$</p></div>">Initial Condition:</label>
                        <select id="paramInit" class="bg-white block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base h-10">
                            <option value="gaussian">Gaussian</option>
                            <option value="step">Step</option>
                            <option value="random">Random</option>
                            <option value="sine">Sine</option>
                        </select>
                    </div>
                    <!-- Enable Tooltips Checkbox -->
                    <div class="col-span-full flex items-center mt-4">
                        <input type="checkbox" id="enableTooltips" class="form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out rounded-md cursor-pointer">
                        <label for="enableTooltips" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Enable Tooltips</p><p class='text-xs text-gray-300'>Toggle dashboard-wide tooltips for mathematical equations and important labels. Chart hover effects are always active.</p></div>">Enable Equation Tooltips</label>
                    </div>
                </div>

                <!-- Simulation Presets -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Simulation Presets:</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button id="presetDiffusion" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Preset: Pure Diffusion</p><p class='text-xs text-gray-300'>Demonstrates pure diffusion, where the initial profile smooths out over time due to the viscosity-like term. Only the $\nu_{eff}$ term is active.</p></div>">
                            Pure Diffusion
                        </button>
                        <button id="presetGrowthDecay" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Preset: Growth & Decay</p><p class='text-xs text-gray-300'>Highlights non-linear growth and damping terms, showing how values can grow and then stabilize or decay. The $\nu_{eff}$ term is minimized.</p></div>">
                            Growth & Decay
                        </button>
                        <button id="presetWave" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Preset: Propagating Wave</p><p class='text-xs text-gray-300'>Visualizes a traveling wave front, where a step-like initial condition propagates across the domain due to a balance of terms.</p></div>">
                            Propagating Wave
                        </button>
                        <button id="presetPattern" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Preset: Pattern Formation</p><p class='text-xs text-gray-300'>Shows how complex, stable spatial patterns can emerge from a random initial state due to the interplay of all terms.</p></div>">
                            Pattern Formation
                        </button>
                    </div>
                </div>

                <!-- Simulation Controls -->
                <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-3">Simulation Controls:</h3>
                <div class="flex flex-col sm:flex-row justify-around gap-4 mb-4">
                    <button id="btnRun" class="flex-1 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" title="Start Simulation">
                        <span id="btnRunContent" class="flex items-center justify-center">
                            <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.82V9.18a1 1 0 011.555-.832l3.197 2.132a1 1 0 010 1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Simulation
                        </span>
                    </button>
                    <button id="btnPauseResume" class="flex-1 px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition ease-in-out duration-150 opacity-50 cursor-not-allowed h-10" disabled title="Pause Simulation">
                        <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Pause
                    </button>
                </div>
                <div class="flex flex-col sm:flex-row justify-around gap-4">
                    <button id="btnRefresh" class="flex-1 px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" title="Refresh Dashboard">
                        <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004 12c0 2.21.817 4.231 2.105 5.786M20 20v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Refresh
                    </button>
                    <button id="btnExport" class="flex-1 px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition ease-in-out duration-150 opacity-50 cursor-not-allowed h-10" disabled title="Export Data">
                        <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        Export Data
                    </button>
                </div>
                <div class="flex justify-around gap-4 mt-4">
                    <button id="btnHelp" class="flex-1 px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 flex items-center justify-center cursor-pointer" title="How to Interpret the Dashboard">
                        How to Interpret this Dashboard
                    </button>
                </div>
            </div>

            <!-- Right Panel: Live Visualization -->
            <div class="lg:w-3/5 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-md relative">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">Live Simulation <span id="liveSimSubtitle" class="ml-2 text-base font-semibold"></span></h2>
                    <div id="simulationActivityIndicator" class="hidden">
                        <span id="percentageCounter" class="text-sm font-semibold text-gray-700">0%</span>
                        <span class="spinner w-8 h-8 !border-t-green-500 !border-gray-300"></span>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div id="progressBar" class="bg-indigo-600 h-full rounded-full transition-all duration-100 ease-out" style="width: 0%;"></div>
                </div>

                <div class="relative bg-white rounded-lg p-4 shadow-inner border border-gray-300">
                    <canvas id="livePlotCanvas" class="w-full h-64 sm:h-80 cursor-crosshair"></canvas>
                </div>

                <!-- Simulation Playback Controls -->
                <div id="playbackControls" class="mt-6 bg-white rounded-lg p-4 shadow-inner border border-gray-300 playback-disabled">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Simulation Playback</h3>
                    <div class="flex items-center gap-2">
                        <input type="range" id="playbackSlider" min="0" max="1" step="any" value="0" class="w-full" disabled>
                        <button id="btnReplay" class="flex-shrink-0 p-1.5 bg-gray-200 hover:bg-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Play/Pause Replay">
                            <svg id="replayPlayIcon" class="w-4 h-4 text-gray-700" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.204 2.102l-.693.693a6.5 6.5 0 0010.99 2.495l-1.093-.3ZM4.688 8.576a5.5 5.5 0 019.204-2.102l.693-.693a6.5 6.5 0 00-10.99 2.495l1.093.3Z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M5.53 4.843a.75.75 0 011.054.08l1.497 1.684a.75.75 0 11-1.134.996L5.45 5.925a.75.75 0 01.08-1.082Zm9.94 9.227a.75.75 0 01-1.054-.08l-1.497-1.684a.75.75 0 111.134-.996l1.496 1.684a.75.75 0 01-.08 1.082Z" clip-rule="evenodd"/></svg>
                            <svg id="replayPauseIcon" class="w-4 h-4 text-gray-700 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 4.75A.75.75 0 015.75 4h2.5A.75.75 0 019 4.75v10.5A.75.75 0 018.25 16h-2.5A.75.75 0 015 15.25V4.75zm6.5.75A.75.75 0 0010.75 4h2.5a.75.75 0 01.75.75v10.5a.75.75 0 01-.75.75h-2.5a.75.75 0 01-.75-.75V5.5z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span id="playbackCurrentTime">Time: 0.00s</span>
                        <span id="playbackTotalTime">Total: 0.00s</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simulation Metrics Section -->
        <div class="mt-8 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-md">
            <h2 class="text-2xl font-bold text-gray-700 mb-6">Simulation Metrics</h2>
            <div id="metricsContent" class="p-4 bg-white rounded-b-lg shadow-inner border border-gray-300">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-4">
                    <div>
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Max Value ($u_{max}$)</p><p class='text-xs mb-2 text-gray-300'>The maximum value of $u(x,t)$ across the spatial domain at the current time step.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$u_{max}(t) = \max_{x \in [0,L]} u(x,t)$</p></div>">Max Value ($u_{max}$):</h3>
                        <p class="text-gray-600">Current: <span id="metricMaxVal_current" class="font-mono">0.0000</span></p>
                        <p class="text-gray-600">Max Overall: <span id="metricMaxVal_max" class="font-mono">0.0000</span></p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Min Value ($u_{min}$)</p><p class='text-xs mb-2 text-gray-300'>The minimum value of $u(x,t)$ across the spatial domain at the current time step.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$u_{min}(t) = \min_{x \in [0,L]} u(x,t)$</p></div>">Min Value ($u_{min}$):</h3>
                        <p class="text-gray-600">Current: <span id="metricMinVal_current" class="font-mono">0.0000</span></p>
                        <p class="text-gray-600">Min Overall: <span id="metricMinVal_min" class="font-mono">0.0000</span></p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Mean Value ($\overline{u}$)</p><p class='text-xs mb-2 text-gray-300'>The spatial average of $u(x,t)$ at the current time step.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$\overline{u}(t) = \frac{1}{L} \int_0^L u(x,t) dx$</p></div>">Mean Value ($\overline{u}$):</h3>
                        <p class="text-gray-600">Current: <span id="metricMeanVal_current" class="font-mono">0.0000</span></p>
                        <p class="text-gray-600">Max Overall: <span id="metricMeanVal_max" class="font-mono">0.0000</span></p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Standard Deviation ($\sigma_u$)</p><p class='text-xs mb-2 text-gray-300'>Measures the spatial variability of $u(x,t)$ around its mean at the current time step.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$\sigma_u(t) = \sqrt{\frac{1}{L} \int_0^L (u(x,t) - \overline{u}(t))^2 dx}$</p></div>">Standard Deviation ($\sigma_u$):</h3>
                        <p class="text-gray-600">Current: <span id="metricStdDev_current" class="font-mono">0.0000</span></p>
                        <p class="text-gray-600">Max Overall: <span id="metricStdDev_max" class="font-mono">0.0000</span></p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Kurtosis ($\kappa_u$)</p><p class='text-xs mb-2 text-gray-300'>Measures the 'tailedness' of the distribution. High kurtosis indicates the presence of sharp, intermittent peaks or extreme values.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$\kappa_u(t) = \frac{\frac{1}{N}\sum_{i=1}^{N}(u_i - \overline{u})^4}{(\sigma_u^2)^2}$</p></div>">Kurtosis ($\kappa_u$):</h3>
                        <p class="text-gray-600">Current: <span id="metricKurtosis_current" class="font-mono">0.000e+0</span></p>
                        <p class="text-gray-600">Max Overall: <span id="metricKurtosis_max" class="font-mono">0.000e+0</span></p>
                    </div>
                    <div>
                         <h3 class="font-semibold text-gray-700">
                            <span class="cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Energy ($\mathcal{E}$)</p><p class='text-xs mb-2 text-gray-300'>Represents the total 'activity' or 'content' in the system, defined by the L2-norm.</p><p class='font-mono text-center bg-gray-900 rounded p-1 text-sm'>$\mathcal{E}(t) = \int_0^L u(x,t)^2 dx$</p></div>">Energy ($\mathcal{E}$):</span>
                        </h3>
                        <p class="text-gray-600">Current: <span id="metricEnergy_current" class="font-mono">0.0000</span></p>
                        <p class="text-gray-600">Max Overall: <span id="metricEnergy_max" class="font-mono">0.0000</span></p>
                    </div>
                </div>
                <h3 class="font-semibold text-gray-700 mb-2">Time Series Plots:</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative">
                        <canvas id="meanValChartCanvas" class="w-full h-48"></canvas>
                    </div>
                    <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative">
                        <canvas id="energyChartCanvas" class="w-full h-48"></canvas>
                    </div>
                </div>

                <div class="flex flex-col items-center mt-6">
                    <div class="grid grid-cols-2 gap-4 w-full max-w-md">
                        <button id="btnResults" class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" disabled title="Interpret Current Simulation State">
                            <span class="flex items-center justify-center">
                                ✨ Results
                            </span>
                        </button>
                        <button id="btnInterpretKids" class="px-6 py-3 bg-blue-400 text-white font-semibold rounded-lg shadow-md hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" disabled title="Ask Einstein for a simple explanation">
                            <span class="flex items-center justify-center">
                                ✨ Ask Einstein
                            </span>
                        </button>
                        <button id="btnQA" class="px-6 py-3 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" disabled title="Generate Questions & Answers">
                            <span class="flex items-center justify-center">
                                ✨ Q&A
                            </span>
                        </button>
                        <button id="btnConversation" class="px-6 py-3 bg-emerald-500 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:ring-offset-2 transition ease-in-out duration-150 h-10 flex items-center justify-center cursor-pointer" title="Listen to a conversation about Navier-Stokes">
                            Conversation
                        </button>
                        <!-- IMPORTANT: Updated src with the new GitHub Pages audio URL -->
                        <audio id="navierStokesAudio" src="https://quantumq-ai.github.io/QQ_1D_Navier_Stokes_Conjecture_Simulator/NavierStokesConversation.mp3" preload="auto"></audio>
                    </div>
                    <div class="mt-4 w-full max-w-md text-center">
                        <input type="password" id="geminiApiKeyInput" placeholder="Enter Gemini API Key to enable interpretation" class="bg-white w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-sm text-center">
                        <p class="text-xs text-gray-600 mt-2">INTERNET CONNECTION REQUIRED TO USE AI INTEGRATION</p>
                        <a href="#" id="getApiKeyLink" class="font-bold text-blue-600 hover:text-blue-800 text-xs no-underline mt-2 inline-block cursor-pointer">HOW TO ACQUIRE A GEMINI KEY</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis Section (replaces old detailed results) -->
        <div class="mt-8 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-md">
            <h2 class="text-2xl font-bold text-gray-700 mb-6">Detailed Analysis</h2>

            <div class="flex border-b border-gray-200">
                <button id="tabDistribution" class="tab-button active-tab px-4 py-2 text-sm font-medium focus:outline-none transition duration-150 ease-in-out cursor-pointer" data-tab="distributionContent">Distribution Analysis</button>
                <button id="tabSpectrum" class="tab-button inactive-tab px-4 py-2 text-sm font-medium focus:outline-none transition duration-150 ease-in-out cursor-pointer" data-tab="spectrumContent">Power Spectrum</button>
                <button id="tabPhaseSpace" class="tab-button inactive-tab px-4 py-2 text-sm font-medium focus:outline-none transition duration-150 ease-in-out cursor-pointer" data-tab="phaseSpaceContent">Phase Space Portrait</button>
                <button id="tabTimeSpace" class="tab-button inactive-tab px-4 py-2 text-sm font-medium focus:outline-none transition duration-150 ease-in-out cursor-pointer" data-tab="timeSpaceContent">Time-Space Plot</button>
            </div>

            <div id="detailedAnalysisContent" class="p-4 bg-white rounded-b-lg shadow-inner border border-gray-300 min-h-[20rem]">
                <div id="distributionContent" class="tab-content active">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Final State Distribution Plots:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Value Distribution ($u$)</p><p class='text-xs mb-2 text-gray-300'>This histogram shows the distribution of the field value $u$ across all points in the final state.</p></div>">
                            <canvas id="valueDistChartCanvas" class="w-full h-64"></canvas>
                        </div>
                        <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Gradient Distribution ($\partial u / \partial x$)</p><p class='text-xs mb-2 text-gray-300'>Shows the distribution of the first spatial derivative, indicating the prevalence of steep or flat regions.</p></div>">
                            <canvas id="gradientDistChartCanvas" class="w-full h-64"></canvas>
                        </div>
                        <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative cursor-pointer" data-tooltip-content="<div class='text-left'><p class='font-semibold mb-1'>Curvature Distribution ($\partial^2 u / \partial x^2$)</p><p class='text-xs mb-2 text-gray-300'>Shows the distribution of the second spatial derivative, related to the diffusive forces in the system.</p></div>">
                            <canvas id="curvatureDistChartCanvas" class="w-full h-64"></canvas>
                        </div>
                    </div>
                </div>

                <div id="spectrumContent" class="tab-content">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Power Spectrum (at final state)</h3>
                    <p class="text-xs text-gray-600 mb-4">This log-log plot shows how the system's energy is distributed across different spatial frequencies (wavenumbers, k). Peaks indicate dominant spatial patterns.</p>
                    <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative h-96">
                        <canvas id="powerSpectrumChartCanvas"></canvas>
                    </div>
                </div>

                <div id="phaseSpaceContent" class="tab-content">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Phase Space Portrait (at final state)</h3>
                    <p class="text-xs text-gray-600 mb-4">This plot shows the relationship between the field value ($u$) and its gradient ($\partial u / \partial x$). Closed loops, points, or strange attractors in this space can reveal the underlying dynamics of the system.</p>
                    <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative h-96">
                        <canvas id="phaseSpaceChartCanvas"></canvas>
                    </div>
                </div>
                
                <div id="timeSpaceContent" class="tab-content">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Time-Space Evolution (Hovmöller Diagram)</h3>
                    <p class="text-xs text-gray-600 mb-4">This plot shows the entire simulation history at a glance. The horizontal axis is space ($x$), and the vertical axis is time ($t$, flowing downwards). The color at each point represents the value of $u(x,t)$, providing a complete map of how patterns form and evolve.</p>
                    <div class="w-full bg-gray-100 rounded-md border border-gray-300 p-2 relative h-96">
                        <canvas id="timeSpaceChartCanvas"></canvas>
                    </div>
                </div>

                <div id="analysisPlaceholderWrapper" class="active">
                    <p id="analysisPlaceholder" class="text-gray-500 text-center py-8">Run a simulation to see detailed analysis here.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="mt-8 text-center text-xs text-gray-600" style="font-size: 9pt;">
        <p>
            Q U A N T U M &nbsp; Q &nbsp; P T E &nbsp; L T D
            <span class="mx-2">//</span>
            U E N &nbsp; 2 0 2 4 3 3 9 9 2 N
            <span class="mx-2">//</span>
            <a href="mailto:information@quantumq.net" class="text-blue-800 hover:text-indigo-600 cursor-pointer">✉️ E - M A I L</a>
            <span class="mx-2">//</span>
            <a href="#" id="acknowledgementsLink" class="hover:text-indigo-600 cursor-pointer">ACKNOWLEDGEMENTS</a>
            <span class="mx-2">//</span>
            <a href="#" id="legalLink" class="hover:text-indigo-600 cursor-pointer">LEGAL</a>
            <span class="mx-2">//</span>
            2 0 2 5 &copy;
        </p>
    </footer>


    <!-- Modals (Help, Legal, and AI Interpretation) -->
    <div id="interpretationModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">How to Interpret this Dashboard</h2>
            
            <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-4">1. The Big Picture: What is this Simulator?</h3>
            <p class="mb-4 text-gray-700">
                This simulator models a **1D Reaction-Diffusion Partial Differential Equation (PDE)**. It describes how a quantity, $u(x,t)$, changes over time ($t$) and space ($x$) due to two main processes: diffusion (spreading out) and local reactions (growth or decay).
            </p>
            <p class="mb-4 text-gray-700">
                The governing equation is:
                $$ \frac{\partial u}{\partial t} = \nu_{eff} \frac{\partial^2 u}{\partial x^2} + \beta_{NL} u(1-u) - \gamma_{diss} u^3 $$
            </p>
            <div class="mt-4 mb-4 text-red-600 font-semibold border border-red-500 p-3 rounded-md">
                <strong class="underline">CRITICAL NOTE FOR RESEARCHERS:</strong> This is **NOT** a direct model of the 3D Navier-Stokes equations. It's a conceptual tool for exploring phenomena like non-linear dynamics, diffusion, and pattern formation in a simpler 1D context. The results **cannot** be used to draw direct conclusions about 3D fluid flow or the Millennium Prize Problem.
            </div>

            <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">2. Simulation Parameters Explained</h3>
            <ul class="list-disc list-inside ml-4 text-gray-700 space-y-2">
                <li><b>System Length (L) & Grid Points (N):</b> Define the 1D space.</li>
                <li><b>Total Time (T):</b> How long the simulation runs.</li>
                <li><b>Diff. Coefficient ($\nu_{eff}$):</b> Controls diffusion, the tendency for $u$ to smooth out. Analogous to viscosity.</li>
                <li><b>Non-linear Growth ($\beta_{NL}$):</b> The "reaction" part. It makes $u$ grow, but the $u(1-u)$ term limits this growth.</li>
                <li><b>Cubic Damping ($\gamma_{diss}$):</b> An additional dissipation term that removes "energy" from the system, often leading to stabilization.</li>
                <li><b>Initial Condition:</b> The starting shape of $u$ at time $t=0$.</li>
            </ul>

            <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">3. How to Analyze the Plots & Data</h3>
            <p class="text-gray-700">After running a simulation, the "Detailed Analysis" section provides powerful tools:</p>

            <h4 class="text-lg font-semibold text-gray-600 mb-2 mt-4">Distribution Histograms</h4>
            <p class="mb-2 text-gray-700">These plots show the statistical distribution of key quantities at the final simulation time. They reveal the overall character of the solution (e.g., is it mostly zero with a few peaks, or is it highly varied?).</p>

            <h4 class="text-lg font-semibold text-gray-600 mb-2 mt-4">Power Spectrum</h4>
            <p class="mb-2 text-gray-700">This log-log plot shows how the system's "energy" ($u^2$) is distributed across different spatial frequencies (wavenumbers, $k$). It is a powerful tool for analyzing patterns. A sharp peak at a specific $k$ indicates a dominant wavelength in the final pattern. A broad spectrum might indicate chaotic or noisy behavior.</p>

            <h4 class="text-lg font-semibold text-gray-600 mb-2 mt-4">Phase Space Portrait</h4>
            <p class="mb-2 text-gray-700">This plot visualizes the system's state by plotting the field value ($u$) against its spatial derivative ($\partial u / \partial x$). The shape of the resulting curve provides deep insights. For example, a simple point indicates a uniform state, a closed loop can indicate a periodic (wave-like) solution, and more complex shapes can suggest chaotic dynamics or the presence of "attractors."</p>

            <h4 class="text-lg font-semibold text-gray-600 mb-2 mt-4">Time-Space Plot (Hovmöller Diagram)</h4>
            <p class="mb-2 text-gray-700">This visualization provides a complete history of the simulation. It plots space ($x$) horizontally and time ($t$) vertically (flowing downwards). The color at each point shows the value of $u(x,t)$, making it easy to see how patterns travel, grow, or stabilize over the entire simulation run.</p>

            <h4 class="text-lg font-semibold text-gray-600 mb-2 mt-4">Interactive Live Plot</h4>
            <p class="mb-2 text-gray-700">Hover your mouse over the main "Live Simulation" plot. A tooltip will appear, showing you the precise values of $u$ and its first and second derivatives at that specific point in space. This is useful for inspecting sharp gradients or other local features.</p>

            <div id="apiKeyHelpSection">
                <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">4. Acquiring a Gemini API Key</h3>
                <p class="mb-4 text-gray-700">
                    To enable the AI-powered interpretation features (Results, Ask Einstein, Q&A), you need a Gemini API key. You can get a free key from Google AI Studio.
                </p>
                <ol class="list-decimal list-inside ml-4 text-gray-700 space-y-2">
                    <li>Visit the Google AI Studio website: <a href="https://aistudio.google.com/" target="_blank" class="text-blue-600 hover:underline">https://aistudio.google.com/</a></li>
                    <li>Sign in with your Google account.</li>
                    <li>Click the "Get API key" button and create a new API key.</li>
                    <li>Copy the key and paste it into the input box in the "Simulation Metrics" panel.</li>
                </ol>
            </div>

            <div id="acknowledgementsSection">
                <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">5. Acknowledgements</h3>
                <p class="mb-4 text-gray-700">
                    This simulator was built using a combination of powerful open-source technologies. We gratefully acknowledge the creators and maintainers of these projects:
                </p>
                <ul class="list-disc list-inside ml-4 text-gray-700 space-y-3">
                    <li><b>HTML5, CSS3, & JavaScript (ES6+):</b> The fundamental technologies of the web.</li>
                    <li><b>Tailwind CSS:</b> For rapid UI development. (<a href="https://opensource.org/licenses/MIT" target="_blank" class="text-blue-600">MIT License</a>)</li>
                    <li><b>Chart.js:</b> For all data visualizations. (<a href="https://opensource.org/licenses/MIT" target="_blank" class="text-blue-600">MIT License</a>)</li>
                    <li><b>MathJax:</b> For beautiful LaTeX rendering. (<a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" class="text-blue-600">Apache License 2.0</a>)</li>
                    <li><b>Google Gemini:</b> The advanced LLM that powers the AI-driven interpretation features.</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="legalModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Legal Disclaimers & Terms of Use</h2>
            
            <h3 class="text-lg font-semibold text-gray-700 mb-2">1. Experimental Research Tool</h3>
            <p class="mb-4 text-gray-700 text-sm">
                This 1D Fluid Dynamics Analogue Simulator (the "Tool") is provided by Quantum Q PTE. LTD. ("Quantum Q") as an experimental research and educational tool, currently in a beta development phase. It is intended solely for use by the scientific, mathematical, and engineering communities for conceptual exploration and educational purposes. The Tool is not designed, certified, or intended for use in any commercial, industrial, clinical, or mission-critical applications.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">2. No Warranty</h3>
            <p class="mb-4 text-gray-700 text-sm">
                THE TOOL IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND NONINFRINGEMENT. IN NO EVENT SHALL QUANTUM Q, ITS DIRECTORS, EMPLOYEES, OR AFFILIATES BE LIABLE FOR ANY CLAIM, DAMAGES, OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT, OR OTHERWISE, ARISING FROM, OUT OF, OR IN CONNECTION WITH THE TOOL OR THE USE OR OTHER DEALINGS IN THE TOOL.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">3. Limitation of Liability & Risk Assumption</h3>
            <p class="mb-4 text-gray-700 text-sm">
                You expressly understand and agree that Quantum Q, its directors, and its employees shall not be liable for any direct, indirect, incidental, special, consequential, or exemplary damages, including but not limited to, damages for loss of profits, goodwill, use, data, or other intangible losses (even if Quantum Q has been advised of the possibility of such damages), resulting from the use or the inability to use the Tool. The entire risk as to the quality, performance, and accuracy of the Tool is with you. This includes, but is not limited to, any damages or injury caused by any failure of performance, error, omission, interruption, defect, or bug within the software, particularly given its acknowledged experimental and beta status. Should the Tool prove defective, you assume the entire cost of all necessary servicing, repair, or correction, and you agree to indemnify and hold harmless Quantum Q and its employees from any and all claims arising from your use of the Tool.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">4. No Guarantee of Accuracy</h3>
            <p class="mb-4 text-gray-700 text-sm">
                While efforts have been made to ensure the mathematical and numerical integrity of the simulation, Quantum Q makes no guarantee as to the accuracy, reliability, or completeness of the results generated by the Tool. The outputs are for illustrative and conceptual purposes only and should not be used for peer-reviewed publications, engineering design, or any other formal application without independent verification and validation. As stated prominently within the Tool, this simulator is an *analogue* and is not a direct simulation of the 3D Navier-Stokes equations.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">5. Intellectual Property</h3>
            <p class="mb-4 text-gray-700 text-sm">
                All rights, title, and interest in and to the Tool, including its source code, design, and branding, are the exclusive property of Quantum Q PTE. LTD. You may not copy, modify, distribute, sell, or lease any part of our Tool or its included software, nor may you reverse engineer or attempt to extract the source code of that software, unless laws prohibit those restrictions or you have our written permission.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">6. Governing Law & Jurisdiction</h3>
            <p class="mb-4 text-gray-700 text-sm">
                These terms shall be governed by and construed in accordance with the laws of the Republic of Singapore, without regard to its conflict of law provisions. Any disputes arising out of or in connection with these terms shall be subject to the exclusive jurisdiction of the courts of the Republic of Singapore.
            </p>
            
            <h3 class="text-lg font-semibold text-gray-700 mb-2">7. International Applicability and English Law</h3>
            <p class="mb-4 text-gray-700 text-sm">
                While the primary governing law is that of the Republic of Singapore, these terms are intended to be broadly applicable to users globally. For users in jurisdictions where English law is applicable or preferred, these terms shall be interpreted in a manner consistent with the general principles of English contract law, to the extent that such interpretation does not conflict with the mandatory laws of Singapore. The parties acknowledge and agree that the principles of common law and equity, as applied in English law, may be considered in interpreting these terms where Singapore law is silent or where such principles provide additional clarity, provided always that Singapore law remains the ultimate governing law.
            </p>

            <p class="text-gray-600 text-xs italic mt-6">By using this Tool, you acknowledge that you have read, understood, and agree to be bound by these terms and disclaimers.</p>
        </div>
    </div>

    <div id="aiInterpretationModal" class="modal">
        <div class="modal-content w-11/12 md:w-3/4 lg:w-1/2">
            <span class="close-button" id="closeAiInterpretationModal">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">✨ AI Simulation Interpretation</h2>
            <div id="aiInterpretationContent" class="text-gray-700 prose max-w-none">
                <div class="flex justify-center items-center py-8">
                    <span class="spinner w-8 h-8 !border-t-purple-500 !border-gray-200"></span>
                    <span id="aiProgressMessage" class="ml-2 text-gray-600">Generating...</span>
                </div>
            </div>
            <p class="text-sm text-gray-500 mt-4 italic">
                (Interpretation provided by Gemini LLM. It is for conceptual understanding and does not constitute formal scientific analysis.)
            </p>
        </div>
    </div>

    <!-- Dynamic Tooltip Element (Hidden by default) -->
    <div id="dynamicTooltip" class="absolute z-50 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg opacity-0 transition-opacity duration-200 pointer-events-none"></div>
    
    <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://cdn.jsdelivr.net/npm/@google/generative-ai@0.14.0/+esm"
      }
    }
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ==============================================================================
        // UTILITY: 1D FAST FOURIER TRANSFORM
        // ==============================================================================
        const FFT = {
            complex: {
                add: (a, b) => [a[0] + b[0], a[1] + b[1]],
                sub: (a, b) => [a[0] - b[0], a[1] - b[1]],
                mul: (a, b) => [a[0] * b[0] - a[1] * b[1], a[0] * b[1] + a[1] * b[0]],
                exp: (phi) => [Math.cos(phi), Math.sin(phi)],
                abs: (a) => Math.sqrt(a[0] * a[0] + a[1] * a[1]),
            },
            
            _fft: function(x, inverse = false) {
                const N = x.length;
                if (N <= 1) return x;
                const even = this._fft(x.filter((_, i) => i % 2 === 0), inverse);
                const odd = this._fft(x.filter((_, i) => i % 2 === 1), inverse);
                const result = new Array(N);
                const sign = inverse ? 1 : -1;
                for (let k = 0; k < N / 2; k++) {
                    const t = this.complex.mul(this.complex.exp(sign * 2 * Math.PI * k / N), odd[k]);
                    result[k] = this.complex.add(even[k], t);
                    result[k + N / 2] = this.complex.sub(even[k], t);
                }
                return result;
            },

            fft1d: function(realArray, inverse = false) {
                const N = realArray.length;
                const next_power_of_2 = Math.pow(2, Math.ceil(Math.log2(N)));
                const complex_x = new Array(next_power_of_2).fill([0, 0]);
                for(let i = 0; i < N; i++) complex_x[i] = [realArray[i], 0];

                let result = this._fft(complex_x, inverse);

                if (inverse) {
                    for (let i = 0; i < result.length; i++) {
                        result[i][0] /= next_power_of_2;
                        result[i][1] /= next_power_of_2;
                    }
                }
                return result; 
            }
        };

        // ==============================================================================
        // CLASS 1: THE SIMULATION ENGINE
        // ==============================================================================
        class ConjectureSimulator1D {
            constructor(L = 10.0, N = 256, T = 5.0, dt = 0.01,
                        nu_eff = 0.1, beta_NL = 0.5, gamma_diss = 0.2, init_cond = 'gaussian') {
                this.L = L;
                this.N = N;
                this.T = T;
                this.dt = dt;
                this.nu_eff = nu_eff;
                this.beta_NL = beta_NL;
                this.gamma_diss = gamma_diss;
                
                this.x = Array.from({ length: N }, (_, i) => (i / (N - 1)) * L);
                this.dx = this.x[1] - this.x[0];
                
                this.u = new Float64Array(N);
                this.timeSteps = [];
                this.snapshots = [];
                
                this.initializeState(init_cond);
            }

            initializeState(init_cond) {
                const center = this.L / 2;
                const width = this.L / 10;

                if (init_cond === 'gaussian') {
                    for (let i = 0; i < this.N; i++) {
                        this.u[i] = Math.exp(-Math.pow(this.x[i] - center, 2) / (2 * Math.pow(width, 2)));
                    }
                } else if (init_cond === 'step') {
                    this.u.fill(0.0);
                    for (let i = 0; i < this.N; i++) {
                        if (this.x[i] > this.L / 3) this.u[i] = 0.2;
                        if (this.x[i] > 2 * this.L / 3) this.u[i] = 0.8;
                    }
                } else if (init_cond === 'random') {
                    for (let i = 0; i < this.N; i++) {
                        this.u[i] = Math.max(0, Math.min(1, 0.5 + 0.1 * (Math.random() * 2 - 1)));
                    }
                } else if (init_cond === 'sine') {
                    for (let i = 0; i < this.N; i++) {
                        this.u[i] = 0.5 * (1 + Math.sin(4 * Math.PI * this.x[i] / this.L));
                    }
                }
                
                this.snapshots.push(Array.from(this.u));
                this.timeSteps.push(0.0);
            }

            diffusionTerm(u_array = this.u) {
                const u_xx = this.calculate_d2u_dx2(u_array);
                return Array.from(u_xx).map(val => this.nu_eff * val);
            }

            reactionTerm(u_array = this.u) {
                return Array.from(u_array).map(val => this.beta_NL * val * (1 - val) - this.gamma_diss * Math.pow(val, 3));
            }

            step() {
                const du_dt_diff = this.diffusionTerm();
                const du_dt_react = this.reactionTerm();
                
                for (let i = 0; i < this.N; i++) {
                    this.u[i] += (du_dt_diff[i] + du_dt_react[i]) * this.dt;
                }
                 // Clamp values to a reasonable range to prevent numerical instability
                for (let i = 0; i < this.N; i++) {
                    this.u[i] = Math.max(-10, Math.min(10, this.u[i]));
                }
            }

            analyzeResults(u_array = this.u) {
                const current_state = u_array;
                const N = current_state.length;
                if (N === 0) return { max_value: 0, min_value: 0, mean_value: 0, std_dev: 0, energy: 0, kurtosis: 0 };
                
                const max_value = Math.max(...current_state);
                const min_value = Math.min(...current_state);
                const mean_value = current_state.reduce((sum, val) => sum + val, 0) / N;
                
                const sqDiffs = current_state.map(val => Math.pow(val - mean_value, 2));
                const std_dev = Math.sqrt(sqDiffs.reduce((sum, val) => sum + val, 0) / N);

                let energy = 0;
                for (let i = 0; i < N - 1; i++) {
                    energy += (current_state[i] * current_state[i] + current_state[i+1] * current_state[i+1]) / 2 * this.dx;
                }

                let kurtosis = 0;
                if (std_dev > 1e-9) {
                    const m4 = current_state.map(val => Math.pow(val - mean_value, 4)).reduce((sum, val) => sum + val, 0) / N;
                    kurtosis = m4 / Math.pow(std_dev, 4);
                }

                return { max_value, min_value, mean_value, std_dev, energy, kurtosis };
            }

            exportData() {
                let csvContent = "time," + this.x.map(val => `x_${val.toFixed(4)}`).join(",") + "\n";
                this.snapshots.forEach((snapshot, index) => {
                    const time = this.timeSteps[index].toFixed(4);
                    csvContent += `${time},${snapshot.map(val => val.toFixed(6)).join(",")}\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = "simulation_results.csv";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            calculate_du_dx(u_array) {
                const du_dx = new Float64Array(this.N);
                for (let i = 0; i < this.N; i++) {
                    const u_prev = u_array[(i - 1 + this.N) % this.N];
                    const u_next = u_array[(i + 1) % this.N];
                    du_dx[i] = (u_next - u_prev) / (2 * this.dx);
                }
                return du_dx;
            }

            calculate_d2u_dx2(u_array) {
                const d2u_dx2 = new Float64Array(this.N);
                for (let i = 0; i < this.N; i++) {
                    const u_prev = u_array[(i - 1 + this.N) % this.N];
                    const u_next = u_array[(i + 1) % this.N];
                    d2u_dx2[i] = (u_next - 2 * u_array[i] + u_prev) / (this.dx * this.dx);
                }
                return d2u_dx2;
            }
        }

        // ==============================================================================
        // CLASS 2: THE INTERACTIVE DASHBOARD
        // ==============================================================================
        class SimulationDashboard {
            constructor() {
                this.simulator = null;
                this.liveChart = null;
                this.meanValChart = null;
                this.energyChart = null;
                
                this.geminiApiKey = "";
                this.isSimulationRunning = false;
                this.isSimulationPaused = false;
                this.isSimulationFinished = false;
                this.replayAnimationTimer = null;
                this.currentSimStep = 0;
                this.currentPresetName = "Custom";
                this.tooltipsEnabled = false;
                this.animationFrameId = null;

                this.meanValueHistory = [];
                this.energyHistory = [];
                this.timeLabels = [];
                this.maxMaxVal = -Infinity;
                this.minMinVal = Infinity;
                this.maxMeanVal = -Infinity;
                this.maxStdDev = -Infinity;
                this.maxEnergy = -Infinity;
                this.maxKurtosis = -Infinity;

                this.charts = {};

                this.elements = {
                    paramL: document.getElementById('paramL'), paramN: document.getElementById('paramN'), paramT: document.getElementById('paramT'),
                    paramAlpha: document.getElementById('paramAlpha'), paramBeta: document.getElementById('paramBeta'), paramGamma: document.getElementById('paramGamma'),
                    inputL: document.getElementById('inputL'), inputN: document.getElementById('inputN'), inputT: document.getElementById('inputT'),
                    inputAlpha: document.getElementById('inputAlpha'), inputBeta: document.getElementById('inputBeta'), inputGamma: document.getElementById('inputGamma'),
                    paramInit: document.getElementById('paramInit'),
                    btnRun: document.getElementById('btnRun'), btnRunContent: document.getElementById('btnRunContent'), btnPauseResume: document.getElementById('btnPauseResume'),
                    btnRefresh: document.getElementById('btnRefresh'), btnExport: document.getElementById('btnExport'), btnHelp: document.getElementById('btnHelp'),
                    btnResults: document.getElementById('btnResults'), btnInterpretKids: document.getElementById('btnInterpretKids'), btnQA: document.getElementById('btnQA'),
                    btnConversation: document.getElementById('btnConversation'), navierStokesAudio: document.getElementById('navierStokesAudio'),
                    geminiApiKeyInput: document.getElementById('geminiApiKeyInput'),
                    progressBar: document.getElementById('progressBar'), livePlotCanvas: document.getElementById('livePlotCanvas'),
                    interpretationModal: document.getElementById('interpretationModal'), legalModal: document.getElementById('legalModal'),
                    closeModalButtons: document.querySelectorAll('.modal .close-button'),
                    aiInterpretationModal: document.getElementById('aiInterpretationModal'), closeAiInterpretationModal: document.getElementById('closeAiInterpretationModal'),
                    aiInterpretationContent: document.getElementById('aiInterpretationContent'), aiProgressMessage: document.getElementById('aiProgressMessage'),
                    legalLink: document.getElementById('legalLink'), acknowledgementsLink: document.getElementById('acknowledgementsLink'), getApiKeyLink: document.getElementById('getApiKeyLink'),
                    metricMaxVal_current: document.getElementById('metricMaxVal_current'), metricMaxVal_max: document.getElementById('metricMaxVal_max'),
                    metricMinVal_current: document.getElementById('metricMinVal_current'), metricMinVal_min: document.getElementById('metricMinVal_min'),
                    metricMeanVal_current: document.getElementById('metricMeanVal_current'), metricMeanVal_max: document.getElementById('metricMeanVal_max'),
                    metricStdDev_current: document.getElementById('metricStdDev_current'), metricStdDev_max: document.getElementById('metricStdDev_max'),
                    metricKurtosis_current: document.getElementById('metricKurtosis_current'), metricKurtosis_max: document.getElementById('metricKurtosis_max'),
                    metricEnergy_current: document.getElementById('metricEnergy_current'), metricEnergy_max: document.getElementById('metricEnergy_max'),
                    meanValChartCanvas: document.getElementById('meanValChartCanvas'), energyChartCanvas: document.getElementById('energyChartCanvas'),
                    presetDiffusion: document.getElementById('presetDiffusion'), presetGrowthDecay: document.getElementById('presetGrowthDecay'),
                    presetWave: document.getElementById('presetWave'), presetPattern: document.getElementById('presetPattern'),
                    simulationActivityIndicator: document.getElementById('simulationActivityIndicator'), percentageCounter: document.getElementById('percentageCounter'),
                    liveSimSubtitle: document.getElementById('liveSimSubtitle'),
                    playbackControls: document.getElementById('playbackControls'), playbackSlider: document.getElementById('playbackSlider'),
                    playbackCurrentTime: document.getElementById('playbackCurrentTime'), playbackTotalTime: document.getElementById('playbackTotalTime'),
                    btnReplay: document.getElementById('btnReplay'), replayPlayIcon: document.getElementById('replayPlayIcon'), replayPauseIcon: document.getElementById('replayPauseIcon'),
                    enableTooltips: document.getElementById('enableTooltips'), dynamicTooltip: document.getElementById('dynamicTooltip'), mainContentArea: document.getElementById('mainContentArea'),
                    tabDistribution: document.getElementById('tabDistribution'), tabSpectrum: document.getElementById('tabSpectrum'), tabPhaseSpace: document.getElementById('tabPhaseSpace'), tabTimeSpace: document.getElementById('tabTimeSpace'),
                    distributionContent: document.getElementById('distributionContent'), spectrumContent: document.getElementById('spectrumContent'), phaseSpaceContent: document.getElementById('phaseSpaceContent'), timeSpaceContent: document.getElementById('timeSpaceContent'),
                    analysisPlaceholderWrapper: document.getElementById('analysisPlaceholderWrapper'),
                    valueDistChartCanvas: document.getElementById('valueDistChartCanvas'),
                    gradientDistChartCanvas: document.getElementById('gradientDistChartCanvas'),
                    curvatureDistChartCanvas: document.getElementById('curvatureDistChartCanvas'),
                    powerSpectrumChartCanvas: document.getElementById('powerSpectrumChartCanvas'),
                    phaseSpaceChartCanvas: document.getElementById('phaseSpaceChartCanvas'),
                    timeSpaceChartCanvas: document.getElementById('timeSpaceChartCanvas')
                };

                this._boundHandleTooltipShow = this.handleTooltipShow.bind(this);
                this._boundHandleTooltipHide = this.handleTooltipHide.bind(this);
                this._boundHandleLivePlotHover = this.handleLivePlotHover.bind(this);
                this._boundHandleLivePlotLeave = this.handleLivePlotLeave.bind(this);

                this.setupEventListeners();
                this.updateAllSliderTrackColors();
                this.initializeCharts();
                this.refreshApplication();
            }
            
            setupSync(sliderId, inputId, fixedPoints = 0) {
                const slider = this.elements[sliderId];
                const input = this.elements[inputId];
                slider.oninput = () => {
                    input.value = parseFloat(slider.value).toFixed(fixedPoints);
                    this.updateSliderTrackColor(slider);
                    this.currentPresetName = "Custom";
                    this.updateLiveSimulationTitle();
                };
                input.onchange = () => {
                    let value = parseFloat(input.value);
                    const min = parseFloat(slider.min);
                    const max = parseFloat(slider.max);
                    if (isNaN(value)) value = min;
                    value = Math.max(min, Math.min(max, value));
                    slider.value = value;
                    input.value = value.toFixed(fixedPoints);
                    this.updateSliderTrackColor(slider);
                    this.currentPresetName = "Custom";
                    this.updateLiveSimulationTitle();
                };
            }

            updateSliderTrackColor(sliderElement) {
                if (!sliderElement) return;
                const value = parseFloat(sliderElement.value);
                const min = parseFloat(sliderElement.min);
                const max = parseFloat(sliderElement.max);
                const percentage = ((value - min) / (max - min)) * 100;
                sliderElement.style.setProperty('--slider-value-percent', `${percentage}%`);
            }
            
            updateAllSliderTrackColors() {
                ['paramL', 'paramN', 'paramT', 'paramAlpha', 'paramBeta', 'paramGamma', 'playbackSlider'].forEach(id => {
                    this.updateSliderTrackColor(this.elements[id]);
                });
            }

            setupEventListeners() {
                this.setupSync('paramL', 'inputL', 1);
                this.setupSync('paramN', 'inputN', 0);
                this.setupSync('paramT', 'inputT', 1);
                this.setupSync('paramAlpha', 'inputAlpha', 2);
                this.setupSync('paramBeta', 'inputBeta', 2);
                this.setupSync('paramGamma', 'inputGamma', 2);

                if (this.elements.paramInit) this.elements.paramInit.onchange = () => {
                    this.currentPresetName = "Custom";
                    this.updateLiveSimulationTitle();
                };

                this.elements.btnRun.onclick = () => this.handleRunStop();
                this.elements.btnPauseResume.onclick = () => this.handlePauseResume();
                this.elements.btnRefresh.onclick = () => this.refreshApplication(false);
                this.elements.btnExport.onclick = () => this.exportData();
                this.elements.btnHelp.onclick = () => this.showModal('interpretationModal');
                this.elements.btnResults.onclick = () => this.interpretSimulationState();
                this.elements.btnInterpretKids.onclick = () => this.interpretSimulationStateForKids();
                this.elements.btnQA.onclick = () => this.generateQA();
                this.elements.btnConversation.onclick = () => this.playConversationAudio();
                this.elements.geminiApiKeyInput.oninput = () => this.validateAndSetApiKey();
                
                [this.elements.tabDistribution, this.elements.tabSpectrum, this.elements.tabPhaseSpace, this.elements.tabTimeSpace].forEach(tab => {
                    if(tab) tab.onclick = (e) => this.switchTab(e.currentTarget);
                });
                
                this.elements.closeModalButtons.forEach(btn => btn.onclick = () => this.hideAllModals());
                
                const setupLink = (linkId, modalId, sectionId) => {
                    const linkElement = document.getElementById(linkId);
                    linkElement.onclick = (e) => {
                        e.preventDefault(); this.showModal(modalId, sectionId);
                    };
                };

                setupLink('getApiKeyLink', 'interpretationModal', 'apiKeyHelpSection');
                setupLink('acknowledgementsLink', 'interpretationModal', 'acknowledgementsSection');
                this.elements.legalLink.onclick = (e) => { e.preventDefault(); this.showModal('legalModal'); };
                window.onclick = (event) => { if (event.target.classList.contains('modal')) this.hideAllModals(); };

                this.elements.presetDiffusion.onclick = () => this.applyPreset({ name: 'Pure Diffusion', L: 10.0, N: 256, T: 10.0, nu_eff: 0.5, beta_NL: 0.0, gamma_diss: 0.0, init_cond: 'gaussian' });
                this.elements.presetGrowthDecay.onclick = () => this.applyPreset({ name: 'Growth and Decay', L: 10.0, N: 256, T: 15.0, nu_eff: 0.01, beta_NL: 1.0, gamma_diss: 0.5, init_cond: 'random' });
                this.elements.presetWave.onclick = () => this.applyPreset({ name: 'Propagating Wave', L: 20.0, N: 512, T: 20.0, nu_eff: 0.05, beta_NL: 0.8, gamma_diss: 0.1, init_cond: 'step' });
                this.elements.presetPattern.onclick = () => this.applyPreset({ name: 'Pattern Formation', L: 30.0, N: 768, T: 30.0, nu_eff: 0.02, beta_NL: 1.5, gamma_diss: 0.3, init_cond: 'random' });

                this.elements.playbackSlider.oninput = () => this.handlePlaybackScrub();
                this.elements.btnReplay.onclick = () => this.toggleReplayAnimation();

                this.elements.enableTooltips.onchange = (e) => {
                    this.tooltipsEnabled = e.target.checked;
                    if (!this.tooltipsEnabled) this.handleTooltipHide();
                };
                this.elements.mainContentArea.addEventListener('mouseover', this._boundHandleTooltipShow);
                this.elements.mainContentArea.addEventListener('mouseout', this._boundHandleTooltipHide);
                this.elements.mainContentArea.addEventListener('mousemove', this._boundHandleTooltipShow);

                this.elements.livePlotCanvas.addEventListener('mousemove', this._boundHandleLivePlotHover);
                this.elements.livePlotCanvas.addEventListener('mouseleave', this._boundHandleLivePlotLeave);
            }

            async handleTooltipShow(event) {
                if (!this.tooltipsEnabled) return;
                const tooltipHost = event.target.closest('[data-tooltip-content]');
                if (!tooltipHost) return;
                
                const tooltip = this.elements.dynamicTooltip;
                tooltip.innerHTML = tooltipHost.dataset.tooltipContent;
                if (window.MathJax?.typesetPromise) await window.MathJax.typesetPromise([tooltip]);

                const hostRect = tooltipHost.getBoundingClientRect();
                const tooltipWidth = tooltip.offsetWidth;
                const tooltipHeight = tooltip.offsetHeight;
                let left = window.scrollX + hostRect.left + (hostRect.width / 2) - (tooltipWidth / 2);
                let top = window.scrollY + hostRect.top - tooltipHeight - 5;
                if (left < window.scrollX + 5) left = window.scrollX + 5;
                if ((left + tooltipWidth) > (window.scrollX + window.innerWidth - 5)) left = window.scrollX + window.innerWidth - tooltipWidth - 5;
                if (top < window.scrollY + 5) top = window.scrollY + hostRect.bottom + 5;
                tooltip.style.left = `${left}px`;
                tooltip.style.top = `${top}px`;
                tooltip.classList.add('show');
            }
    
            handleTooltipHide() {
                this.elements.dynamicTooltip.classList.remove('show');
            }

            handleLivePlotHover(event) {
                if (!this.liveChart || !this.simulator) return;
            
                const canvas = this.elements.livePlotCanvas;
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const index = Math.round(this.liveChart.scales.x.getValueForPixel(x));
            
                if (index < 0 || index >= this.simulator.N) {
                    this.handleLivePlotLeave();
                    return;
                }
            
                const currentU = this.liveChart.data.datasets[0].data;
                const u_val = currentU[index];
                const du_dx_val = this.simulator.calculate_du_dx(currentU)[index];
                const d2u_dx2_val = this.simulator.calculate_d2u_dx2(currentU)[index];
            
                this.liveChart.update('none'); // Redraw to clear old line
                const ctx = this.liveChart.ctx;
                const chartArea = this.liveChart.chartArea;
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(this.liveChart.scales.x.getPixelForValue(index), chartArea.top);
                ctx.lineTo(this.liveChart.scales.x.getPixelForValue(index), chartArea.bottom);
                ctx.lineWidth = 1;
                ctx.strokeStyle = 'rgba(239, 68, 68, 0.7)'; // red-500
                ctx.stroke();
                ctx.restore();
            
                const tooltip = this.elements.dynamicTooltip;
                tooltip.innerHTML = `
                    <div class="tooltip-grid">
                        <span class="tooltip-grid-label">x:</span> <span>${this.simulator.x[index].toFixed(2)}</span>
                        <span class="tooltip-grid-label">u:</span> <span>${u_val.toExponential(3)}</span>
                        <span class="tooltip-grid-label">u<sub>x</sub>:</span> <span>${du_dx_val.toExponential(3)}</span>
                        <span class="tooltip-grid-label">u<sub>xx</sub>:</span> <span>${d2u_dx2_val.toExponential(3)}</span>
                    </div>
                `;
                tooltip.style.left = `${event.pageX + 15}px`;
                tooltip.style.top = `${event.pageY + 15}px`;
                tooltip.classList.add('show');
            }
            
            handleLivePlotLeave() {
                if (this.liveChart) this.liveChart.update('none');
                this.elements.dynamicTooltip.classList.remove('show');
            }

            applyPreset(presetConfig) {
                if (this.isSimulationRunning) this.finalizeSimulation();

                this.elements.paramL.value = presetConfig.L; this.elements.inputL.value = presetConfig.L.toFixed(1);
                this.elements.paramN.value = presetConfig.N; this.elements.inputN.value = presetConfig.N;
                this.elements.paramT.value = presetConfig.T; this.elements.inputT.value = presetConfig.T.toFixed(1);
                this.elements.paramAlpha.value = presetConfig.nu_eff; this.elements.inputAlpha.value = presetConfig.nu_eff.toFixed(2);
                this.elements.paramBeta.value = presetConfig.beta_NL; this.elements.inputBeta.value = presetConfig.beta_NL.toFixed(2);
                this.elements.paramGamma.value = presetConfig.gamma_diss; this.elements.inputGamma.value = presetConfig.gamma_diss.toFixed(2);
                this.elements.paramInit.value = presetConfig.init_cond;

                this.updateAllSliderTrackColors();
                this.currentPresetName = presetConfig.name;
                this.refreshApplication(true);
                this.handleRunStop();
            }

            initializeCharts() {
                const createChart = (canvasId, chartVar, config) => {
                    const canvas = this.elements[canvasId];
                    if (!canvas) return;
                    if (this.charts[chartVar]) this.charts[chartVar].destroy();
                    this.charts[chartVar] = new Chart(canvas.getContext('2d'), config);
                };

                createChart('livePlotCanvas', 'liveChart', {
                    type: 'line',
                    data: { labels: [], datasets: [{ label: 'u(x,t)', data: [], borderColor: 'rgb(79, 70, 229)', borderWidth: 2, pointRadius: 0, tension: 0.1 }] },
                    options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: { title: { display: true, text: 'Position (x)' }, type: 'linear', beginAtZero: true }, y: { title: { display: true, text: 'u(x,t)' }, min: -0.2, max: 1.2 } }, plugins: { legend: { display: false }, title: { display: true, text: 'Live Simulation' } } }
                });
                createChart('meanValChartCanvas', 'meanValChart', {
                    type: 'line', data: { labels: [], datasets: [{ label: 'Mean Value', data: [], borderColor: '#10B981', borderWidth: 2, pointRadius: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Time (t)' } }, y: { title: { display: true, text: 'Mean Value' } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Mean Value vs. Time' } } }
                });
                createChart('energyChartCanvas', 'energyChart', {
                    type: 'line', data: { labels: [], datasets: [{ label: 'Energy', data: [], borderColor: '#F59E0B', borderWidth: 2, pointRadius: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Time (t)' } }, y: { title: { display: true, text: 'Energy' }, type: 'logarithmic' } }, plugins: { legend: { display: false }, title: { display: true, text: 'Energy vs. Time' } } }
                });
                
                // Init empty analysis charts
                const createBarChart = (canvasId, chartVar, label) => createChart(canvasId, chartVar, {
                    type: 'bar', data: { labels: [], datasets: [{ label, data: [], backgroundColor: 'rgba(79, 70, 229, 0.6)' }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Value Bins' } }, y: { title: { display: true, text: 'Frequency' }, beginAtZero: true } }, plugins: { legend: { display: false }, title: {display: true, text: label} } }
                });
                createBarChart('valueDistChartCanvas', 'valueDistChart', 'Value Distribution (u)');
                createBarChart('gradientDistChartCanvas', 'gradientDistChart', 'Gradient Distribution (du/dx)');
                createBarChart('curvatureDistChartCanvas', 'curvatureDistChart', 'Curvature Distribution (d2u/dx2)');

                createChart('powerSpectrumChartCanvas', 'powerSpectrumChart', {
                    type: 'line', data: { datasets: [{ label: 'Power Spectrum', data: [], backgroundColor: '#4F46E5', showLine: true }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'logarithmic', title: { display: true, text: 'Wavenumber k' } }, y: { type: 'logarithmic', title: { display: true, text: 'Power' } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Power Spectrum' } } }
                });
                createChart('phaseSpaceChartCanvas', 'phaseSpaceChart', {
                    type: 'scatter', data: { datasets: [{ label: 'Phase Space', data: [], backgroundColor: 'rgba(79, 70, 229, 0.6)', pointRadius: 1, showLine: false }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'u(x)' } }, y: { title: { display: true, text: 'du/dx' } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Phase Space Portrait' } } }
                });
                if (this.elements.timeSpaceChartCanvas) {
                    const ctx = this.elements.timeSpaceChartCanvas.getContext('2d');
                    ctx.clearRect(0, 0, this.elements.timeSpaceChartCanvas.width, this.elements.timeSpaceChartCanvas.height);
                }
            }

            updateMetricsDisplay(u_array = this.simulator.u, time = this.simulator.timeSteps.slice(-1)[0]) {
                if (!this.simulator) return;
                const currentResults = this.simulator.analyzeResults(u_array);
                this.meanValueHistory.push(currentResults.mean_value);
                this.energyHistory.push(currentResults.energy);
                this.timeLabels.push(time);
                
                this.maxMaxVal = Math.max(this.maxMaxVal, currentResults.max_value);
                this.minMinVal = Math.min(this.minMinVal, currentResults.min_value);
                this.maxMeanVal = Math.max(this.maxMeanVal, currentResults.mean_value);
                this.maxStdDev = Math.max(this.maxStdDev, currentResults.std_dev);
                this.maxEnergy = Math.max(this.maxEnergy, currentResults.energy);
                this.maxKurtosis = Math.max(this.maxKurtosis, currentResults.kurtosis);

                const updateMetric = (id, val, format = 'exp') => {
                    this.elements[id].textContent = format === 'exp' ? val.toExponential(3) : val.toFixed(4);
                };
                updateMetric('metricMaxVal_current', currentResults.max_value, 'fixed'); updateMetric('metricMaxVal_max', this.maxMaxVal, 'fixed');
                updateMetric('metricMinVal_current', currentResults.min_value, 'fixed'); updateMetric('metricMinVal_min', this.minMinVal, 'fixed');
                updateMetric('metricMeanVal_current', currentResults.mean_value, 'fixed'); updateMetric('metricMeanVal_max', this.maxMeanVal, 'fixed');
                updateMetric('metricStdDev_current', currentResults.std_dev, 'fixed'); updateMetric('metricStdDev_max', this.maxStdDev, 'fixed');
                updateMetric('metricKurtosis_current', currentResults.kurtosis); updateMetric('metricKurtosis_max', this.maxKurtosis);
                updateMetric('metricEnergy_current', currentResults.energy, 'fixed'); updateMetric('metricEnergy_max', this.maxEnergy, 'fixed');
                this.updateTimeSeriesCharts();
            }

            resetMetricsDisplay() {
                this.meanValueHistory = []; this.energyHistory = []; this.timeLabels = [];
                this.maxMaxVal = -Infinity; this.minMinVal = Infinity;
                this.maxMeanVal = -Infinity; this.maxStdDev = -Infinity; this.maxEnergy = -Infinity;
                this.maxKurtosis = -Infinity;
                Object.keys(this.elements).filter(k => k.startsWith('metric')).forEach(id => {
                     if (id.includes('Kurtosis')) {
                        this.elements[id].textContent = '0.000e+0';
                     } else {
                        this.elements[id].textContent = '0.0000';
                     }
                });
            }

            updateTimeSeriesCharts() {
                if (this.charts.meanValChart) {
                    this.charts.meanValChart.data.labels = this.timeLabels;
                    this.charts.meanValChart.data.datasets[0].data = this.meanValueHistory;
                    this.charts.meanValChart.update('none');
                }
                if (this.charts.energyChart) {
                    this.charts.energyChart.data.labels = this.timeLabels;
                    this.charts.energyChart.data.datasets[0].data = this.energyHistory;
                    this.charts.energyChart.update('none');
                }
            }

            updateButtonStates() {
                const setButtonState = (btn, enabled) => {
                    if (btn) { btn.disabled = !enabled; btn.classList.toggle('opacity-50', !enabled); btn.classList.toggle('cursor-not-allowed', !enabled); }
                };
                const parameterControls = Object.keys(this.elements).filter(k => k.startsWith('param') || k.startsWith('input'));
                const presetButtons = Object.keys(this.elements).filter(k => k.startsWith('preset'));
                const canInterpret = this.isSimulationFinished && this.geminiApiKey.length > 0;
            
                const setGroupState = (keys, enabled) => keys.forEach(key => setButtonState(this.elements[key], enabled));

                if (this.isSimulationRunning) {
                    setButtonState(this.elements.btnRun, true); setButtonState(this.elements.btnPauseResume, true);
                    setButtonState(this.elements.btnRefresh, false); setButtonState(this.elements.btnExport, false);
                    setGroupState(parameterControls, false); setGroupState(presetButtons, false);
                    this.elements.playbackControls.classList.add('playback-disabled');
                } else if (this.isSimulationFinished) {
                    setButtonState(this.elements.btnRun, false); setButtonState(this.elements.btnPauseResume, false);
                    setButtonState(this.elements.btnRefresh, true); setButtonState(this.elements.btnExport, true);
                    setGroupState(parameterControls, false); setGroupState(presetButtons, false);
                    this.elements.playbackControls.classList.remove('playback-disabled');
                } else {
                    setButtonState(this.elements.btnRun, true); setButtonState(this.elements.btnPauseResume, false);
                    setButtonState(this.elements.btnRefresh, true); setButtonState(this.elements.btnExport, false);
                    setGroupState(parameterControls, true); setGroupState(presetButtons, true);
                    this.elements.playbackControls.classList.add('playback-disabled');
                }
                setButtonState(this.elements.btnResults, canInterpret);
                setButtonState(this.elements.btnInterpretKids, canInterpret);
                setButtonState(this.elements.btnQA, canInterpret);
                setButtonState(this.elements.btnReplay, this.isSimulationFinished);

                this.updateLiveSimulationTitle();
                this.elements.btnRun.classList.toggle('bg-red-600', this.isSimulationRunning); this.elements.btnRun.classList.toggle('hover:bg-red-700', this.isSimulationRunning);
                this.elements.btnRun.classList.toggle('bg-indigo-600', !this.isSimulationRunning); this.elements.btnRun.classList.toggle('hover:bg-indigo-700', !this.isSimulationRunning);
                this.elements.btnRunContent.classList.toggle('pulsing-text', this.isSimulationRunning && !this.isSimulationPaused);
                this.elements.btnRunContent.innerHTML = this.isSimulationRunning ? `<svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9 10h6v4H9v-4z"></path></svg> Stop` : `<svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.82V9.18a1 1 0 011.555-.832l3.197 2.132a1 1 0 010 1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Simulation`;
                this.elements.btnPauseResume.innerHTML = this.isSimulationPaused ? `<svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168L10 9.18v5.64l4.752-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Resume` : `<svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Pause`;
            }
            
            finalizeSimulation() {
                this.isSimulationRunning = false;
                this.isSimulationFinished = true;
                if (this.replayAnimationTimer) this.toggleReplayAnimation();
                this.updateButtonStates();
                this.showDetailedAnalysis();
                const slider = this.elements.playbackSlider;
                slider.max = this.simulator.T;
                slider.value = this.currentSimStep * this.simulator.dt;
                this.elements.playbackCurrentTime.textContent = `Time: ${(this.currentSimStep * this.simulator.dt).toFixed(2)}s`;
                this.elements.playbackTotalTime.textContent = `Total: ${this.simulator.T.toFixed(2)}s`;
                this.updateSliderTrackColor(slider);
            }

            animationStep() {
                if (this.isSimulationPaused || !this.isSimulationRunning) {
                     if (this.isSimulationRunning) this.animationFrameId = requestAnimationFrame(this.animationStep.bind(this));
                     return;
                }

                const n_steps = Math.floor(this.simulator.T / this.simulator.dt);
                const stepsPerFrame = Math.max(1, Math.floor(n_steps / 200)); 

                for (let k = 0; k < stepsPerFrame; k++) {
                    if (this.currentSimStep >= n_steps) { this.finalizeSimulation(); return; }
                    this.simulator.step();
                    this.currentSimStep++;
                    const snapshot_interval = Math.max(1, Math.floor(n_steps / 100));
                    if (this.currentSimStep % snapshot_interval === 0 || this.currentSimStep === n_steps) {
                        this.simulator.snapshots.push(Array.from(this.simulator.u));
                        this.simulator.timeSteps.push(this.currentSimStep * this.simulator.dt);
                    }
                }
                
                this.updateMetricsDisplay();
                const progressPercent = Math.min(100, (this.currentSimStep / n_steps) * 100);
                this.elements.progressBar.style.width = `${progressPercent}%`;
                this.elements.percentageCounter.textContent = `${progressPercent.toFixed(0)}%`;
                this.charts.liveChart.data.datasets[0].data = Array.from(this.simulator.u);
                this.charts.liveChart.update('none');
                
                this.animationFrameId = requestAnimationFrame(this.animationStep.bind(this));
            }

            handleRunStop() {
                if (this.isSimulationRunning) {
                    this.finalizeSimulation();
                } else {
                    if (!this.simulator || this.isSimulationFinished) this.refreshApplication(true);
                    this.isSimulationRunning = true; this.isSimulationPaused = false;
                    this.animationFrameId = requestAnimationFrame(this.animationStep.bind(this));
                }
                this.updateButtonStates();
            }

            handlePauseResume() {
                if (!this.isSimulationRunning) return;
                this.isSimulationPaused = !this.isSimulationPaused;
                if (!this.isSimulationPaused) this.animationFrameId = requestAnimationFrame(this.animationStep.bind(this));
                this.updateButtonStates();
            }

            refreshApplication(keepPresetName = false) {
                if (this.animationFrameId) cancelAnimationFrame(this.animationFrameId);
                if (this.replayAnimationTimer) this.toggleReplayAnimation();
                this.isSimulationRunning = false; this.isSimulationPaused = false; this.isSimulationFinished = false;
                this.currentSimStep = 0;
                this.elements.progressBar.style.width = '0%';
                
                this.resetMetricsDisplay();
                
                if (!keepPresetName) this.currentPresetName = "Custom"; 
                
                const L = parseFloat(this.elements.paramL.value), N = parseInt(this.elements.paramN.value), T = parseFloat(this.elements.paramT.value);
                const nu_eff = parseFloat(this.elements.paramAlpha.value), beta_NL = parseFloat(this.elements.paramBeta.value), gamma_diss = parseFloat(this.elements.paramGamma.value);
                const init_cond = this.elements.paramInit.value;
                this.simulator = new ConjectureSimulator1D(L, N, T, 0.01, nu_eff, beta_NL, gamma_diss, init_cond);

                this.initializeCharts(); // Re-init all charts
                this.charts.liveChart.data.labels = this.simulator.x;
                this.charts.liveChart.data.datasets[0].data = this.simulator.snapshots[0];
                this.charts.liveChart.update();
                
                this.charts.meanValChart.options.scales.x.max = this.simulator.T;
                this.charts.energyChart.options.scales.x.max = this.simulator.T;
                
                this.elements.analysisPlaceholderWrapper.style.display = 'block';
                this.elements.analysisPlaceholderWrapper.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                    content.style.display = 'none';
                });

                this.updateButtonStates();
                this.switchTab(this.elements.tabDistribution);

                const slider = this.elements.playbackSlider;
                slider.max = this.simulator.T; slider.value = 0;
                this.elements.playbackCurrentTime.textContent = 'Time: 0.00s';
                this.elements.playbackTotalTime.textContent = `Total: ${this.simulator.T.toFixed(2)}s`;
                this.updateSliderTrackColor(slider);
            }

            updateLiveSimulationTitle() {
                const subtitleSpan = this.elements.liveSimSubtitle;
                const activityIndicator = this.elements.simulationActivityIndicator;
                const spinnerElement = activityIndicator.querySelector('.spinner');

                if (!this.isSimulationRunning && !this.isSimulationFinished) {
                    subtitleSpan.innerHTML = `<span class="text-red-500">INACTIVE</span>`;
                    activityIndicator.style.display = 'none';
                } else if (this.isSimulationFinished) {
                    subtitleSpan.innerHTML = `<span class="text-blue-600">COMPLETED</span>`;
                    activityIndicator.style.display = 'flex';
                    spinnerElement.classList.add('spinner-completed');
                } else {
                    subtitleSpan.innerHTML = `<span class="text-green-600-custom">ACTIVE</span>`;
                    activityIndicator.style.display = 'flex';
                    spinnerElement.classList.remove('spinner-completed');
                }
            }
            
            toggleReplayAnimation() {
                if (this.replayAnimationTimer) {
                    clearInterval(this.replayAnimationTimer); this.replayAnimationTimer = null;
                    this.elements.replayPlayIcon.classList.remove('hidden'); this.elements.replayPauseIcon.classList.add('hidden');
                } else {
                    const slider = this.elements.playbackSlider;
                    if (parseFloat(slider.value) >= parseFloat(slider.max)) slider.value = 0;
                    this.elements.replayPlayIcon.classList.add('hidden'); this.elements.replayPauseIcon.classList.remove('hidden');
                    this.replayAnimationTimer = setInterval(() => this.stepPlayback(), 50);
                }
            }

            stepPlayback() {
                const slider = this.elements.playbackSlider;
                let currentValue = parseFloat(slider.value);
                const maxValue = parseFloat(slider.max);
                currentValue += maxValue / 100; // 5s replay
                if (currentValue >= maxValue) currentValue = 0;
                slider.value = currentValue;
                this.handlePlaybackScrub();
            }

            handlePlaybackScrub() {
                if (!this.simulator || this.simulator.snapshots.length === 0) return;
                const currentTime = parseFloat(this.elements.playbackSlider.value);
                this.updateSliderTrackColor(this.elements.playbackSlider);
                const snapshotIndex = this.findSnapshotIndexForTime(currentTime);
                const selectedSnapshot = this.simulator.snapshots[snapshotIndex];
                this.elements.playbackCurrentTime.textContent = `Time: ${this.simulator.timeSteps[snapshotIndex].toFixed(2)}s`;
                this.charts.liveChart.data.datasets[0].data = selectedSnapshot;
                this.charts.liveChart.update('none');
            }

            findSnapshotIndexForTime(time) {
                if (!this.simulator || this.simulator.timeSteps.length === 0) return 0;
                return this.simulator.timeSteps.reduce((prev, curr, i) => 
                    (Math.abs(curr - time) < Math.abs(this.simulator.timeSteps[prev] - time) ? i : prev), 0);
            }

            showModal(modalId, sectionId = null) {
                const modal = document.getElementById(modalId);
                modal.style.display = 'flex';
                if (window.MathJax?.typesetPromise) window.MathJax.typesetPromise([modal]);
                if (sectionId) document.getElementById(sectionId)?.scrollIntoView({ behavior: 'smooth' });
            }
            
            hideAllModals() {
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            }

            validateAndSetApiKey() {
                this.geminiApiKey = this.elements.geminiApiKeyInput.value.trim();
                this.updateButtonStates();
            }

            async showAiInterpretation(prompt, isJson = false) {
                this.showModal('aiInterpretationModal');
                const contentDiv = this.elements.aiInterpretationContent;
                contentDiv.innerHTML = `<div class="flex justify-center items-center py-8"><span class="spinner w-8 h-8 !border-t-purple-500 !border-gray-200"></span><span id="aiProgressMessage" class="ml-2 text-gray-600">Generating...</span></div>`;
                if (!this.geminiApiKey) { contentDiv.innerHTML = `<p class="text-red-600">Error: Gemini API key is not provided.</p>`; return; }
                if (!this.isSimulationFinished) { contentDiv.innerHTML = `<p>Please run a simulation to completion.</p>`; return; }
                try {
                    const genAI = new GoogleGenerativeAI({apiKey: this.geminiApiKey});
                    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
                    
                    const generationConfig = isJson ? { responseMimeType: "application/json" } : {};
                    const result = await model.generateContent({
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig,
                    });
                    const response = await result.response;
                    let text = response.text();

                    if (isJson) {
                         if (text.startsWith("```json")) text = text.substring(7, text.length - 3).trim();
                         else if (text.startsWith("```")) text = text.substring(3, text.length - 3).trim();
                         const qaPairs = JSON.parse(text);
                         let qaHtml = `<h3 class="text-xl font-semibold text-gray-700 mb-4">Frequently Asked Questions</h3>`;
                         qaPairs.forEach((item, index) => { qaHtml += `<div class="mb-4 p-3 border border-gray-200 rounded-md bg-gray-50"><h4 class="font-bold text-lg text-gray-800 mb-1">Q${index + 1}: ${item.question}</h4><p class="text-gray-700">${item.answer.replace(/\n/g, '<br>')}</p></div>`; });
                         contentDiv.innerHTML = `<div class="prose max-w-none">${qaHtml}</div>`;
                    } else {
                        contentDiv.innerHTML = `<div class="prose max-w-none">${text.replace(/\n/g, '<br>')}</div>`;
                    }
                    if (window.MathJax?.typesetPromise) window.MathJax.typesetPromise([contentDiv]);
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    contentDiv.innerHTML = `<p class="text-red-600">Failed to get AI interpretation: ${error.message}. Please check your API key and network connection.</p>`;
                }
            }

            interpretSimulationState() {
                const { elements, simulator } = this;
                const metrics = simulator.analyzeResults();
                const prompt = `As an expert in partial differential equations, provide a conceptual interpretation of a 1D Reaction-Diffusion PDE simulation. Simulation Parameters: L=${elements.paramL.value}, N=${elements.paramN.value}, T=${elements.paramT.value}, nu_eff=${elements.paramAlpha.value}, beta_NL=${elements.paramBeta.value}, gamma_diss=${elements.paramGamma.value}, Initial Condition: ${elements.paramInit.value}. Final Metrics: Max Value: ${metrics.max_value.toFixed(4)}, Min Value: ${metrics.min_value.toFixed(4)}, Mean Value: ${metrics.mean_value.toFixed(4)}, Std Dev: ${metrics.std_dev.toFixed(4)}, Kurtosis: ${metrics.kurtosis.toFixed(4)}, Energy: ${metrics.energy.toFixed(4)}. Analyze the interplay of diffusion, growth, and damping. Describe the overall behavior, evolution from the initial state, and what the metric trends suggest. Format using Markdown and LaTeX.`;
                this.showAiInterpretation(prompt);
            }

            interpretSimulationStateForKids() {
                const { elements, simulator } = this;
                const metrics = simulator.analyzeResults();
                const prompt = `Act as a friendly scientist explaining an experiment on a mysterious "goo" to a 10-year-old. Our Setup: Tube Length: ${elements.paramL.value}, Watched for: ${elements.paramT.value}s, "Spreading Agent": ${elements.paramAlpha.value}, "Growth Potion": ${elements.paramBeta.value}, "Clean-up Crew": ${elements.paramGamma.value}, Started with a '${elements.paramInit.value}' shape. The Goo's Report Card: Highest Mountain: ${metrics.max_value.toFixed(4)}, Deepest Valley: ${metrics.min_value.toFixed(4)}, Average Level: ${metrics.mean_value.toFixed(4)}, Bumpiness: ${metrics.std_dev.toFixed(4)}, Total Activity: ${metrics.energy.toFixed(4)}. Tell a simple story: What happened to the goo? Did it spread out, form patterns, or disappear? Explain in an enthusiastic way.`;
                this.showAiInterpretation(prompt);
            }
            
            generateQA() {
                 const prompt = `Generate 5 insightful questions and detailed answers about a 1D Reaction-Diffusion PDE simulation. The questions and answers should delve into the relationship between parameters and outcomes, numerical methods, stability, and conceptual links to more complex systems. The final output must be a valid JSON array of objects, where each object has a 'question' and 'answer' key.`;
                this.showAiInterpretation(prompt, true);
            }

            playConversationAudio() {
                const audio = this.elements.navierStokesAudio;
                const btn = this.elements.btnConversation;
                if (audio.paused) { audio.play(); btn.textContent = `Pause Conversation`; } 
                else { audio.pause(); btn.textContent = `Conversation`; }
                audio.onended = () => { btn.textContent = `Conversation`; };
            }

            switchTab(tabElement) {
                const targetContentId = tabElement.dataset.tab;

                // Hide all tabs first and deactivate all buttons
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                    content.style.display = 'none';
                });
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active-tab');
                    btn.classList.add('inactive-tab');
                });

                // Show the selected tab and activate its button
                const activeContent = document.getElementById(targetContentId);
                if (activeContent) {
                    activeContent.classList.add('active');
                    activeContent.style.display = 'block';
                }
                tabElement.classList.remove('inactive-tab');
                tabElement.classList.add('active-tab');

                // If simulation is finished, re-render the chart for the newly visible tab.
                // This ensures the canvas has correct dimensions before drawing.
                if (this.isSimulationFinished) {
                    const final_u = this.simulator.snapshots.slice(-1)[0];

                    switch (targetContentId) {
                        case 'distributionContent': {
                            const final_du_dx = this.simulator.calculate_du_dx(final_u);
                            const final_d2u_dx2 = this.simulator.calculate_d2u_dx2(final_u);
                            this.displayDistributionCharts(final_u, final_du_dx, final_d2u_dx2);
                            break;
                        }
                        case 'spectrumContent':
                            this.displayPowerSpectrumChart(final_u);
                            break;
                        case 'phaseSpaceContent': {
                            const final_du_dx = this.simulator.calculate_du_dx(final_u);
                            this.displayPhaseSpaceChart(final_u, final_du_dx);
                            break;
                        }
                        case 'timeSpaceContent':
                            this.displayTimeSpacePlot();
                            break;
                    }
                }
            }


            showDetailedAnalysis() {
                if (!this.simulator || !this.isSimulationFinished) {
                    this.elements.analysisPlaceholderWrapper.style.display = 'block';
                    this.elements.analysisPlaceholderWrapper.classList.add('active');
                    return;
                }
                
                this.elements.analysisPlaceholderWrapper.style.display = 'none';
                this.elements.analysisPlaceholderWrapper.classList.remove('active');

                // This will set the initial tab and trigger the render for it.
                this.switchTab(this.elements.tabDistribution);
            }


            getDistribution(dataArray, numBins = 20) {
                if (dataArray.length === 0) return { labels: [], data: [] };
                let minVal = dataArray[0], maxVal = dataArray[0];
                for (const val of dataArray) {
                    if (val < minVal) minVal = val;
                    if (val > maxVal) maxVal = val;
                }
                if (maxVal === minVal) return { labels: [maxVal.toPrecision(2)], data: [dataArray.length] };
                const binWidth = (maxVal - minVal) / numBins;
                const histData = new Array(numBins).fill(0);
                const labels = Array.from({ length: numBins }, (_, i) => (minVal + i * binWidth).toPrecision(2));
                dataArray.forEach(val => {
                    let binIndex = Math.floor((val - minVal) / binWidth);
                    if (binIndex >= numBins) binIndex = numBins - 1;
                    if (binIndex < 0) binIndex = 0;
                    histData[binIndex]++;
                });
                return { labels, data: histData };
            }

            displayDistributionCharts(u, du_dx, d2u_dx2) {
                const updateChart = (chartVar, data, label) => {
                    const distData = this.getDistribution(data);
                    this.charts[chartVar].data.labels = distData.labels;
                    this.charts[chartVar].data.datasets[0].data = distData.data;
                    this.charts[chartVar].data.datasets[0].label = label;
                    this.charts[chartVar].update();
                };
                updateChart('valueDistChart', u, 'Value Distribution (u)');
                updateChart('gradientDistChart', du_dx, 'Gradient Distribution (du/dx)');
                updateChart('curvatureDistChart', d2u_dx2, 'Curvature Distribution (d2u/dx2)');
            }

            displayPowerSpectrumChart(u_final) {
                const fft_result = FFT.fft1d(u_final);
                const N = u_final.length;
                const power = fft_result.slice(0, N / 2).map(c => FFT.complex.abs(c)**2);
                const wavenumbers = Array.from({length: N/2}, (_, i) => i);
                
                const spectrumData = wavenumbers.map((k, i) => ({x: k, y: power[i]})).filter(p => p.y > 1e-9);

                this.charts.powerSpectrumChart.data.datasets[0].data = spectrumData;
                this.charts.powerSpectrumChart.update();
            }

            displayPhaseSpaceChart(u_final, du_dx_final) {
                const phaseData = u_final.map((u_val, i) => ({x: u_val, y: du_dx_final[i]}));
                this.charts.phaseSpaceChart.data.datasets[0].data = phaseData;
                this.charts.phaseSpaceChart.update();
            }

            displayTimeSpacePlot() {
                const canvas = this.elements.timeSpaceChartCanvas;
                if (!canvas || !this.simulator) return;

                const ctx = canvas.getContext('2d');
                const snapshots = this.simulator.snapshots;
                if (snapshots.length <= 1) {
                    // Ensure canvas is cleared if no data to show
                    if(canvas.parentElement.clientWidth > 0) {
                       canvas.width = canvas.parentElement.clientWidth;
                       canvas.height = canvas.parentElement.clientHeight;
                    }
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    return;
                }

                const parent = canvas.parentElement;
                canvas.width = parent.clientWidth;
                canvas.height = parent.clientHeight;
                
                if (canvas.width === 0 || canvas.height === 0) return; // Guard against hidden canvas

                const colorBarWidth = 60;
                const plotWidth = canvas.width - colorBarWidth;
                const plotHeight = canvas.height;

                let globalMin = snapshots[0][0];
                let globalMax = snapshots[0][0];
                for (const snapshot of snapshots) {
                    for (const val of snapshot) {
                        if (val < globalMin) globalMin = val;
                        if (val > globalMax) globalMax = val;
                    }
                }
                const range = globalMax - globalMin;
                
                const lerp = (a, b, t) => a + (b - a) * t;
                const colorStops = [
                    { t: 0.0,  rgb: [48, 10, 103] },   // Deep Purple
                    { t: 0.25, rgb: [106, 31, 156] },  // Purple
                    { t: 0.5,  rgb: [193, 58, 97] },   // Magenta/Red
                    { t: 0.75, rgb: [253, 137, 63] },  // Orange
                    { t: 1.0,  rgb: [249, 248, 113] }  // Bright Yellow
                ];
                
                const getColor = (value) => {
                    const t = range > 1e-9 ? (value - globalMin) / range : 0.5;
                    for (let i = 0; i < colorStops.length - 1; i++) {
                        const s1 = colorStops[i];
                        const s2 = colorStops[i+1];
                        if (t >= s1.t && t <= s2.t) {
                            const localT = (t - s1.t) / (s2.t - s1.t);
                            const r = Math.round(lerp(s1.rgb[0], s2.rgb[0], localT));
                            const g = Math.round(lerp(s1.rgb[1], s2.rgb[1], localT));
                            const b = Math.round(lerp(s1.rgb[2], s2.rgb[2], localT));
                            return [r, g, b];
                        }
                    }
                    return colorStops[colorStops.length-1].rgb;
                };

                const imageData = ctx.createImageData(plotWidth, plotHeight);
                const data = imageData.data;
                const numTimeSteps = snapshots.length;
                const numSpacePoints = snapshots[0].length;
                
                for (let y = 0; y < plotHeight; y++) {
                    const timeIndex = Math.floor(y * numTimeSteps / plotHeight);
                    const snapshot = snapshots[timeIndex];
                    for (let x = 0; x < plotWidth; x++) {
                        const spaceIndex = Math.floor(x * numSpacePoints / plotWidth);
                        const value = snapshot[spaceIndex];
                        const color = getColor(value);
                        const pixelIndex = (y * plotWidth + x) * 4;
                        data[pixelIndex]     = color[0]; // R
                        data[pixelIndex + 1] = color[1]; // G
                        data[pixelIndex + 2] = color[2]; // B
                        data[pixelIndex + 3] = 255;      // A
                    }
                }
                ctx.putImageData(imageData, 0, 0);

                // Draw color bar
                const cbX = plotWidth;
                const cbWidth = colorBarWidth - 30;
                const gradient = ctx.createLinearGradient(0, plotHeight, 0, 0);
                colorStops.forEach(s => gradient.addColorStop(s.t, `rgb(${s.rgb.join(',')})`));
                ctx.fillStyle = gradient;
                ctx.fillRect(cbX, 0, cbWidth, plotHeight);

                // Draw color bar labels
                ctx.fillStyle = '#333';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                const numLabels = 5;
                for (let i = 0; i <= numLabels; i++) {
                    const y = plotHeight * (1 - i / numLabels);
                    const value = lerp(globalMin, globalMax, i / numLabels);
                    ctx.fillText(value.toExponential(1), cbX + cbWidth + 4, y);
                    ctx.fillRect(cbX - 2, y, cbWidth + 4, 1);
                }
            }

        }

        document.addEventListener('DOMContentLoaded', () => {
            new SimulationDashboard();
        });
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
