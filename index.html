<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1D Fluid Dynamics Analogue Simulator v30</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for plotting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- MathJax Configuration (IMPORTANT for inline LaTeX) -->
    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']] // Configure $ for inline math
          },
          svg: {
            fontCache: 'global' // Optimize font loading
          },
          options: {
            // Explicitly tell MathJax to skip script tags to prevent parsing JavaScript as LaTeX
            skipHtmlTags: ['script', 'noscript', 'textarea', 'pre', 'code', 'annotation', 'annotation-xml'],
            ignoreHtmlClass: 'no-mathjax' // Also ignore elements with this class
          }
        };
    </script>
    <!-- MathJax CDN for LaTeX rendering -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* Custom styles for better slider appearance */
        input[type='range']::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4F46E5; /* Indigo-600 */
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3); /* Indigo-600 with opacity */
            margin-top: -6px; /* Adjust to center thumb on track */
        }
        input[type='range']::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4F46E5;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3);
        }

        /* Dynamic gradient for the slider track */
        input[type='range'] {
            -webkit-appearance: none; /* Override default browser styles */
            appearance: none;
            width: 100%;
            height: 4px; /* Height of the track */
            border-radius: 2px;
            outline: none; /* Remove focus outline */
            background: linear-gradient(to right,
                hsl(120, 60%, 85%) 0%,    /* Light Pastel Green */
                hsl(210, 70%, 75%) 33%,   /* Pastel Blue */
                hsl(270, 80%, 65%) 66%,   /* Pastel Purple */
                hsl(0, 90%, 55%) 100%     /* Pastel Red */
            );
            background-size: var(--slider-value-percent, 0%) 100%; /* Controls the fill amount */
            background-repeat: no-repeat;
            background-color: #E0E7FF; /* Color for the unfilled part of the track */
            transition: background-size 0.1s ease-out; /* Smooth transition for the gradient fill */
        }

        /* Ensure the actual track part is transparent so the input's background shows */
        input[type='range']::-webkit-slider-runnable-track {
            background: transparent;
        }
        input[type='range']::-moz-range-track {
            background: transparent;
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; /* Make space for the icon */
        }

        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            backdrop-filter: blur(5px); /* Blur background */
            -webkit-backdrop-filter: blur(5px); /* Safari support */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto; /* Center vertically and horizontally */
            padding: 20px;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            position: relative;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Spinner for activity indicator */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Pulsing color animation for text/icon */
        @keyframes pulseColor {
            0% { color: white; }
            50% { color: #FECACA; } /* Tailwind red-200 */
            100% { color: white; }
        }

        .pulsing-text {
            animation: pulseColor 1s ease-in-out infinite;
        }

        /* Activity Indicator Positioning */
        #simulationActivityIndicator {
            display: none; /* Hidden by default */
            position: absolute;
            top: 1.5rem; /* Adjust as needed to align with title */
            right: 1.5rem; /* Adjust as needed */
            z-index: 10;
            display: flex; /* Use flexbox for alignment of spinner and percentage */
            align-items: center;
            gap: 0.5rem; /* Space between spinner and percentage */
        }

        /* Adjusted progress bar to end before spinner */
        #progressBar {
            position: absolute; /* Needs to be absolute to control its right edge */
            left: 0;
            top: 0;
            height: 100%; /* Fill the parent container */
            border-radius: 9999px; /* Tailwind rounded-full */
            background-color: #4F46E5; /* Indigo-600 */
            transition: width 0.1s ease-out;
        }
        .progress-bar-container {
            position: relative; /* Make this the positioning context for the absolute progress bar */
            width: 100%;
            height: 0.625rem; /* h-2.5 */
            background-color: #E0E7FF; /* bg-gray-200 */
            border-radius: 9999px; /* rounded-full */
            margin-bottom: 1.5rem; /* mb-6 */
            overflow: hidden; /* Hide overflow of the inner bar */
        }

        /* Styling for the blue and red slashes */
        .slash-blue {
            color: #3B82F6; /* blue-500 */
        }
        .slash-red {
            color: #EF4444; /* red-500 */
        }
        .text-green-600-custom {
            color: #16A34A; /* This is Tailwind's green-600 */
        }
        .text-red-600-custom {
            color: #DC2626; /* This is Tailwind's red-600 */
        }
        .spinner.spinner-completed {
            animation: none; /* Stop the spin animation */
            border-top-color: #10B981 !important; /* Ensure all borders are green-600 */
            border-left-color: #10B981 !important;
            border-right-color: #10B981 !important;
            border-bottom-color: #10B981 !important;
        }

        /* Dynamic Tooltip styles */
        #dynamicTooltip {
            position: absolute;
            background-color: rgba(31, 41, 55, 0.95); /* Gray-800 with opacity */
            color: white;
            padding: 0.5rem 0.75rem; /* p-2 px-3 */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.75rem; /* text-xs */
            line-height: 1rem; /* leading-tight */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            white-space: normal; /* Allow text to wrap */
            max-width: 250px; /* Limit tooltip width */
            z-index: 2000; /* Ensure it's above everything else */
            pointer-events: none; /* Do not block mouse events on elements below */
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            /* JS will handle positioning */
            top: -9999px;
            left: -9999px;
        }
        #dynamicTooltip.show {
            opacity: 1;
        }

        /* Fixed table layout for Live Data Points table */
        #detailedDataTableContainer table {
            table-layout: fixed;
        }
        #detailedDataTableContainer th,
        #detailedDataTableContainer td {
            width: 50%; /* Distribute width equally between two columns */
        }
        
        /* Style for disabled playback controls */
        .playback-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased text-gray-800 p-4 sm:p-6">

    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-4">
            <h1 class="font-light tracking-widest text-gray-600" style="font-size: 10pt;">Q U A N T U M &nbsp; Q &nbsp; | &nbsp; R E S E A R C H &nbsp;&nbsp; D I V I S I O N &nbsp; | &nbsp; 2 0 2 5</h1>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white shadow-lg rounded-xl p-6 sm:p-8 border border-gray-200" id="mainContentArea">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-indigo-700 mb-2">1D Fluid Dynamics Analogue Simulator</h1>
        <p class="text-center text-sm text-red-600 font-semibold mb-8">
            (A 1D Reaction-Diffusion PDE model for conceptual exploration)
        </p>

        <!-- IMPORTANT DISCLAIMER FOR RESEARCH CONTEXT -->
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-8 text-center" role="alert">
            <strong class="font-bold">CRITICAL NOTE FOR RESEARCHERS:</strong>
            <span class="block sm:inline">This simulator models a **1D Reaction-Diffusion PDE** as an *analogue*. It is **NOT** a direct simulation of the 3D Navier-Stokes equations and cannot be used to prove or disprove the Navier-Stokes existence and smoothness conjecture. Its purpose is for conceptual understanding of related PDE phenomena.</span>
        </div>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Left Panel: Parameters and Controls -->
            <div class="lg:w-2/5 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-md" id="parameterSection">
                <h2 class="text-2xl font-bold text-gray-700 mb-6">Simulation Parameters</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-4 mb-8">
                    <!-- System Length -->
                    <div>
                        <label for="paramL" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="The total spatial extent of the 1D domain for the simulation.">System Length (L):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramL" min="1" max="50" step="1" value="10" class="w-full">
                            <input type="number" id="inputL" min="1" max="50" step="1" value="10" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Grid Points -->
                    <div>
                        <label for="paramN" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="The number of discrete points used to represent the spatial domain. Higher N means higher spatial resolution.">Grid Points (N):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramN" min="32" max="1024" step="32" value="256" class="w-full">
                            <input type="number" id="inputN" min="32" max="1024" step="32" value="256" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Total Time -->
                    <div>
                        <label for="paramT" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="The total duration for which the simulation will run.">Total Time (T):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramT" min="0.1" max="50" step="0.5" value="5" class="w-full">
                            <input type="number" id="inputT" min="0.1" max="50" step="0.5" value="5.0" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Diffusion Coefficient -->
                    <div>
                        <label for="paramAlpha" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="The diffusion coefficient ($\nu_{eff}$) controls how quickly the quantity $u$ spreads out from regions of high concentration to low concentration. Higher $\nu_{eff}$ leads to faster smoothing. This parameter is analogous to viscosity in fluid dynamics.">Diff. Coefficient ($\nu_{eff}$):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramAlpha" min="0.01" max="1" step="0.01" value="0.1" class="w-full">
                            <input type="number" id="inputAlpha" min="0.01" max="1" step="0.01" value="0.10" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Non-linear Growth -->
                    <div>
                        <label for="paramBeta" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="The non-linear growth parameter ($\beta_{NL}$) influences the local growth or decay of $u$. The $u(1-u)$ term is common in logistic growth models, where growth is limited as $u$ approaches 1. This parameter represents the non-linear reaction term, conceptually similar to non-linear advection in fluid dynamics.">Non-linear Growth ($\beta_{NL}$):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramBeta" min="0" max="2" step="0.05" value="0.5" class="w-full">
                            <input type="number" id="inputBeta" min="0" max="2" step="0.05" value="0.50" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Cubic Damping -->
                    <div>
                        <label for="paramGamma" class="block text-sm font-medium text-gray-600 cursor-pointer" data-tooltip-content="The cubic damping parameter ($\gamma_{diss}$) further limits the growth of $u$, especially at higher values. It can stabilize solutions or lead to different pattern formations. This parameter represents a form of dissipation or energy removal.">Cubic Damping ($\gamma_{diss}$):</label>
                        <div class="flex items-center gap-x-3 mt-1">
                            <input type="range" id="paramGamma" min="0" max="1" step="0.01" value="0.2" class="w-full">
                            <input type="number" id="inputGamma" min="0" max="1" step="0.01" value="0.20" class="bg-white p-1 border border-gray-300 rounded-md shadow-sm text-sm text-center" style="width: 5rem;">
                        </div>
                    </div>
                    <!-- Initial Condition -->
                    <div class="col-span-full flex flex-col">
                        <label for="paramInit" class="text-sm font-medium text-gray-600 mb-1 cursor-pointer" data-tooltip-content="The starting profile of $u$ at time $t=0$.">Initial Condition:</label>
                        <select id="paramInit" class="bg-white block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base h-10">
                            <option value="gaussian">Gaussian</option>
                            <option value="step">Step</option>
                            <option value="random">Random</option>
                            <option value="sine">Sine</option>
                        </select>
                    </div>
                    <!-- Enable Tooltips Checkbox -->
                    <div class="col-span-full flex items-center mt-4">
                        <input type="checkbox" id="enableTooltips" class="form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out rounded-md cursor-pointer">
                        <label for="enableTooltips" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer" data-tooltip-content="Toggle dashboard-wide tooltips for mathematical equations and important labels. Chart hover effects are always active.">Enable Equation Tooltips</label>
                    </div>
                </div>

                <!-- Simulation Presets -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Simulation Presets:</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button id="presetDiffusion" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="Demonstrates pure diffusion, where the initial profile smooths out over time due to the viscosity-like term.">
                            Pure Diffusion
                        </button>
                        <button id="presetGrowthDecay" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="Highlights the non-linear growth and damping terms, showing how values can grow and then stabilize or decay.">
                            Growth & Decay
                        </button>
                        <button id="presetWave" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="Visualizes a traveling wave front, where a step-like initial condition propagates across the domain.">
                            Propagating Wave
                        </button>
                        <button id="presetPattern" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" data-tooltip-content="Shows how complex, stable spatial patterns can emerge from a random initial state due to the interplay of all terms.">
                            Pattern Formation
                        </button>
                    </div>
                </div>

                <!-- Simulation Controls -->
                <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-3">Simulation Controls:</h3>
                <div class="flex flex-col sm:flex-row justify-around gap-4 mb-4">
                    <button id="btnRun" class="flex-1 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" title="Start Simulation">
                        <span id="btnRunContent" class="flex items-center justify-center">
                            <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.82V9.18a1 1 0 011.555-.832l3.197 2.132a1 1 0 010 1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Simulation
                        </span>
                    </button>
                    <button id="btnPauseResume" class="flex-1 px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition ease-in-out duration-150 opacity-50 cursor-not-allowed h-10" disabled title="Pause Simulation">
                        <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Simulation
                    </button>
                </div>
                <div class="flex flex-col sm:flex-row justify-around gap-4">
                    <button id="btnRefresh" class="flex-1 px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" title="Refresh Dashboard">
                        <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004 12c0 2.21.817 4.231 2.105 5.786M20 20v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Refresh
                    </button>
                    <button id="btnExport" class="flex-1 px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition ease-in-out duration-150 opacity-50 cursor-not-allowed h-10" disabled title="Export Data">
                        <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        Export Data
                    </button>
                </div>
                <div class="flex justify-around gap-4 mt-4">
                    <button id="btnHelp" class="flex-1 px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 flex items-center justify-center cursor-pointer" title="How to Interpret the Dashboard">
                        How to Interpret this Dashboard
                    </button>
                </div>
            </div>

            <!-- Right Panel: Live Visualization -->
            <div class="lg:w-3/5 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-md relative">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">Live Simulation <span id="liveSimSubtitle" class="ml-2 text-base font-semibold"></span></h2>
                    <div id="simulationActivityIndicator" class="hidden">
                        <span id="percentageCounter" class="text-sm font-semibold text-gray-700">0%</span>
                        <span class="spinner w-8 h-8 !border-t-green-500 !border-gray-300"></span>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div id="progressBar" class="bg-indigo-600 h-full rounded-full transition-all duration-100 ease-out" style="width: 0%;"></div>
                </div>

                <div class="relative bg-white rounded-lg p-4 shadow-inner border border-gray-300">
                    <canvas id="livePlotCanvas" class="w-full h-64 sm:h-80"></canvas>
                </div>

                <!-- NEW: Live Data Points Table -->
                <div class="mt-6 bg-white rounded-lg p-4 shadow-inner border border-gray-300">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Live Data Points</h3>

                    <!-- Simple 1-row summary (visible by default) -->
                    <div id="simpleDataTableSummary" class="mb-4 text-gray-700">
                        <p>Current $u(x,t)$ at $x=0$: <span id="summaryU0">0.0000</span></p>
                        <p>Current $u(x,t)$ at $x=L/2$: <span id="summaryUL2">0.0000</span></p>
                    </div>

                    <!-- Toggle Button -->
                    <button id="toggleDetailedTable" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition ease-in-out duration-150 h-10 mb-4 cursor-pointer">
                        Show Detailed Data
                    </button>

                    <!-- Detailed Table Container (hidden by default) -->
                    <div id="detailedDataTableContainer" class="hidden">
                        <div class="mb-4">
                            <label for="tableDisplayMode" class="block text-sm font-medium text-gray-700 mb-1 cursor-pointer">Display:</label>
                            <select id="tableDisplayMode" class="bg-white block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base h-10">
                                <option value="u">Current Value (u)</option>
                                <option value="du_dx">First Derivative (du/dx)</option>
                                <option value="d2u_dx2">Second Derivative (d2u/dx2)</option>
                                <option value="reaction_term">Non-linear Growth Term</option>
                                <option value="damping_term">Cubic Damping Term</option>
                                <option value="du_dt">Total Rate of Change (du/dt)</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200" style="table-layout: fixed;">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">
                                            Position (x)
                                        </th>
                                        <th id="liveTableValueHeader" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">
                                            Value ($u(x,t)$)
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="liveDataTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- NEW: Simulation Playback Controls -->
                <div id="playbackControls" class="mt-6 bg-white rounded-lg p-4 shadow-inner border border-gray-300 playback-disabled">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Simulation Playback</h3>
                    <input type="range" id="playbackSlider" min="0" max="1" step="any" value="0" class="w-full h-2 rounded-lg appearance-none cursor-pointer" disabled>
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span id="playbackCurrentTime">Time: 0.00s</span>
                        <span id="playbackTotalTime">Total: 0.00s</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simulation Metrics Section -->
        <div class="mt-8 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-md">
            <h2 class="text-2xl font-bold text-gray-700 mb-6">Simulation Metrics</h2>
            <div id="metricsContent" class="p-4 bg-white rounded-b-lg shadow-inner border border-gray-300">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="The maximum value of $u(x,t)$ observed across the spatial domain at the current time step.">Max Value ($u_{max}$):</h3>
                        <p class="text-gray-600">Current: <span id="metricMaxVal_current">0.0000</span></p>
                        <p class="text-gray-600">Max Overall: <span id="metricMaxVal_max">0.0000</span></p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="The minimum value of $u(x,t)$ observed across the spatial domain at the current time step.">Min Value ($u_{min}$):</h3>
                        <p class="text-gray-600">Current: <span id="metricMinVal_current">0.0000</span></p>
                        <p class="text-gray-600">Min Overall: <span id="metricMinVal_min">0.0000</span></p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="The average value of $u(x,t)$ across the spatial domain at the current time step.">Mean Value ($\overline{u}$):</h3>
                        <p class="text-gray-600">Current: <span id="metricMeanVal_current">0.0000</span></p>
                        <p class="text-gray-600">Max Overall: <span id="metricMeanVal_max">0.0000</span></p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="Measures the spread or variability of $u(x,t)$ values across the domain at the current time step. Higher values indicate more spatial heterogeneity.">Standard Deviation ($\sigma_u$):</h3>
                        <p class="text-gray-600">Current: <span id="metricStdDev_current">0.0000</span></p>
                        <p class="text-gray-600">Max Overall: <span id="metricStdDev_max">0.0000</span></p>
                    </div>
                    <div class="col-span-full">
                        <h3 class="font-semibold text-gray-700 cursor-pointer" data-tooltip-content="Defined as $\mathcal{E} = \int_0^L u(x,t)^2 dx$. Represents a form of 'total activity' or 'content' in the system at the current time step.">Energy ($\mathcal{E}$):</h3>
                        <p class="text-gray-600">Current: <span id="metricEnergy_current">0.0000</span></p>
                        <p class="text-gray-600">Max Overall: <span id="metricEnergy_max">0.0000</span></p>
                    </div>
                </div>
                <h3 class="font-semibold text-gray-700 mb-2">Time Series Plots:</h3>
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="w-full md:w-1/2 bg-gray-100 rounded-md border border-gray-300 p-2 relative">
                        <canvas id="meanValChartCanvas" class="w-full h-64"></canvas>
                    </div>
                    <div class="w-full md:w-1/2 bg-gray-100 rounded-md border border-gray-300 p-2 relative">
                        <canvas id="energyChartCanvas" class="w-full h-64"></canvas>
                    </div>
                </div>

                <div class="flex flex-col items-center mt-6">
                    <div class="grid grid-cols-2 gap-4 w-full max-w-md">
                        <button id="btnResults" class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" disabled title="Interpret Current Simulation State">
                            <span class="flex items-center justify-center">
                                ✨ Results
                            </span>
                        </button>
                        <button id="btnInterpretKids" class="px-6 py-3 bg-blue-400 text-white font-semibold rounded-lg shadow-md hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" disabled title="Ask Einstein for a simple explanation">
                            <span class="flex items-center justify-center">
                                ✨ Ask Einstein
                            </span>
                        </button>
                        <button id="btnQA" class="px-6 py-3 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:ring-offset-2 transition ease-in-out duration-150 h-10 cursor-pointer" disabled title="Generate Questions & Answers">
                            <span class="flex items-center justify-center">
                                ✨ Q&A
                            </span>
                        </button>
                        <button id="btnConversation" class="px-6 py-3 bg-emerald-500 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:ring-offset-2 transition ease-in-out duration-150 h-10 flex items-center justify-center cursor-pointer" title="Listen to a conversation about Navier-Stokes">
                            Conversation
                        </button>
                        <!-- IMPORTANT: Updated src with the new GitHub Pages audio URL -->
                        <audio id="navierStokesAudio" src="https://quantumq-ai.github.io/QQ_1D_Navier_Stokes_Conjecture_Simulator/NavierStokesConversation.mp3" preload="auto"></audio>
                    </div>
                    <div class="mt-4 w-full max-w-md text-center">
                        <input type="password" id="geminiApiKeyInput" placeholder="Enter Gemini API Key to enable interpretation" class="bg-white w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-sm text-center">
                        <a href="#" id="getApiKeyLink" class="text-blue-600 hover:text-blue-800 text-xs no-underline mt-2 inline-block cursor-pointer">HOW TO ACQUIRE A GEMINI KEY</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabbed Results Section (formerly the main results section) -->
        <div class="mt-8 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-md">
            <h2 class="text-2xl font-bold text-gray-700 mb-6">Detailed Results</h2>
            <div class="flex border-b border-gray-200">
                <button id="tabFinalState" class="px-4 py-2 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:border-indigo-500 focus:outline-none active:border-indigo-600 transition duration-150 ease-in-out cursor-pointer">Final State</button>
                <button id="tabTimeEvolution" class="px-4 py-2 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:border-indigo-500 focus:outline-none active:border-indigo-600 transition duration-150 ease-in-out cursor-pointer">Time Evolution</button>
                <button id="tabAnalysis" class="px-4 py-2 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:border-indigo-500 focus:outline-none active:border-indigo-600 transition duration-150 ease-in-out cursor-pointer">Analysis & Metrics</button>
            </div>
            <div id="detailedResultsContent" class="p-4 bg-white rounded-b-lg shadow-inner border border-gray-300">
                <p class="text-gray-500 text-center py-8">Run a simulation to see results here.</p>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="mt-8 text-center text-xs text-gray-600" style="font-size: 9pt;">
        <p>
            Q U A N T U M &nbsp; Q &nbsp; P T E &nbsp; L T D
            <span class="mx-2">//</span>
            U E N &nbsp; 2 0 2 4 3 3 9 9 2 N
            <span class="mx-2">//</span>
            <a href="mailto:information@quantumq.net" class="text-blue-800 hover:text-indigo-600 cursor-pointer">✉️ E - M A I L</a>
            <span class="mx-2">//</span>
            <a href="#" id="acknowledgementsLink" class="hover:text-indigo-600 cursor-pointer">ACKNOWLEDGEMENTS</a>
            <span class="mx-2">//</span>
            <a href="#" id="legalLink" class="hover:text-indigo-600 cursor-pointer">LEGAL</a>
            <span class="mx-2">//</span>
            2 0 2 5 &copy;
        </p>
    </footer>


    <!-- Modals (Help, Legal, and AI Interpretation) -->
    <div id="interpretationModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">How to Interpret this Dashboard</h2>
            
            <h3 class="text-xl font-semibold text-gray-700 mb-2">1. Understanding this Simulator's Purpose</h3>
            <p class="mb-4 text-gray-700">
                This simulator models a **1D Reaction-Diffusion Partial Differential Equation (PDE)**, which describes how a quantity (like concentration or population density) changes over time due to diffusion and local reactions.
            </p>
            <p class="mb-4 text-gray-700">
                The equation solved by this simulator is:
                $$ \frac{\partial u}{\partial t} = \nu_{eff} \frac{\partial^2 u}{\partial x^2} + \beta_{NL} u(1-u) - \gamma_{diss} u^3 $$
                where:
                <ul class="list-disc list-inside ml-4 text-gray-700">
                    <li>$u(x,t)$ is the quantity being simulated at position $x$ and time $t$.</li>
                    <li>$\frac{\partial u}{\partial t}$ represents the rate of change of $u$ over time.</li>
                    <li>$\frac{\partial^2 u}{\partial x^2}$ represents the spatial curvature of $u$, related to diffusion.</li>
                </ul>
            </p>
            <div class="mt-4 mb-4 text-red-600 font-semibold border border-red-500 p-3 rounded-md">
                <strong class="underline">CRITICAL CLARIFICATION:</strong> This 1D Reaction-Diffusion PDE is **fundamentally different** from the 3D Navier-Stokes equations relevant to the Millennium Prize Problem. The parameters ($\nu_{eff}$, $\beta_{NL}$, $\gamma_{diss}$) in this simulator are *analogue* terms for a 1D model and do **NOT** directly correspond to the spectral index ($\alpha$), RG exponent ($\beta$), or vorticity alignment ($\cos \theta$) from the 3D Navier-Stokes regularity problem. This simulator is designed for general PDE exploration and understanding of reaction-diffusion phenomena, **not for direct verification or proof of the 3D Navier-Stokes existence and smoothness conjecture.**
            </div>

            <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">2. Simulation Parameters</h3>
            <ul class="list-disc list-inside ml-4 text-gray-700 space-y-2">
                <li><b>System Length (L):</b> The total spatial extent of the 1D domain.</li>
                <li><b>Grid Points (N):</b> The number of discrete points used to represent the spatial domain. Higher N means higher spatial resolution.</li>
                <li><b>Total Time (T):</b> The total duration for which the simulation will run.</li>
                <li><b>Diff. Coefficient ($\nu_{eff}$):</b> Controls how quickly the quantity $u$ spreads out from regions of high concentration to low concentration. Higher $\nu_{eff}$ leads to faster smoothing. This parameter is analogous to viscosity in fluid dynamics.</li>
                <li><b>Non-linear Growth ($\beta_{NL}$):</b> Influences the local growth or decay of $u$. The $u(1-u)$ term is common in logistic growth models, where growth is limited as $u$ approaches 1. This parameter represents the non-linear reaction term, conceptually similar to non-linear advection in fluid dynamics.</li>
                <li><b>Cubic Damping ($\gamma_{diss}$):</b> A cubic damping term ( $-\gamma_{diss} u^3$ ) that further limits the growth of $u$, especially at higher values. It can stabilize solutions or or lead to different pattern formations. This parameter represents a form of dissipation or energy removal.</li>
                <li><b>Initial Condition:</b> The starting profile of $u$ at time $t=0$.
                    <ul class="list-circle list-inside ml-4 mt-1">
                        <li>`Gaussian`: A bell-shaped curve, often used to simulate a localized initial perturbation.</li>
                        <li>`Step`: A profile that changes abruptly at certain points, useful for observing wave propagation or front formation.</li>
                        <li>`Random`: A noisy initial state, good for testing stability or emergent patterns.</li>
                        <li>`Sine`: A periodic wave, useful for observing how oscillations evolve.</li>
                    </ul>
                </li>
            </ul>

            <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">3. Interpreting the Results</h3>
            <ul class="list-disc list-inside ml-4 text-gray-700 space-y-2">
                <li><b>Live Simulation:</b> Shows the real-time evolution of $u(x,t)$ as the simulation progresses. Observe how the initial condition has evolved due to diffusion, reaction, and damping.</li>
                <li><b>Progress Bar:</b> Indicates the completion percentage of the simulation.</li>
                <li><b>Final State:</b> A plot of $u(x,T)$ at the very end of the simulation. This shows the stable state, oscillating pattern, or other final configuration achieved.</li>
                <li><b>Time Evolution:</b> Displays several snapshots of $u(x,t)$ at different time points throughout the simulation. This helps visualize the overall dynamic behavior.</li>
                <li><b>Analysis & Metrics:</b> Provides quantitative summaries of the final state:
                    <ul class="list-circle list-inside ml-4 mt-1">
                        <li>`Max Value`, `Min Value`, `Mean Value`, `Std Dev`: Standard statistical measures of $u$ across the spatial domain at the final time.</li>
                        <li>`Energy`: The integral of $u^2$ over the domain. This can be a useful diagnostic for stability or conservation properties in some PDE systems.</li>
                    </ul>
                </li>
                <li><b>Export Data:</b> Downloads the full simulation data (all snapshots over time) as a CSV file, which can be used for further analysis in other tools.</li>
            </ul>

            <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">4. Exploring Dynamics</h3>
            <p class="mb-4 text-gray-700">
                By adjusting the $\nu_{eff}$, $\beta_{NL}$, and $\gamma_{diss}$ parameters, you can explore a wide range of behaviors typical for reaction-diffusion systems, such as:
                <ul class="list-disc list-inside ml-4 text-gray-700">
                    <li>Pure diffusion (set $\beta_{NL}=\gamma_{diss}=0$, vary $\nu_{eff}$).</li>
                    <li>Logistic growth (set $\nu_{eff}=\gamma_{diss}=0$, vary $\beta_{NL}$).</li>
                    <li>Pattern formation (certain combinations of $\nu_{eff}, \beta_{NL}, \gamma_{diss}$ can lead to stable spatial patterns or traveling waves).</li>
                    <li>Blow-up (though less common in this specific 1D form, extreme parameters might lead to numerical instability or very rapid growth).</li>
                </ul>
            </p>
            
            <div id="apiKeyHelpSection">
                <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">5. Acquiring a Gemini API Key</h3>
                <p class="mb-4 text-gray-700">
                    To enable the AI-powered interpretation features (Results, Ask Einstein, Q&A), you need a Gemini API key. You can get a free key from Google AI Studio.
                </p>
                <ol class="list-decimal list-inside ml-4 text-gray-700 space-y-2">
                    <li>Visit the Google AI Studio website: <a href="https://aistudio.google.com/" target="_blank" class="text-blue-600 hover:underline">https://aistudio.google.com/</a></li>
                    <li>Sign in with your Google account.</li>
                    <li>Click the "Get API key" button (often found in the top left or on the main dashboard).</li>
                    <li>Create a new API key in your Google Cloud project.</li>
                    <li>Copy the generated API key.</li>
                    <li>Paste the key into the input box at the bottom of the "Simulation Metrics" panel in this tool.</li>
                </ol>
                <p class="text-gray-600 text-xs italic mt-4">
                    Note: The AI features are subject to Google's terms of service and API usage policies.
                </p>
            </div>

            <div id="acknowledgementsSection">
                <h3 class="text-xl font-semibold text-gray-700 mb-2 mt-6">6. Acknowledgements</h3>
                <p class="mb-4 text-gray-700">
                    This simulator was built using a combination of powerful open-source technologies. We gratefully acknowledge the creators and maintainers of these projects:
                </p>
                <ul class="list-disc list-inside ml-4 text-gray-700 space-y-3">
                    <li><b>HTML5, CSS3, & JavaScript (ES6+):</b> The fundamental technologies of the web that form the backbone of this application.</li>
                    <li>
                        <b>Tailwind CSS:</b> A utility-first CSS framework that enabled the rapid development of the user interface.
                        <span class="text-xs block text-gray-500">Released under the <a href="https://opensource.org/licenses/MIT" target="_blank" class="text-blue-600 hover:underline">MIT License</a>.</span>
                    </li>
                    <li>
                        <b>Chart.js:</b> A versatile charting library used for all data visualizations, including the live plot and time-series graphs.
                        <span class="text-xs block text-gray-500">Released under the <a href="https://opensource.org/licenses/MIT" target="_blank" class="text-blue-600 hover:underline">MIT License</a>.</span>
                    </li>
                    <li>
                        <b>MathJax:</b> An exceptional display engine for mathematics, used to render all LaTeX equations and symbols beautifully.
                        <span class="text-xs block text-gray-500">Released under the <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" class="text-blue-600 hover:underline">Apache License 2.0</a>.</span>
                    </li>
                    <li>
                        <b>Google Gemini:</b> The advanced large language model from Google that powers the AI-driven interpretation and Q&A features of this tool.
                        <span class="text-xs block text-gray-500">A proprietary model developed by Google.</span>
                    </li>
                </ul>
            </div>
            
            <p class="text-gray-700 italic mt-6">
                This tool serves as a versatile platform for understanding fundamental PDE concepts and exploring various dynamic behaviors.
            </p>
        </div>
    </div>

    <div id="legalModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Legal Disclaimers & Terms of Use</h2>
            
            <h3 class="text-lg font-semibold text-gray-700 mb-2">1. Experimental Research Tool</h3>
            <p class="mb-4 text-gray-700 text-sm">
                This 1D Fluid Dynamics Analogue Simulator (the "Tool") is provided by Quantum Q PTE. LTD. ("Quantum Q") as an experimental research and educational tool. It is intended solely for use by the scientific, mathematical, and engineering communities for conceptual exploration and educational purposes. The Tool is not designed, certified, or intended for use in any commercial, industrial, clinical, or mission-critical applications.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">2. No Warranty</h3>
            <p class="mb-4 text-gray-700 text-sm">
                THE TOOL IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND NONINFRINGEMENT. IN NO EVENT SHALL QUANTUM Q, ITS DIRECTORS, EMPLOYEES, OR AFFILIATES BE LIABLE FOR ANY CLAIM, DAMAGES, OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT, OR OTHERWISE, ARISING FROM, OUT OF, OR IN CONNECTION WITH THE TOOL OR THE USE OR OTHER DEALINGS IN THE TOOL.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">3. Limitation of Liability</h3>
            <p class="mb-4 text-gray-700 text-sm">
                You expressly understand and agree that Quantum Q shall not be liable for any direct, indirect, incidental, special, consequential, or exemplary damages, including but not limited to, damages for loss of profits, goodwill, use, data, or other intangible losses (even if Quantum Q has been advised of the possibility of such damages), resulting from the use or the inability to use the Tool. The entire risk as to the quality and performance of the Tool is with you. Should the Tool prove defective, you assume the cost of all necessary servicing, repair, or correction.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">4. No Guarantee of Accuracy</h3>
            <p class="mb-4 text-gray-700 text-sm">
                While efforts have been made to ensure the mathematical and numerical integrity of the simulation, Quantum Q makes no guarantee as to the accuracy, reliability, or completeness of the results generated by the Tool. The outputs are for illustrative and conceptual purposes only and should not be used for peer-reviewed publications, engineering design, or any other formal application without independent verification and validation. As stated prominently within the Tool, this simulator is an *analogue* and is not a direct simulation of the 3D Navier-Stokes equations.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">5. Intellectual Property</h3>
            <p class="mb-4 text-gray-700 text-sm">
                All rights, title, and interest in and to the Tool, including its source code, design, and branding, are the exclusive property of Quantum Q PTE. LTD. You may not copy, modify, distribute, sell, or lease any part of our Tool or its included software, nor may you reverse engineer or attempt to extract the source code of that software, unless laws prohibit those restrictions or you have our written permission.
            </p>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">6. Governing Law & Jurisdiction</h3>
            <p class="mb-4 text-gray-700 text-sm">
                These terms shall be governed by and construed in accordance with the laws of the Republic of Singapore, without regard to its conflict of law provisions. Any disputes arising out of or in connection with these terms shall be subject to the exclusive jurisdiction of the courts of the Republic of Singapore.
            </p>
            
            <h3 class="text-lg font-semibold text-gray-700 mb-2">7. International Applicability and English Law</h3>
            <p class="mb-4 text-gray-700 text-sm">
                While the primary governing law is that of the Republic of Singapore, these terms are intended to be broadly applicable to users globally. For users in jurisdictions where English law is applicable or preferred, these terms shall be interpreted in a manner consistent with the general principles of English contract law, to the extent that such interpretation does not conflict with the mandatory laws of Singapore. The parties acknowledge and agree that the principles of common law and equity, as applied in English law, may be considered in interpreting these terms where Singapore law is silent or where such principles provide additional clarity, provided always that Singapore law remains the ultimate governing law.
            </p>

            <p class="text-gray-600 text-xs italic mt-6">By using this Tool, you acknowledge that you have read, understood, and agree to be bound by these terms and disclaimers.</p>
        </div>
    </div>

    <div id="aiInterpretationModal" class="modal">
        <div class="modal-content w-11/12 md:w-3/4 lg:w-1/2">
            <span class="close-button" id="closeAiInterpretationModal">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">✨ AI Simulation Interpretation</h2>
            <div id="aiInterpretationContent" class="text-gray-700">
                <p>Loading interpretation...</p>
                <div class="flex justify-center items-center py-8">
                    <span class="spinner w-8 h-8 !border-t-purple-500 !border-gray-200"></span>
                    <span id="aiProgressMessage" class="ml-2 text-gray-600">Generating...</span>
                </div>
            </div>
            <p class="text-sm text-gray-500 mt-4 italic">
                (Interpretation provided by Gemini LLM. It is for conceptual understanding and does not constitute formal scientific analysis.)
            </p>
        </div>
    </div>

    <!-- Dynamic Tooltip Element (Hidden by default) -->
    <div id="dynamicTooltip" class="absolute z-50 p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg hidden opacity-0 transition-opacity duration-200 pointer-events-none"></div>
    
    <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://cdn.jsdelivr.net/npm/@google/generative-ai@0.14.0/+esm"
      }
    }
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ==============================================================================
        // CLASS 1: THE SIMULATION ENGINE
        // ==============================================================================
        class ConjectureSimulator1D {
            constructor(L = 10.0, N = 256, T = 5.0, dt = 0.01,
                        nu_eff = 0.1, beta_NL = 0.5, gamma_diss = 0.2, init_cond = 'gaussian') {
                this.L = L;
                this.N = N;
                this.T = T;
                this.dt = dt;
                this.nu_eff = nu_eff;
                this.beta_NL = beta_NL;
                this.gamma_diss = gamma_diss;
                
                this.x = Array.from({ length: N }, (_, i) => (i / (N - 1)) * L);
                this.dx = this.x[1] - this.x[0];
                
                this.u = new Float64Array(N);
                this.timeSteps = [];
                this.snapshots = [];
                
                this.initializeState(init_cond);
            }

            initializeState(init_cond) {
                const center = this.L / 2;
                const width = this.L / 10;

                if (init_cond === 'gaussian') {
                    for (let i = 0; i < this.N; i++) {
                        this.u[i] = Math.exp(-Math.pow(this.x[i] - center, 2) / (2 * Math.pow(width, 2)));
                    }
                } else if (init_cond === 'step') {
                    this.u.fill(0.0);
                    for (let i = 0; i < this.N; i++) {
                        if (this.x[i] > this.L / 3) this.u[i] = 0.2;
                        if (this.x[i] > 2 * this.L / 3) this.u[i] = 0.8;
                    }
                } else if (init_cond === 'random') {
                    for (let i = 0; i < this.N; i++) {
                        this.u[i] = Math.max(0, Math.min(1, 0.5 + 0.1 * (Math.random() * 2 - 1)));
                    }
                } else if (init_cond === 'sine') {
                    for (let i = 0; i < this.N; i++) {
                        this.u[i] = 0.5 * (1 + Math.sin(4 * Math.PI * this.x[i] / this.L));
                    }
                }
                
                this.snapshots.push(Array.from(this.u));
                this.timeSteps.push(0.0);
            }

            diffusionTerm(u_array = this.u) {
                const u_xx = new Float64Array(this.N);
                for (let i = 0; i < this.N; i++) {
                    const u_prev = u_array[(i - 1 + this.N) % this.N];
                    const u_next = u_array[(i + 1) % this.N];
                    u_xx[i] = (u_next - 2 * u_array[i] + u_prev) / (this.dx * this.dx);
                }
                return Array.from(u_xx).map(val => this.nu_eff * val);
            }

            reactionTerm(u_array = this.u) {
                return Array.from(u_array).map(val => this.beta_NL * val * (1 - val) - this.gamma_diss * Math.pow(val, 3));
            }

            step() {
                const du_dt_diff = this.diffusionTerm();
                const du_dt_react = this.reactionTerm();
                
                for (let i = 0; i < this.N; i++) {
                    this.u[i] += (du_dt_diff[i] + du_dt_react[i]) * this.dt;
                }
                 // Clamp values to a reasonable range to prevent numerical instability
                for (let i = 0; i < this.N; i++) {
                    this.u[i] = Math.max(-0.2, Math.min(1.2, this.u[i]));
                }
            }

            analyzeResults(u_array = this.u) {
                const current_state = u_array;
                const max_value = Math.max(...current_state);
                const min_value = Math.min(...current_state);
                const mean_value = current_state.reduce((sum, val) => sum + val, 0) / current_state.length;
                
                const sqDiffs = current_state.map(val => Math.pow(val - mean_value, 2));
                const std_dev = Math.sqrt(sqDiffs.reduce((sum, val) => sum + val, 0) / current_state.length);

                let energy = 0;
                for (let i = 0; i < current_state.length - 1; i++) {
                    energy += (current_state[i] * current_state[i] + current_state[i+1] * current_state[i+1]) / 2 * this.dx;
                }

                return { max_value, min_value, mean_value, std_dev, energy };
            }

            exportData() {
                let csvContent = "time," + this.x.map(val => `x_${val.toFixed(4)}`).join(",") + "\n";
                this.snapshots.forEach((snapshot, index) => {
                    const time = this.timeSteps[index].toFixed(4);
                    csvContent += `${time},${snapshot.map(val => val.toFixed(6)).join(",")}\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = "simulation_results.csv";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            calculate_du_dx(u_array) {
                const du_dx = new Float64Array(this.N);
                for (let i = 0; i < this.N; i++) {
                    const u_prev = u_array[(i - 1 + this.N) % this.N];
                    const u_next = u_array[(i + 1) % this.N];
                    du_dx[i] = (u_next - u_prev) / (2 * this.dx);
                }
                return du_dx;
            }

            calculate_d2u_dx2(u_array) {
                const d2u_dx2 = new Float64Array(this.N);
                for (let i = 0; i < this.N; i++) {
                    const u_prev = u_array[(i - 1 + this.N) % this.N];
                    const u_next = u_array[(i + 1) % this.N];
                    d2u_dx2[i] = (u_next - 2 * u_array[i] + u_prev) / (this.dx * this.dx);
                }
                return d2u_dx2;
            }

            calculate_reaction_term_only(u_array) {
                return u_array.map(val => this.beta_NL * val * (1 - val));
            }

            calculate_damping_term_only(u_array) {
                return u_array.map(val => -this.gamma_diss * Math.pow(val, 3));
            }

            calculate_du_dt_total(u_array) {
                const du_dt_total = new Float64Array(this.N);
                const du_dt_diff = this.diffusionTerm(u_array);
                const du_dt_react = this.reactionTerm(u_array);
                for (let i = 0; i < this.N; i++) {
                    du_dt_total[i] = du_dt_diff[i] + du_dt_react[i];
                }
                return du_dt_total;
            }
        }

        // ==============================================================================
        // CLASS 2: THE INTERACTIVE DASHBOARD
        // ==============================================================================
        class SimulationDashboard {
            constructor() {
                this.simulator = null;
                this.liveChart = null;
                this.finalStateChart = null;
                this.timeEvolutionChart = null;
                this.meanValChart = null;
                this.energyChart = null;
                this.currentActiveTab = 'finalState';
                this.geminiApiKey = "";
                this.isSimulationRunning = false;
                this.isSimulationPaused = false;
                this.currentSimStep = 0;
                this.currentPresetName = "Custom";
                this.currentTableDisplayMode = 'u';
                this.tooltipsEnabled = false;
                this.hasSimulationData = false;
                this.isDetailedTableVisible = false;
                this.animationFrameId = null;

                this.meanValueHistory = [];
                this.energyHistory = [];
                this.timeLabels = [];
                this.maxMaxVal = -Infinity;
                this.minMinVal = Infinity;
                this.maxMeanVal = -Infinity;
                this.maxStdDev = -Infinity;
                this.maxEnergy = -Infinity;

                this.chartStates = {}; 

                this.elements = {
                    paramL: document.getElementById('paramL'),
                    paramN: document.getElementById('paramN'),
                    paramT: document.getElementById('paramT'),
                    paramAlpha: document.getElementById('paramAlpha'),
                    paramBeta: document.getElementById('paramBeta'),
                    paramGamma: document.getElementById('paramGamma'),
                    inputL: document.getElementById('inputL'),
                    inputN: document.getElementById('inputN'),
                    inputT: document.getElementById('inputT'),
                    inputAlpha: document.getElementById('inputAlpha'),
                    inputBeta: document.getElementById('inputBeta'),
                    inputGamma: document.getElementById('inputGamma'),
                    
                    paramInit: document.getElementById('paramInit'),
                    
                    btnRun: document.getElementById('btnRun'),
                    btnRunContent: document.getElementById('btnRunContent'),
                    btnPauseResume: document.getElementById('btnPauseResume'),
                    btnRefresh: document.getElementById('btnRefresh'),
                    btnExport: document.getElementById('btnExport'),
                    btnHelp: document.getElementById('btnHelp'),
                    btnResults: document.getElementById('btnResults'),
                    btnInterpretKids: document.getElementById('btnInterpretKids'),
                    btnQA: document.getElementById('btnQA'),
                    btnConversation: document.getElementById('btnConversation'),
                    navierStokesAudio: document.getElementById('navierStokesAudio'),
                    geminiApiKeyInput: document.getElementById('geminiApiKeyInput'),

                    progressBar: document.getElementById('progressBar'), 
                    livePlotCanvas: document.getElementById('livePlotCanvas'),
                    detailedResultsContent: document.getElementById('detailedResultsContent'),
                    tabFinalState: document.getElementById('tabFinalState'),
                    tabTimeEvolution: document.getElementById('tabTimeEvolution'),
                    tabAnalysis: document.getElementById('tabAnalysis'),
                    interpretationModal: document.getElementById('interpretationModal'),
                    legalModal: document.getElementById('legalModal'),
                    closeModalButton: document.querySelector('#interpretationModal .close-button'),
                    closeLegalModalButton: document.querySelector('#legalModal .close-button'),
                    aiInterpretationModal: document.getElementById('aiInterpretationModal'),
                    closeAiInterpretationModal: document.getElementById('closeAiInterpretationModal'),
                    aiInterpretationContent: document.getElementById('aiInterpretationContent'),
                    aiProgressMessage: document.getElementById('aiProgressMessage'),
                    legalLink: document.getElementById('legalLink'),
                    acknowledgementsLink: document.getElementById('acknowledgementsLink'),
                    getApiKeyLink: document.getElementById('getApiKeyLink'),
                    
                    metricMaxVal_current: document.getElementById('metricMaxVal_current'),
                    metricMaxVal_max: document.getElementById('metricMaxVal_max'),
                    metricMinVal_current: document.getElementById('metricMinVal_current'),
                    metricMinVal_min: document.getElementById('metricMinVal_min'),
                    metricMeanVal_current: document.getElementById('metricMeanVal_current'),
                    metricMeanVal_max: document.getElementById('metricMeanVal_max'),
                    metricStdDev_current: document.getElementById('metricStdDev_current'),
                    metricStdDev_max: document.getElementById('metricStdDev_max'),
                    metricEnergy_current: document.getElementById('metricEnergy_current'),
                    metricEnergy_max: document.getElementById('metricEnergy_max'),
                    meanValChartCanvas: document.getElementById('meanValChartCanvas'),
                    energyChartCanvas: document.getElementById('energyChartCanvas'),

                    presetDiffusion: document.getElementById('presetDiffusion'),
                    presetGrowthDecay: document.getElementById('presetGrowthDecay'),
                    presetWave: document.getElementById('presetWave'),
                    presetPattern: document.getElementById('presetPattern'),
                    simulationActivityIndicator: document.getElementById('simulationActivityIndicator'),
                    percentageCounter: document.getElementById('percentageCounter'),
                    liveSimSubtitle: document.getElementById('liveSimSubtitle'),
                    
                    simpleDataTableSummary: document.getElementById('simpleDataTableSummary'),
                    summaryU0: document.getElementById('summaryU0'),
                    summaryUL2: document.getElementById('summaryUL2'),
                    toggleDetailedTable: document.getElementById('toggleDetailedTable'),
                    detailedDataTableContainer: document.getElementById('detailedDataTableContainer'),
                    liveDataTableBody: document.getElementById('liveDataTableBody'),
                    tableDisplayMode: document.getElementById('tableDisplayMode'),
                    liveTableValueHeader: document.getElementById('liveTableValueHeader'),
                    
                    playbackControls: document.getElementById('playbackControls'),
                    playbackSlider: document.getElementById('playbackSlider'),
                    playbackCurrentTime: document.getElementById('playbackCurrentTime'),
                    playbackTotalTime: document.getElementById('playbackTotalTime'),

                    enableTooltips: document.getElementById('enableTooltips'),
                    dynamicTooltip: document.getElementById('dynamicTooltip'),
                    mainContentArea: document.getElementById('mainContentArea')
                };

                this.activateTab = (tabName) => {
                    [this.elements.tabFinalState, this.elements.tabTimeEvolution, this.elements.tabAnalysis].forEach(tab => {
                        tab.classList.remove('border-indigo-600', 'text-indigo-600');
                        tab.classList.add('border-transparent', 'text-gray-600');
                    });

                    const finalStateWrapper = document.getElementById('finalStateWrapper');
                    const timeEvolutionWrapper = document.getElementById('timeEvolutionWrapper');
                    const analysisDiv = document.getElementById('analysisContent');

                    if (finalStateWrapper) finalStateWrapper.style.display = 'none';
                    if (timeEvolutionWrapper) timeEvolutionWrapper.style.display = 'none';
                    if (analysisDiv) analysisDiv.style.display = 'none';


                    this.currentActiveTab = tabName;
                    let targetElementForMathJax = null;

                    if (tabName === 'finalState') {
                        this.elements.tabFinalState.classList.add('border-indigo-600', 'text-indigo-600');
                        if (finalStateWrapper) {
                            finalStateWrapper.style.display = 'block';
                            targetElementForMathJax = finalStateWrapper;
                        }
                    } else if (tabName === 'timeEvolution') {
                        this.elements.tabTimeEvolution.classList.add('border-indigo-600', 'text-indigo-600');
                        if (timeEvolutionWrapper) {
                            timeEvolutionWrapper.style.display = 'block';
                            targetElementForMathJax = timeEvolutionWrapper;
                        }
                    } else if (tabName === 'analysis') {
                        this.elements.tabAnalysis.classList.add('border-indigo-600', 'text-indigo-600');
                        if (analysisDiv) {
                            analysisDiv.style.display = 'block';
                            targetElementForMathJax = analysisDiv;
                        }
                    }

                    if (targetElementForMathJax && window.MathJax?.typesetPromise) {
                        window.MathJax.typesetPromise([targetElementForMathJax]);
                    }
                };

                this._boundHandleTooltipShow = this.handleTooltipShow.bind(this);
                this._boundHandleTooltipHide = this.handleTooltipHide.bind(this);

                this.setupEventListeners();
                this.updateAllSliderTrackColors();
                this.initializeCharts();
                this.resetMetricsDisplay();
                this.updateButtonStates();
                this.updateLiveSimulationTitle();
                this.updateLiveDataTable();
            }
            
            setupSync(sliderId, inputId, fixedPoints = 0) {
                const slider = document.getElementById(sliderId);
                const input = document.getElementById(inputId);
                if (!slider || !input) return;

                slider.oninput = () => {
                    input.value = parseFloat(slider.value).toFixed(fixedPoints);
                    this.updateSliderTrackColor(slider);
                    this.currentPresetName = "Custom";
                    this.updateLiveSimulationTitle();
                };

                input.onchange = () => {
                    let value = parseFloat(input.value);
                    const min = parseFloat(slider.min);
                    const max = parseFloat(slider.max);
                    
                    if (isNaN(value)) {
                        value = min;
                    }
                    value = Math.max(min, Math.min(max, value));
                    
                    slider.value = value;
                    input.value = value.toFixed(fixedPoints);
                    this.updateSliderTrackColor(slider);
                    this.currentPresetName = "Custom";
                    this.updateLiveSimulationTitle();
                };
            }

            updateSliderTrackColor(sliderElement) {
                if (!sliderElement) return;
                const value = parseFloat(sliderElement.value);
                const min = parseFloat(sliderElement.min);
                const max = parseFloat(sliderElement.max);
                const percentage = ((value - min) / (max - min)) * 100;
                sliderElement.style.setProperty('--slider-value-percent', `${percentage}%`);
            }
            
            updateAllSliderTrackColors() {
                this.updateSliderTrackColor(this.elements.paramL);
                this.updateSliderTrackColor(this.elements.paramN);
                this.updateSliderTrackColor(this.elements.paramT);
                this.updateSliderTrackColor(this.elements.paramAlpha);
                this.updateSliderTrackColor(this.elements.paramBeta);
                this.updateSliderTrackColor(this.elements.paramGamma);
            }

            setupEventListeners() {
                this.setupSync('paramL', 'inputL', 1);
                this.setupSync('paramN', 'inputN', 0);
                this.setupSync('paramT', 'inputT', 1);
                this.setupSync('paramAlpha', 'inputAlpha', 2);
                this.setupSync('paramBeta', 'inputBeta', 2);
                this.setupSync('paramGamma', 'inputGamma', 2);

                if (this.elements.paramInit) this.elements.paramInit.onchange = () => {
                    this.currentPresetName = "Custom";
                    this.updateLiveSimulationTitle();
                };

                if (this.elements.btnRun) this.elements.btnRun.onclick = () => this.handleRunStop();
                if (this.elements.btnPauseResume) this.elements.btnPauseResume.onclick = () => this.handlePauseResume();
                if (this.elements.btnRefresh) this.elements.btnRefresh.onclick = () => this.refreshApplication(false);
                if (this.elements.btnExport) this.elements.btnExport.onclick = () => this.exportData();
                if (this.elements.btnHelp) this.elements.btnHelp.onclick = () => this.showModal('interpretationModal');
                if (this.elements.btnResults) this.elements.btnResults.onclick = () => this.interpretSimulationState();
                if (this.elements.btnInterpretKids) this.elements.btnInterpretKids.onclick = () => this.interpretSimulationStateForKids();
                if (this.elements.btnQA) this.elements.btnQA.onclick = () => this.generateQA();
                if (this.elements.btnConversation) this.elements.btnConversation.onclick = () => this.playConversationAudio();
                if (this.elements.geminiApiKeyInput) this.elements.geminiApiKeyInput.oninput = () => this.validateAndSetApiKey();

                if (this.elements.tabFinalState) this.elements.tabFinalState.onclick = () => this.activateTab('finalState');
                if (this.elements.tabTimeEvolution) this.elements.tabTimeEvolution.onclick = () => this.activateTab('timeEvolution');
                if (this.elements.tabAnalysis) this.elements.tabAnalysis.onclick = () => this.activateTab('analysis');

                if (this.elements.closeModalButton) this.elements.closeModalButton.onclick = () => this.hideModal('interpretationModal');
                if (this.elements.closeLegalModalButton) this.elements.closeLegalModalButton.onclick = () => this.hideModal('legalModal');
                if (this.elements.closeAiInterpretationModal) this.elements.closeAiInterpretationModal.onclick = () => this.hideModal('aiInterpretationModal');
                
                const setupLink = (linkId, modalId, sectionId) => {
                    const linkElement = document.getElementById(linkId);
                    if (linkElement) {
                        linkElement.onclick = (e) => {
                            e.preventDefault();
                            this.showModal(modalId);
                            setTimeout(() => {
                                const section = document.getElementById(sectionId);
                                if (section) {
                                    section.scrollIntoView({ behavior: 'smooth' });
                                }
                            }, 300);
                        };
                    }
                };

                setupLink('getApiKeyLink', 'interpretationModal', 'apiKeyHelpSection');
                setupLink('acknowledgementsLink', 'interpretationModal', 'acknowledgementsSection');
                if (this.elements.legalLink) this.elements.legalLink.onclick = (e) => { e.preventDefault(); this.showModal('legalModal'); };


                window.onclick = (event) => {
                    if (this.elements.interpretationModal && event.target === this.elements.interpretationModal) {
                        this.hideModal('interpretationModal');
                    }
                    if (this.elements.legalModal && event.target === this.elements.legalModal) {
                        this.hideModal('legalModal');
                    }
                    if (this.elements.aiInterpretationModal && event.target === this.elements.aiInterpretationModal) {
                        this.hideModal('aiInterpretationModal');
                    }
                };

                if (this.elements.presetDiffusion) {
                    this.elements.presetDiffusion.onclick = () => this.applyPreset({
                        name: 'Pure Diffusion', L: 10.0, N: 256, T: 10.0, nu_eff: 0.5, beta_NL: 0.0, gamma_diss: 0.0, init_cond: 'gaussian'
                    });
                }
                if (this.elements.presetGrowthDecay) {
                    this.elements.presetGrowthDecay.onclick = () => this.applyPreset({
                        name: 'Growth and Decay', L: 10.0, N: 256, T: 15.0, nu_eff: 0.01, beta_NL: 1.0, gamma_diss: 0.5, init_cond: 'random'
                    });
                }
                if (this.elements.presetWave) {
                    this.elements.presetWave.onclick = () => this.applyPreset({
                        name: 'Propagating Wave', L: 20.0, N: 512, T: 20.0, nu_eff: 0.05, beta_NL: 0.8, gamma_diss: 0.1, init_cond: 'step'
                    });
                }
                if (this.elements.presetPattern) {
                    this.elements.presetPattern.onclick = () => this.applyPreset({
                        name: 'Pattern Formation', L: 30.0, N: 768, T: 30.0, nu_eff: 0.02, beta_NL: 1.5, gamma_diss: 0.3, init_cond: 'random'
                    });
                }

                if (this.elements.tableDisplayMode) {
                    this.elements.tableDisplayMode.onchange = (event) => {
                        this.currentTableDisplayMode = event.target.value;
                        if (this.elements.playbackControls && !this.elements.playbackControls.classList.contains('playback-disabled') && this.simulator) {
                            const currentTime = parseFloat(this.elements.playbackSlider.value);
                            const snapshotIndex = this.findSnapshotIndexForTime(currentTime);
                            this.updateLiveDataTable(this.simulator.snapshots[snapshotIndex]);
                        } else {
                            this.updateLiveDataTable();
                        }
                    };
                }

                if (this.elements.toggleDetailedTable) {
                    this.elements.toggleDetailedTable.onclick = () => this.toggleDetailedTableVisibility();
                }

                if (this.elements.playbackSlider) {
                    this.elements.playbackSlider.oninput = () => this.handlePlaybackScrub();
                }

                if (this.elements.enableTooltips) {
                    this.elements.enableTooltips.onchange = this.handleEnableTooltipsChange.bind(this);
                }
            }

            handleEnableTooltipsChange(e) {
                this.tooltipsEnabled = e.target.checked;
                if (!this.tooltipsEnabled) {
                    this.handleTooltipHide();
                }
            }

            async handleTooltipShow(event) {
                if (!this.tooltipsEnabled) return;

                const target = event.target;
                const tooltipContent = target.dataset.tooltipContent || target.closest('[data-tooltip-content]')?.dataset.tooltipContent;
                
                if (tooltipContent) {
                    const tooltip = this.elements.dynamicTooltip;
                    tooltip.innerHTML = tooltipContent;
                    tooltip.style.display = 'block'; // Make it visible but transparent to measure it
                    tooltip.classList.remove('show');
                    
                    // Wait for MathJax to render before calculating dimensions
                    if (window.MathJax?.typesetPromise) {
                       await window.MathJax.typesetPromise([tooltip]);
                    }

                    const targetRect = target.getBoundingClientRect();
                    const tooltipRect = tooltip.getBoundingClientRect();

                    // Position tooltip centered above the target
                    let newLeft = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);
                    let newTop = targetRect.top - tooltipRect.height - 8; // 8px offset

                    // Adjust if off-screen
                    if (newLeft < 5) newLeft = 5;
                    if (newLeft + tooltipRect.width > window.innerWidth) newLeft = window.innerWidth - tooltipRect.width - 5;
                    if (newTop < 5) newTop = targetRect.bottom + 8; // Show below if no space above

                    tooltip.style.left = `${newLeft + window.scrollX}px`;
                    tooltip.style.top = `${newTop + window.scrollY}px`;
                    tooltip.classList.add('show');
                }
            }

            handleTooltipHide() {
                const tooltip = this.elements.dynamicTooltip;
                if (tooltip) {
                    tooltip.classList.remove('show');
                    // We don't hide with `display: none` immediately to allow the fade-out transition
                }
            }

            applyPreset(presetConfig) {
                if (this.isSimulationRunning) {
                    this.handleRunStop();
                }

                this.elements.paramL.value = presetConfig.L;
                this.elements.inputL.value = presetConfig.L.toFixed(1);
                
                this.elements.paramN.value = presetConfig.N;
                this.elements.inputN.value = presetConfig.N;

                this.elements.paramT.value = presetConfig.T;
                this.elements.inputT.value = presetConfig.T.toFixed(1);

                this.elements.paramAlpha.value = presetConfig.nu_eff;
                this.elements.inputAlpha.value = presetConfig.nu_eff.toFixed(2);

                this.elements.paramBeta.value = presetConfig.beta_NL;
                this.elements.inputBeta.value = presetConfig.beta_NL.toFixed(2);

                this.elements.paramGamma.value = presetConfig.gamma_diss;
                this.elements.inputGamma.value = presetConfig.gamma_diss.toFixed(2);
                
                this.elements.paramInit.value = presetConfig.init_cond;

                this.updateAllSliderTrackColors();
                
                this.currentPresetName = presetConfig.name;
                this.updateLiveSimulationTitle();
                
                this.refreshApplication(true);
                this.handleRunStop();
            }

            initializeCharts() {
                const chartConfigs = [
                    { id: 'livePlotCanvas', chartVar: 'liveChart', title: 'Live Simulation', yMin: -0.2, yMax: 1.2, borderColor: 'rgb(79, 70, 229)' },
                    { id: 'meanValChartCanvas', chartVar: 'meanValChart', title: 'Mean Value Over Time', yMin: 0, yMax: undefined, borderColor: '#10B981' },
                    { id: 'energyChartCanvas', chartVar: 'energyChart', title: 'Energy Over Time', yMin: 0, yMax: undefined, borderColor: '#F59E0B' }
                ];

                chartConfigs.forEach(config => {
                    const canvas = this.elements[config.id];
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    if (!ctx) return;

                    if (this[config.chartVar]) {
                        this[config.chartVar].destroy();
                        this[config.chartVar] = null;
                    }

                    const newChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: config.title.replace(' Over Time', ''),
                                data: [],
                                borderColor: config.borderColor,
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: { duration: 0 },
                            scales: {
                                x: {
                                    title: { display: true, text: (config.id === 'livePlotCanvas') ? 'Position (x)' : 'Time (t)' },
                                    type: 'linear',
                                    beginAtZero: true
                                },
                                y: {
                                    title: { display: true, text: (config.id === 'livePlotCanvas') ? 'u(x,t)' : config.title.replace(' Over Time', '') },
                                    min: config.yMin,
                                    max: config.yMax,
                                    beginAtZero: config.yMin >= 0
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                title: { display: true, text: config.title }
                            }
                        }
                    });
                    this[config.chartVar] = newChart;
                    
                    this.chartStates[config.id] = {
                        chartInstance: newChart,
                        initialXScale: { min: newChart.options.scales.x.min, max: newChart.options.scales.x.max },
                        initialYScale: { min: newChart.options.scales.y.min, max: newChart.options.scales.y.max }
                    };
                });
            }

            updateMetricsDisplay(u_array = this.simulator.u, time = this.simulator.timeSteps[this.simulator.timeSteps.length - 1]) {
                if (!this.simulator) return;

                const currentResults = this.simulator.analyzeResults(u_array);

                this.meanValueHistory.push(currentResults.mean_value);
                this.energyHistory.push(currentResults.energy);
                this.timeLabels.push(time);
                
                this.maxMaxVal = Math.max(this.maxMaxVal, currentResults.max_value);
                this.minMinVal = Math.min(this.minMinVal, currentResults.min_value);
                this.maxMeanVal = Math.max(this.maxMeanVal, currentResults.mean_value);
                this.maxStdDev = Math.max(this.maxStdDev, currentResults.std_dev);
                this.maxEnergy = Math.max(this.maxEnergy, currentResults.energy);

                this.elements.metricMaxVal_current.textContent = currentResults.max_value.toFixed(4);
                this.elements.metricMaxVal_max.textContent = this.maxMaxVal.toFixed(4);
                this.elements.metricMinVal_current.textContent = currentResults.min_value.toFixed(4);
                this.elements.metricMinVal_min.textContent = this.minMinVal.toFixed(4);
                this.elements.metricMeanVal_current.textContent = currentResults.mean_value.toFixed(4);
                this.elements.metricMeanVal_max.textContent = this.maxMeanVal.toFixed(4);
                this.elements.metricStdDev_current.textContent = currentResults.std_dev.toFixed(4);
                this.elements.metricStdDev_max.textContent = this.maxStdDev.toFixed(4);
                this.elements.metricEnergy_current.textContent = currentResults.energy.toFixed(4);
                this.elements.metricEnergy_max.textContent = this.maxEnergy.toFixed(4);

                this.updateCharts();
            }

            resetMetricsDisplay() {
                this.meanValueHistory = [];
                this.energyHistory = [];
                this.timeLabels = [];
                this.maxMaxVal = -Infinity;
                this.minMinVal = Infinity;
                this.maxMeanVal = -Infinity;
                this.maxStdDev = -Infinity;
                this.maxEnergy = -Infinity;

                ['metricMaxVal_current', 'metricMaxVal_max', 'metricMinVal_current', 'metricMinVal_min',
                 'metricMeanVal_current', 'metricMeanVal_max', 'metricStdDev_current', 'metricStdDev_max',
                 'metricEnergy_current', 'metricEnergy_max'].forEach(id => {
                    if(this.elements[id]) this.elements[id].textContent = '0.0000';
                });
            }

            updateCharts() {
                const getChartYMax = (dataArray) => {
                    if (dataArray.length === 0) return undefined;
                    const maxVal = Math.max(...dataArray);
                    return maxVal > 0 ? maxVal * 1.1 : (maxVal < 0 ? maxVal * 0.9 : 0.1);
                };

                if (this.meanValChart) {
                    this.meanValChart.data.labels = this.timeLabels;
                    this.meanValChart.data.datasets[0].data = this.meanValueHistory;
                    this.meanValChart.options.scales.y.max = getChartYMax(this.meanValueHistory);
                    this.meanValChart.update('none');
                }
                if (this.energyChart) {
                    this.energyChart.data.labels = this.timeLabels;
                    this.energyChart.data.datasets[0].data = this.energyHistory;
                    this.energyChart.options.scales.y.max = getChartYMax(this.energyHistory);
                    this.energyChart.update('none');
                }
            }

            updateButtonStates() {
                const btnRunContent = this.elements.btnRunContent;
                const btnPauseResume = this.elements.btnPauseResume;
                const activityIndicator = this.elements.simulationActivityIndicator;
                const spinnerElement = activityIndicator.querySelector('.spinner');
                
                const presetButtons = [this.elements.presetDiffusion, this.elements.presetGrowthDecay, this.elements.presetWave, this.elements.presetPattern];
                const playbackControls = this.elements.playbackControls;
                const playbackSlider = this.elements.playbackSlider;

                const setButtonState = (btn, enabled) => {
                    if (btn) {
                        btn.disabled = !enabled;
                        btn.classList.toggle('opacity-50', !enabled);
                        btn.classList.toggle('cursor-not-allowed', !enabled);
                    }
                };

                if (this.isSimulationRunning) {
                    btnRunContent.innerHTML = '<svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg> Simulation';
                    this.elements.btnRun.classList.replace('bg-indigo-600', 'bg-red-600');
                    this.elements.btnRun.classList.replace('hover:bg-indigo-700', 'hover:bg-red-700');
                    btnRunContent.classList.add('pulsing-text');
                    this.elements.btnRun.title = 'Stop Simulation';
                    setButtonState(this.elements.btnRun, true);
                    setButtonState(btnPauseResume, true);
                    btnPauseResume.innerHTML = this.isSimulationPaused 
                        ? '<svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.82V9.18a1 1 0 011.555-.832l3.197 2.132a1 1 0 010 1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Simulation'
                        : '<svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Simulation';
                    btnPauseResume.title = this.isSimulationPaused ? 'Resume Simulation' : 'Pause Simulation';
                    activityIndicator.style.display = 'flex';
                    spinnerElement.classList.remove('spinner-completed');
                    setButtonState(this.elements.btnExport, false);
                    setButtonState(this.elements.btnResults, false);
                    setButtonState(this.elements.btnInterpretKids, false);
                    setButtonState(this.elements.btnQA, false);
                    setButtonState(this.elements.btnRefresh, false);
                    presetButtons.forEach(btn => setButtonState(btn, false));
                    playbackControls.classList.add('playback-disabled');
                    playbackSlider.disabled = true;
                    this.hasSimulationData = true;
                } else { // Simulation is stopped
                    btnRunContent.innerHTML = '<svg class="inline-block w-5 h-5 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.82V9.18a1 1 0 011.555-.832l3.197 2.132a1 1 0 010 1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Simulation';
                    this.elements.btnRun.classList.replace('bg-red-600', 'bg-indigo-600');
                    this.elements.btnRun.classList.replace('hover:bg-red-700', 'hover:bg-indigo-700');
                    btnRunContent.classList.remove('pulsing-text');
                    this.elements.btnRun.title = 'Start Simulation';
                    setButtonState(btnPauseResume, false);
                    
                    const canInterpret = this.hasSimulationData && this.geminiApiKey.length > 0;
                    
                    if (this.hasSimulationData) {
                        setButtonState(this.elements.btnRun, false); // Cannot run again, must refresh
                        activityIndicator.style.display = 'flex';
                        spinnerElement.classList.add('spinner-completed');
                        this.elements.percentageCounter.textContent = '100%';
                        playbackControls.classList.remove('playback-disabled');
                        playbackSlider.disabled = false;
                    } else {
                        setButtonState(this.elements.btnRun, true);
                        activityIndicator.style.display = 'none';
                        spinnerElement.classList.remove('spinner-completed');
                        this.elements.percentageCounter.textContent = '0%';
                        playbackControls.classList.add('playback-disabled');
                        playbackSlider.disabled = true;
                    }

                    setButtonState(this.elements.btnExport, this.hasSimulationData);
                    setButtonState(this.elements.btnResults, canInterpret);
                    setButtonState(this.elements.btnInterpretKids, canInterpret);
                    setButtonState(this.elements.btnQA, canInterpret);
                    setButtonState(this.elements.btnRefresh, true);
                    presetButtons.forEach(btn => setButtonState(btn, !this.hasSimulationData));
                }
            }
            
            animationStep() {
                if (this.isSimulationPaused) {
                    return; // Loop is paused
                }

                if (!this.isSimulationRunning) {
                    // Finalization logic
                    this.hasSimulationData = true;
                    this.updateButtonStates();
                    this.updateLiveSimulationTitle();
                    this.showDetailedResults();
                    
                    if (this.elements.playbackSlider) {
                        this.elements.playbackSlider.max = this.simulator.T;
                        this.elements.playbackSlider.value = this.currentSimStep * this.simulator.dt;
                        this.elements.playbackCurrentTime.textContent = `Time: ${(this.currentSimStep * this.simulator.dt).toFixed(2)}s`;
                        this.elements.playbackTotalTime.textContent = `Total: ${this.simulator.T.toFixed(2)}s`;
                        this.updateSliderTrackColor(this.elements.playbackSlider);
                    }
                    return;
                }

                const n_steps = Math.floor(this.simulator.T / this.simulator.dt);
                const stepsPerFrame = 2; // Run 2 sim steps per screen refresh for speed

                for (let k = 0; k < stepsPerFrame; k++) {
                    if (this.currentSimStep >= n_steps) {
                        this.isSimulationRunning = false;
                        break;
                    }

                    this.simulator.step();
                    this.currentSimStep++;
                    
                    const currentTime = this.currentSimStep * this.simulator.dt;
                    const currentU = Array.from(this.simulator.u);
                    
                    // Update history for metric charts on every sim step for smoothness
                    this.updateMetricsDisplay(currentU, currentTime);

                    // Save snapshots for playback periodically
                    const snapshot_interval = Math.max(1, Math.floor(n_steps / 100)); // ~100 snapshots
                    if (this.currentSimStep % snapshot_interval === 0 || this.currentSimStep === n_steps) {
                        this.simulator.snapshots.push(currentU);
                        this.simulator.timeSteps.push(currentTime);
                    }
                }

                // --- UI updates that only need to run once per frame ---
                const progressPercent = Math.min(100, (this.currentSimStep / n_steps) * 100);
                this.elements.progressBar.style.width = `${progressPercent}%`;
                this.elements.percentageCounter.textContent = `${progressPercent.toFixed(0)}%`;

                this.liveChart.data.datasets[0].data = Array.from(this.simulator.u);
                this.liveChart.update('none'); // Update live chart without animation

                this.updateLiveDataTable(this.simulator.u);
                
                // Schedule next frame
                this.animationFrameId = requestAnimationFrame(this.animationStep.bind(this));
            }

            handleRunStop() {
                if (this.isSimulationRunning) {
                    this.isSimulationRunning = false;
                    // The animation loop will see the flag and run the finalization logic on its next cycle.
                } else {
                    if (this.currentSimStep === 0) {
                        this.refreshApplication(true);
                    }
                    this.isSimulationRunning = true;
                    this.isSimulationPaused = false;
                    // Start the animation loop
                    this.animationFrameId = requestAnimationFrame(this.animationStep.bind(this));
                }
                this.updateButtonStates();
            }

            handlePauseResume() {
                if (!this.isSimulationRunning) return;

                this.isSimulationPaused = !this.isSimulationPaused;

                if (!this.isSimulationPaused) {
                    // Resuming, kick off the loop again
                    this.animationFrameId = requestAnimationFrame(this.animationStep.bind(this));
                }
                this.updateButtonStates();
            }

            refreshApplication(keepPresetName = false) {
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
                this.isSimulationRunning = false;
                this.isSimulationPaused = false;
                this.currentSimStep = 0;
                this.elements.progressBar.style.width = '0%';
                
                this.resetMetricsDisplay();
                this.hasSimulationData = false;
                
                if (!keepPresetName) {
                    this.currentPresetName = "Custom"; 
                }
                
                const L = parseFloat(this.elements.paramL.value);
                const N = parseInt(this.elements.paramN.value);
                const T = parseFloat(this.elements.paramT.value);
                const nu_eff = parseFloat(this.elements.paramAlpha.value);
                const beta_NL = parseFloat(this.elements.paramBeta.value);
                const gamma_diss = parseFloat(this.elements.paramGamma.value);
                const init_cond = this.elements.paramInit.value;
                this.simulator = new ConjectureSimulator1D(L, N, T, 0.01, nu_eff, beta_NL, gamma_diss, init_cond);

                if (this.elements.detailedResultsContent) {
                    this.elements.detailedResultsContent.innerHTML = '<p class="text-gray-500 text-center py-8">Run a simulation to see results here.</p>';
                }

                this.initializeCharts(); // Re-initialize charts
                
                // Set a fixed x-axis for time-series charts for smooth plotting
                if (this.meanValChart) {
                    this.meanValChart.options.scales.x.max = this.simulator.T;
                }
                if (this.energyChart) {
                    this.energyChart.options.scales.x.max = this.simulator.T;
                }

                if (this.liveChart.data.labels) {
                    this.liveChart.data.labels = this.simulator.x.map(val => val.toFixed(2));
                }
                this.updateLiveDataTable(this.simulator.u); // Update table with initial state
                
                this.updateButtonStates();
                this.updateLiveSimulationTitle();
                this.activateTab('finalState');

                if (this.elements.playbackControls) {
                    this.elements.playbackSlider.value = 0;
                    this.elements.playbackCurrentTime.textContent = 'Time: 0.00s';
                    this.elements.playbackTotalTime.textContent = '0.00s';
                }
            }

            updateLiveSimulationTitle() {
                const subtitleSpan = this.elements.liveSimSubtitle;
                if (!subtitleSpan) return;

                if (!this.isSimulationRunning && !this.hasSimulationData) {
                    subtitleSpan.innerHTML = `<span class="text-red-600-custom">NOT ACTIVE</span>`;
                } else if (!this.isSimulationRunning && this.hasSimulationData) {
                     const currentTime = parseFloat(this.elements.playbackSlider.value).toFixed(2);
                     subtitleSpan.innerHTML = `<span class="text-blue-600">PLAYBACK (t=${currentTime}s)</span>`;
                } else {
                    const presetText = this.currentPresetName.toUpperCase();
                    subtitleSpan.innerHTML = `<span class="text-green-600-custom">ACTIVE (${presetText})</span>`;
                }
            }

            toggleDetailedTableVisibility() {
                this.isDetailedTableVisible = !this.isDetailedTableVisible;
                this.elements.detailedDataTableContainer.classList.toggle('hidden', !this.isDetailedTableVisible);
                this.elements.simpleDataTableSummary.classList.toggle('hidden', this.isDetailedTableVisible);
                this.elements.toggleDetailedTable.textContent = this.isDetailedTableVisible ? 'Hide Detailed Data' : 'Show Detailed Data';
                
                if (this.isDetailedTableVisible) this.updateLiveDataTable();
                if (this.elements.simpleDataTableSummary && window.MathJax?.typesetPromise) {
                    window.MathJax.typesetPromise([this.elements.simpleDataTableSummary]);
                }
            }

            updateLiveDataTable(u_data = this.simulator ? this.simulator.u : null) {
                const tableBody = this.elements.liveDataTableBody;
                const valueHeader = this.elements.liveTableValueHeader;
                
                if (this.simulator && u_data) {
                    this.elements.summaryU0.textContent = u_data[0].toFixed(4);
                    this.elements.summaryUL2.textContent = u_data[Math.floor(this.simulator.N / 2)].toFixed(4);
                } else {
                    this.elements.summaryU0.textContent = '0.0000';
                    this.elements.summaryUL2.textContent = '0.0000';
                }

                if (!this.isDetailedTableVisible) {
                    tableBody.innerHTML = '';
                    return;
                }

                tableBody.innerHTML = '';

                if (!this.simulator || !u_data) {
                    valueHeader.innerHTML = 'Value ($u(x,t)$)';
                    return;
                }

                const N = this.simulator.N;
                const pointsToShow = Math.min(N, 10);
                const indices = [...new Set(Array.from({length: pointsToShow}, (_, i) => Math.floor(i * (N - 1) / (pointsToShow - 1))))];

                let valuesToDisplay = [];
                let headerText = 'Value';

                switch (this.currentTableDisplayMode) {
                    case 'u': valuesToDisplay = u_data; headerText = 'Current Value ($u(x,t)$)'; break;
                    case 'du_dx': valuesToDisplay = this.simulator.calculate_du_dx(u_data); headerText = 'First Derivative ($\\frac{\\partial u}{\\partial x}$)'; break;
                    case 'd2u_dx2': valuesToDisplay = this.simulator.calculate_d2u_dx2(u_data); headerText = 'Second Derivative ($\\frac{\\partial^2 u}{\\partial x^2}$)'; break;
                    case 'reaction_term': valuesToDisplay = this.simulator.calculate_reaction_term_only(u_data); headerText = 'Non-linear Growth Term ($\\beta_{NL} u(1-u)$)'; break;
                    case 'damping_term': valuesToDisplay = this.simulator.calculate_damping_term_only(u_data); headerText = 'Cubic Damping Term ($-\\gamma_{diss} u^3$)'; break;
                    case 'du_dt': valuesToDisplay = this.simulator.calculate_du_dt_total(u_data); headerText = 'Total Rate of Change ($\\frac{\\partial u}{\\partial t}$)'; break;
                }

                valueHeader.innerHTML = headerText;
                if (window.MathJax?.typesetPromise) window.MathJax.typesetPromise([valueHeader]);

                indices.forEach(idx => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = this.simulator.x[idx].toFixed(2);
                    row.insertCell().textContent = valuesToDisplay[idx]?.toFixed(4) ?? 'N/A';
                    row.cells[0].className = 'px-6 py-2 whitespace-nowrap text-sm font-medium text-gray-900';
                    row.cells[1].className = 'px-6 py-2 whitespace-nowrap text-sm text-gray-500';
                });
            }

            handlePlaybackScrub() {
                if (!this.simulator || this.simulator.snapshots.length === 0) return;

                const currentTime = parseFloat(this.elements.playbackSlider.value);
                this.elements.playbackCurrentTime.textContent = `Time: ${currentTime.toFixed(2)}s`;
                this.updateSliderTrackColor(this.elements.playbackSlider);
                this.updateLiveSimulationTitle();

                const snapshotIndex = this.findSnapshotIndexForTime(currentTime);
                const selectedSnapshot = this.simulator.snapshots[snapshotIndex];

                this.liveChart.data.datasets[0].data = selectedSnapshot;
                this.liveChart.update('none');
                this.updateLiveDataTable(selectedSnapshot);

                // Update time-series charts to match the scrub position
                if (this.meanValChart && this.energyChart && this.timeLabels.length > 0) {
                    let timeIndex = this.timeLabels.findIndex(t => t > currentTime);
                    if (timeIndex === -1) {
                        timeIndex = this.timeLabels.length;
                    }

                    const timeSubset = this.timeLabels.slice(0, timeIndex);
                    const meanSubset = this.meanValueHistory.slice(0, timeIndex);
                    const energySubset = this.energyHistory.slice(0, timeIndex);

                    this.meanValChart.data.labels = timeSubset;
                    this.meanValChart.data.datasets[0].data = meanSubset;
                    this.meanValChart.update('none');

                    this.energyChart.data.labels = timeSubset;
                    this.energyChart.data.datasets[0].data = energySubset;
                    this.energyChart.update('none');
                }
            }

            findSnapshotIndexForTime(time) {
                if (!this.simulator || this.simulator.timeSteps.length === 0) return 0;
                // Simple binary search could work here if time steps are monotonic
                return this.simulator.timeSteps.reduce((prev, curr, i) => 
                    (Math.abs(curr - time) < Math.abs(this.simulator.timeSteps[prev] - time) ? i : prev), 0);
            }

            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    if (window.MathJax?.typesetPromise) {
                        window.MathJax.typesetPromise([modal]);
                    }
                }
            }

            hideModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            validateAndSetApiKey() {
                this.geminiApiKey = this.elements.geminiApiKeyInput.value.trim();
                this.updateButtonStates();
            }

            async showAiInterpretation(prompt, isJson = false) {
                this.showModal('aiInterpretationModal');
                const contentDiv = this.elements.aiInterpretationContent;
                contentDiv.innerHTML = `
                    <div class="flex justify-center items-center py-8">
                        <span class="spinner w-8 h-8 !border-t-purple-500 !border-gray-200"></span>
                        <span id="aiProgressMessage" class="ml-2 text-gray-600">Generating interpretation...</span>
                    </div>`;

                if (!this.geminiApiKey) {
                    contentDiv.innerHTML = `<p class="text-red-600">Error: Gemini API key is not provided. Please enter your API key.</p>`;
                    return;
                }
                if (!this.hasSimulationData || !this.simulator) {
                    contentDiv.innerHTML = `<p>Please run a simulation to generate data for interpretation.</p>`;
                    return;
                }

                try {
                    // NOTE: Using the older SDK pattern to match the imported v0.14.0 library from CDN.
                    const genAI = new GoogleGenerativeAI(this.geminiApiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

                    let result;
                    let text;

                    if (isJson) {
                         const generationConfig = {
                            responseMimeType: "application/json",
                         };
                         const fullPrompt = `${prompt} \n\nIMPORTANT: Please provide the response as a valid JSON array of objects, where each object has a "question" and "answer" key.`;
                         
                         result = await model.generateContent({
                            contents: [{ role: "user", parts: [{ text: fullPrompt }] }],
                            generationConfig,
                         });
                         const response = await result.response;
                         text = response.text();
                         
                         // The model might wrap the JSON in markdown backticks
                         if (text.startsWith("```json")) {
                            text = text.substring(7, text.length - 3).trim();
                         }
                    } else {
                        result = await model.generateContent(prompt);
                        const response = await result.response;
                        text = response.text();
                    }
                    
                    if (isJson) {
                         const qaPairs = JSON.parse(text);
                         let qaHtml = `<h3 class="text-xl font-semibold text-gray-700 mb-4">Frequently Asked Questions</h3>`;
                         qaPairs.forEach((item, index) => {
                            qaHtml += `
                                <div class="mb-4 p-3 border border-gray-200 rounded-md bg-gray-50">
                                    <h4 class="font-bold text-lg text-gray-800 mb-1">Q${index + 1}: ${item.question}</h4>
                                    <p class="text-gray-700">${item.answer.replace(/\n/g, '<br>')}</p>
                                </div>`;
                         });
                         contentDiv.innerHTML = `<div class="prose max-w-none">${qaHtml}</div>`;
                    } else {
                        contentDiv.innerHTML = `<div class="prose max-w-none">${text.replace(/\n/g, '<br>')}</div>`;
                    }

                    if (window.MathJax?.typesetPromise) {
                        window.MathJax.typesetPromise([contentDiv]);
                    }
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    contentDiv.innerHTML = `<p class="text-red-600">Failed to get AI interpretation. ${error.message}. Please check your API key and network connection. The model may also be unavailable.</p>`;
                }
            }

            interpretSimulationState() {
                const { elements, simulator } = this;
                const metrics = simulator.analyzeResults();
                const prompt = `
                    As an expert in partial differential equations, provide a conceptual interpretation of a 1D Reaction-Diffusion PDE simulation.
                    Simulation Parameters: L=${elements.paramL.value}, N=${elements.paramN.value}, T=${elements.paramT.value}, nu_eff=${elements.paramAlpha.value}, beta_NL=${elements.paramBeta.value}, gamma_diss=${elements.paramGamma.value}, Initial Condition: ${elements.paramInit.value}.
                    Current Metrics: Max Value: ${metrics.max_value.toFixed(4)}, Min Value: ${metrics.min_value.toFixed(4)}, Mean Value: ${metrics.mean_value.toFixed(4)}, Std Dev: ${metrics.std_dev.toFixed(4)}, Energy: ${metrics.energy.toFixed(4)}.
                    Analyze the interplay of diffusion, growth, and damping. Describe the overall behavior, evolution from the initial state, and what the metric trends suggest. Format using Markdown and LaTeX.
                `;
                this.showAiInterpretation(prompt);
            }

            interpretSimulationStateForKids() {
                const { elements, simulator } = this;
                const metrics = simulator.analyzeResults();
                const prompt = `
                    Act as a friendly scientist explaining an experiment on a mysterious "goo" to a 10-year-old.
                    Our Setup: Tube Length: ${elements.paramL.value}, Watched for: ${elements.paramT.value}s, "Spreading Agent": ${elements.paramAlpha.value}, "Growth Potion": ${elements.paramBeta.value}, "Clean-up Crew": ${elements.paramGamma.value}, Started with a '${elements.paramInit.value}' shape.
                    The Goo's Report Card: Highest Mountain: ${metrics.max_value.toFixed(4)}, Deepest Valley: ${metrics.min_value.toFixed(4)}, Average Level: ${metrics.mean_value.toFixed(4)}, Bumpiness: ${metrics.std_dev.toFixed(4)}, Total Activity: ${metrics.energy.toFixed(4)}.
                    Tell a simple story: What happened to the goo? Did it spread out, form patterns, or disappear? Explain in an enthusiastic way.
                `;
                this.showAiInterpretation(prompt);
            }
            
            generateQA() {
                 const prompt = `
                    Generate 10 unique and insightful questions with corresponding detailed answers about a 1D Reaction-Diffusion PDE simulation, framed as if for a technical or scientific reporter, mathematician, researcher, or enthusiast. The questions and answers should delve into the novel methods associated with solving such PDEs, including (but not limited to) numerical techniques like finite difference methods, the conceptual link to complex fluid dynamics (like Navier-Stokes, but *always* clarifying this 1D model is an analogue and not a direct Navier-Stokes solution), stability, convergence, and the implications of parameters.
                    Emphasize the conceptual advancements or challenges involved in approaching problems related to the Navier-Stokes existence and smoothness conjecture through methods like PINNs (Physics-Informed Neural Networks), spectral methods, or other advanced numerical techniques.
                    The answers should be comprehensive and use appropriate scientific and mathematical terminology, including LaTeX for equations where beneficial.
                `;
                this.showAiInterpretation(prompt, true);
            }

            playConversationAudio() {
                const audio = this.elements.navierStokesAudio;
                const btn = this.elements.btnConversation;
                if (!audio) return;
                
                if (audio.paused) {
                    audio.play().catch(e => console.error("Audio play failed:", e));
                    btn.innerHTML = `Pause Conversation`;
                } else {
                    audio.pause();
                    btn.innerHTML = `Conversation`;
                }
                audio.onended = () => { btn.innerHTML = `Conversation`; };
            }

            showDetailedResults() {
                if (!this.simulator || !this.hasSimulationData) {
                    this.elements.detailedResultsContent.innerHTML = '<p class="text-gray-500 text-center py-8">Run a simulation to see results here.</p>';
                    return;
                }

                const finalState = this.simulator.snapshots[this.simulator.snapshots.length - 1];
                const timeSteps = this.simulator.timeSteps;
                const snapshots = this.simulator.snapshots;
                const xLabels = this.simulator.x.map(val => val.toFixed(2));
                const metrics = this.simulator.analyzeResults(finalState);

                this.elements.detailedResultsContent.innerHTML = `
                    <div id="finalStateWrapper" class="bg-gray-100 rounded-md border border-gray-300 p-2 mb-4 relative">
                        <canvas id="finalStateChartCanvas" class="w-full h-64"></canvas>
                    </div>
                    <div id="timeEvolutionWrapper" class="bg-gray-100 rounded-md border border-gray-300 p-2 mb-4 relative">
                        <canvas id="timeEvolutionChartCanvas" class="w-full h-64"></canvas>
                    </div>
                    <div id="analysisContent" class="p-4">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Final State Metrics:</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><p>Max Value ($u_{max}$): <span class="font-mono">${metrics.max_value.toFixed(4)}</span></p></div>
                            <div><p>Min Value ($u_{min}$): <span class="font-mono">${metrics.min_value.toFixed(4)}</span></p></div>
                            <div><p>Mean Value ($\\overline{u}$): <span class="font-mono">${metrics.mean_value.toFixed(4)}</span></p></div>
                            <div><p>Standard Deviation ($\\sigma_u$): <span class="font-mono">${metrics.std_dev.toFixed(4)}</span></p></div>
                            <div class="col-span-full"><p>Energy ($\\mathcal{E}$): <span class="font-mono">${metrics.energy.toFixed(4)}</span></p></div>
                        </div>
                    </div>
                `;
                
                if (window.MathJax?.typesetPromise) window.MathJax.typesetPromise([this.elements.detailedResultsContent]);

                if (this.finalStateChart) this.finalStateChart.destroy();
                if (this.timeEvolutionChart) this.timeEvolutionChart.destroy();

                const finalStateCtx = document.getElementById('finalStateChartCanvas')?.getContext('2d');
                if (finalStateCtx) {
                    this.finalStateChart = new Chart(finalStateCtx, {
                        type: 'line', data: { labels: xLabels, datasets: [{ label: 'Final State u(x,T)', data: finalState, borderColor: 'rgb(75, 192, 192)', borderWidth: 2, pointRadius: 0, tension: 0.1 }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Position (x)' } }, y: { title: { display: true, text: 'u(x,T)' }, min: -0.2, max: 1.2 } }, plugins: { legend: { display: false }, title: { display: true, text: 'Final State' } } }
                    });
                }
                
                const timeEvoCtx = document.getElementById('timeEvolutionChartCanvas')?.getContext('2d');
                if (timeEvoCtx) {
                    const numSnapshotsToShow = Math.min(snapshots.length, 5);
                    const step = snapshots.length <= 1 ? 1 : Math.max(1, Math.floor((snapshots.length -1) / (numSnapshotsToShow - 1)));
                    const datasets = [];
                    for (let i = 0; i < numSnapshotsToShow; i++) {
                        const index = Math.min(i * step, snapshots.length - 1);
                        if(index < snapshots.length) {
                             datasets.push({
                                label: `t = ${timeSteps[index].toFixed(2)}`, data: snapshots[index], borderColor: `hsl(${i * (360 / numSnapshotsToShow)}, 70%, 50%)`, borderWidth: 2, pointRadius: 0, fill: false, tension: 0.1
                            });
                        }
                    }

                    this.timeEvolutionChart = new Chart(timeEvoCtx, {
                        type: 'line', data: { labels: xLabels, datasets },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Position (x)' } }, y: { title: { display: true, text: 'u(x,t)' }, beginAtZero: true } }, plugins: { legend: { display: true, position: 'bottom' }, title: { display: true, text: 'Time Evolution Snapshots' } } }
                    });
                }
                this.activateTab('finalState');
            }
        }

        let dashboardInstance;
        document.addEventListener('DOMContentLoaded', () => {
            dashboardInstance = new SimulationDashboard();
            dashboardInstance.activateTab(dashboardInstance.currentActiveTab);
            if (dashboardInstance.elements.mainContentArea) {
                dashboardInstance.elements.mainContentArea.addEventListener('mouseover', dashboardInstance._boundHandleTooltipShow);
                dashboardInstance.elements.mainContentArea.addEventListener('mouseout', dashboardInstance._boundHandleTooltipHide);
            }
        });

    </script>
</body>
</html>